# 02_æŠ€è¡“æ¶æ§‹èˆ‡è¼”åŠ©è¦ç¯„

> å½™æ•´æ–‡ä»¶ï¼šæŠ€è¡“æ¶æ§‹æ–‡ä»¶ã€æŠ€è¡“æ±ºç­–ç´€éŒ„ (ADR)ã€å°ˆæ¡ˆçµæ§‹èªªæ˜ã€æ¸¬è©¦ç­–ç•¥æ–‡ä»¶  
> æœ€å¾Œæ›´æ–°ï¼š2026-02-08

---

## ğŸ“– ç›®éŒ„

- [1. æ¶æ§‹æ¦‚è¦½](#1-æ¶æ§‹æ¦‚è¦½)
- [2. æŠ€è¡“æ£§è©³ç´°èªªæ˜](#2-æŠ€è¡“æ£§è©³ç´°èªªæ˜)
- [3. è³‡æ–™æµç¨‹](#3-è³‡æ–™æµç¨‹)
- [4. æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥](#4-æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥)
- [5. å®‰å…¨æ€§è¨­è¨ˆ](#5-å®‰å…¨æ€§è¨­è¨ˆ)
- [6. å®šæ™‚ä»»å‹™](#6-å®šæ™‚ä»»å‹™)
- [7. ç‰ˆæœ¬æ§åˆ¶èˆ‡ CI/CD](#7-ç‰ˆæœ¬æ§åˆ¶èˆ‡-cicd)
- [8. ç’°å¢ƒè®Šæ•¸](#8-ç’°å¢ƒè®Šæ•¸)
- [9. ç›£æ§èˆ‡æ—¥èªŒ](#9-ç›£æ§èˆ‡æ—¥èªŒ)
- [10. æŠ€è¡“æ±ºç­–ç´€éŒ„ (ADR)](#10-æŠ€è¡“æ±ºç­–ç´€éŒ„-adr)
- [11. å°ˆæ¡ˆçµæ§‹èªªæ˜](#11-å°ˆæ¡ˆçµæ§‹èªªæ˜)
- [12. æ¸¬è©¦ç­–ç•¥](#12-æ¸¬è©¦ç­–ç•¥)

---

## 1. æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä½¿ç”¨è€…                               â”‚
â”‚                    (ç€è¦½å™¨ / è¡Œå‹•è£ç½®)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel Edge Network                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚       SvelteKit App         â”‚                â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚
â”‚              â”‚  â”‚  Pages    â”‚ API Routesâ”‚  â”‚                â”‚
â”‚              â”‚  â”‚  (SSR)    â”‚ (Server)  â”‚  â”‚                â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Supabase                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚PostgreSQLâ”‚  â”‚   Auth   â”‚  â”‚ Storage  â”‚  â”‚ Realtime â”‚    â”‚
â”‚  â”‚ Database â”‚  â”‚(Google   â”‚  â”‚(æ†‘è­‰æª”æ¡ˆ) â”‚  â”‚(å³æ™‚æ¨é€)â”‚    â”‚
â”‚  â”‚          â”‚  â”‚ OAuth)   â”‚  â”‚          â”‚  â”‚          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚      Edge Functions         â”‚                â”‚
â”‚              â”‚  (Email é€šçŸ¥ã€èƒŒæ™¯ä»»å‹™)      â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Google Workspace                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚              â”‚      SMTP (Email ç™¼é€)       â”‚                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æŠ€è¡“æ£§è©³ç´°èªªæ˜

### 2.1 å‰ç«¯ / å…¨ç«¯æ¡†æ¶ï¼šSvelteKit

| é …ç›® | èªªæ˜ |
|-----|------|
| **æ¡†æ¶ç‰ˆæœ¬** | SvelteKit 2.x |
| **èªè¨€** | TypeScript |
| **æ¨£å¼** | Tailwind CSS |
| **UI å…ƒä»¶åº«** | shadcn-svelte |
| **ç‰¹æ€§** | ç·¨è­¯å‹æ¡†æ¶ï¼Œç„¡ Virtual DOMï¼Œæ¥µè‡´æ•ˆèƒ½ |

**UI å…ƒä»¶åº« (shadcn-svelte)**ï¼š
- åŸºæ–¼ Tailwind CSS çš„å¯è¤‡è£½å…ƒä»¶åº«
- åŒ…å« Button, Input, Select, Table, Dialog, Toast ç­‰ 40+ å…ƒä»¶
- å…ƒä»¶è¤‡è£½åˆ°å°ˆæ¡ˆå…§ï¼Œå¯å®Œå…¨å®¢è£½åŒ–
- å®‰è£æ–¹å¼ï¼š`npx shadcn-svelte@latest init`

**é—œéµæŠ€è¡“å¯¦è¸**ï¼š
- **Link Prefetching**ï¼šæ»‘é¼ ç§»è‡³é€£çµæ™‚é è¼‰è³‡æ–™ï¼Œå¯¦ç¾ã€Œé›¶å»¶é²ã€å°èˆª
- **Optimistic UI**ï¼šå„²å­˜æ“ä½œå…ˆæ›´æ–°ç•«é¢ï¼Œä¸ç­‰ API å›æ‡‰
- **Server Actions**ï¼šå•†å‹™é‚è¼¯æ–¼ä¼ºæœå™¨ç«¯åŸ·è¡Œï¼Œå®‰å…¨ä¸”æ•ˆèƒ½ä½³
- **Form Actions**ï¼šåŸç”Ÿè¡¨å–®æäº¤ï¼Œç„¡éœ€é¡å¤–å‰ç«¯ç‹€æ…‹ç®¡ç†

### 2.2 åŸºç¤è¨­æ–½ï¼šSupabase

| æœå‹™ | ç”¨é€” | å‚™è¨» |
|-----|------|------|
| **PostgreSQL** | ä¸»è¦è³‡æ–™åº« | æ”¯æ´ JSONBã€åŸå­äº‹å‹™ |
| **Auth** | ä½¿ç”¨è€…èªè­‰ | Google OAuth 2.0 + ä¼æ¥­ç¶²åŸŸé™åˆ¶ |
| **Storage** | æ†‘è­‰æª”æ¡ˆå­˜æ”¾ | Signed URL å­˜å–æ§åˆ¶ |
| **Realtime** | å³æ™‚è³‡æ–™æ¨é€ | ç‹€æ…‹è®Šæ›´å³æ™‚é€šçŸ¥ |
| **Edge Functions** | èƒŒæ™¯ä»»å‹™ | Email ç™¼é€ã€æª”æ¡ˆæ¸…ç† |

### 2.3 éƒ¨ç½²å¹³å°ï¼šVercel

| é …ç›® | èªªæ˜ |
|-----|------|
| **éƒ¨ç½²æ–¹å¼** | GitHub ä¸»åˆ†æ”¯ Push è‡ªå‹•éƒ¨ç½² |
| **Edge Network** | å…¨çƒ CDN åŠ é€Ÿ |
| **Cron Jobs** | å®šæ™‚ä»»å‹™åŸ·è¡Œ (æ¯é€±æ¸…ç†å­¤ç«‹æª”æ¡ˆ) |
| **ç’°å¢ƒè®Šæ•¸** | Supabase URLã€API Keyã€SMTP è¨­å®š |

### 2.4 Email é€šçŸ¥ï¼šGoogle Workspace SMTP

| é …ç›® | èªªæ˜ |
|-----|------|
| **ç™¼é€å¸³è™Ÿ** | noreply@company.com |
| **æ¯æ—¥é™é¡** | 2,000 å° (Workspace å¸³è™Ÿ) |
| **è§¸ç™¼æ–¹å¼** | Supabase Edge Functions å‘¼å« |

### 2.5 æ¸¬è©¦æ¶æ§‹ (Testing Stack)

| æœå‹™ | ç”¨é€” | å‚™è¨» |
|-----|------|------|
| **Vitest** | å–®å…ƒæ¸¬è©¦ (Unit Test) | é‡å°å·¥å…·å‡½æ•¸èˆ‡ Svelte çµ„ä»¶é‚è¼¯ |
| **Playwright** | ç«¯å°ç«¯æ¸¬è©¦ (E2E) | æ¨¡æ“¬ç€è¦½å™¨è¡Œç‚ºã€é©—è­‰é—œéµæµç¨‹ |
| **jsdom** | ç€è¦½å™¨ç’°å¢ƒæ¨¡æ“¬ | ä¾› Vitest åœ¨ Node.js ä¸­åŸ·è¡Œç¶²é é‚è¼¯ |

---

## 3. è³‡æ–™æµç¨‹

### 3.1 ä½¿ç”¨è€…èªè­‰æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant A as SvelteKit App
    participant S as Supabase Auth
    participant G as Google OAuth

    U->>A: é»æ“Šã€Œç™»å…¥ã€
    A->>S: ç™¼èµ· OAuth è«‹æ±‚
    S->>G: é‡å°å‘è‡³ Google
    G->>U: é¡¯ç¤ºç™»å…¥é é¢
    U->>G: è¼¸å…¥å¸³å¯†
    G->>S: å›å‚³æˆæ¬Šç¢¼
    S->>S: é©—è­‰ä¼æ¥­ç¶²åŸŸ
    S->>A: å›å‚³ Session Token
    A->>U: ç™»å…¥æˆåŠŸï¼Œå°å‘é¦–é 
```

### 3.2 è«‹æ¬¾å–®æäº¤æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”³è«‹äºº
    participant A as SvelteKit App
    participant D as PostgreSQL
    participant N as Edge Function
    participant M as ä¸»ç®¡

    U->>A: å¡«å¯«è«‹æ¬¾å–®
    A->>D: å„²å­˜è‰ç¨¿
    U->>A: é»æ“Šã€Œæäº¤ã€
    A->>A: é©—è­‰ (æ ¸å‡†äººã€å¸³è™Ÿ)
    A->>D: æ›´æ–°ç‹€æ…‹ç‚ºã€Œä¸»ç®¡å¯©æ ¸ã€
    A->>N: è§¸ç™¼é€šçŸ¥
    N->>M: ç™¼é€ Email
    A->>U: é¡¯ç¤ºã€Œå·²æäº¤ã€
```

### 3.3 æ†‘è­‰ä¸Šå‚³æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant A as SvelteKit App
    participant S as Supabase Storage
    participant D as PostgreSQL

    U->>A: é¸æ“‡æª”æ¡ˆ
    A->>A: é©—è­‰æ ¼å¼ (PDF/JPG/PNG)
    A->>A: é©—è­‰å¤§å° (< 10MB)
    A->>S: ä¸Šå‚³æª”æ¡ˆè‡³ /claims/{id}/attachments/
    S->>A: å›å‚³æª”æ¡ˆè·¯å¾‘
    A->>D: æ›´æ–° attachment_id, attachment_url
    A->>U: é¡¯ç¤ºä¸Šå‚³æˆåŠŸ
```

---

## 4. æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥

| ç­–ç•¥ | å¯¦ä½œæ–¹å¼ | é æœŸæ•ˆæœ |
|-----|---------|---------| 
| **é é¢é è¼‰** | SvelteKit Link Prefetching | å°èˆª < 100ms |
| **æ¨‚è§€æ›´æ–°** | Optimistic UI Pattern | å„²å­˜æ„Ÿè¦ºå³æ™‚ |
| **é€£ç·šæ± ** | Supabase ç®¡ç† | ç„¡å†·å•Ÿå‹•å»¶é² |
| **åœ–ç‰‡å„ªåŒ–** | æ†‘è­‰å£“ç¸® + WebP | è¼‰å…¥æ›´å¿« |
| **å¿«å–ç­–ç•¥** | Vercel Edge Cache | éœæ…‹è³‡æºæ¥µé€Ÿ |

---

## 5. å®‰å…¨æ€§è¨­è¨ˆ

### 5.1 èªè­‰èˆ‡æˆæ¬Š

| å±¤ç´š | æ©Ÿåˆ¶ |
|-----|------|
| **èªè­‰** | Supabase Auth + Google OAuth 2.0 |
| **ä¼æ¥­é™åˆ¶** | åƒ…å…è¨± @company.com ç¶²åŸŸ |
| **Session** | Supabase ç®¡ç†ï¼ŒéæœŸè‡ªå‹•ç™»å‡º |
| **RBAC** | è§’è‰²æ¬Šé™æ§åˆ¶ (ç”³è«‹äºº/ä¸»ç®¡/è²¡å‹™/ç®¡ç†å“¡) |

### 5.2 è³‡æ–™å®‰å…¨

| é …ç›® | æ©Ÿåˆ¶ |
|-----|------|
| **å‚³è¼¸åŠ å¯†** | HTTPS (Vercel è‡ªå‹•) |
| **éœæ…‹åŠ å¯†** | PostgreSQL æ¬„ä½åŠ å¯† (éŠ€è¡Œå¸³è™Ÿã€èº«åˆ†è­‰) |
| **æª”æ¡ˆå­˜å–** | Supabase Signed URL (æœ‰æ™‚æ•ˆ) |
| **RLS** | Row Level Security (åƒ…å­˜å–è‡ªå·±çš„è³‡æ–™) |

---

## 6. å®šæ™‚ä»»å‹™

| ä»»å‹™ | æ’ç¨‹ | åŸ·è¡Œæ–¹å¼ |
|-----|------|---------| 
| **æ¸…ç†å­¤ç«‹æ†‘è­‰** | æ¯é€±æ—¥ 03:00 | Vercel Cron â†’ API Route â†’ Supabase |

**vercel.json è¨­å®šç¯„ä¾‹**ï¼š
```json
{
  "crons": [
    {
      "path": "/api/cron/cleanup-orphan-files",
      "schedule": "0 3 * * 0"
    }
  ]
}
```

---

## 7. ç‰ˆæœ¬æ§åˆ¶èˆ‡ CI/CD

| é …ç›® | å·¥å…· | èªªæ˜ |
|-----|------|------|
| **ç¨‹å¼ç¢¼è¨—ç®¡** | GitHub | ä¸»åˆ†æ”¯ä¿è­·ï¼Œéœ€ PR Review |
| **è‡ªå‹•éƒ¨ç½²** | Vercel | Push å¾Œè‡ªå‹•å»ºç½®éƒ¨ç½² |
| **ç’°å¢ƒåˆ†é›¢** | Vercel Preview | PR å»ºç«‹æ™‚è‡ªå‹•ç”¢ç”Ÿé è¦½ç’°å¢ƒ |

**åˆ†æ”¯ç­–ç•¥**ï¼š
```
main (ç”Ÿç”¢ç’°å¢ƒ)
  â””â”€â”€ develop (é–‹ç™¼ç’°å¢ƒ)
       â””â”€â”€ feature/* (åŠŸèƒ½åˆ†æ”¯)
```

---

## 8. ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸åç¨± | èªªæ˜ | ç¯„ä¾‹ |
|---------|------|------| 
| `PUBLIC_SUPABASE_URL` | Supabase å°ˆæ¡ˆ URL | https://xxx.supabase.co |
| `PUBLIC_SUPABASE_ANON_KEY` | Supabase å…¬é–‹é‡‘é‘° | eyJhbGciOiJIUzI1NiIs... |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase æœå‹™é‡‘é‘° (Server ç«¯) | eyJhbGciOiJIUzI1NiIs... |
| `SMTP_HOST` | SMTP ä¸»æ©Ÿ | smtp.gmail.com |
| `SMTP_USER` | SMTP å¸³è™Ÿ | noreply@company.com |
| `SMTP_PASS` | SMTP App Password | xxxx-xxxx-xxxx-xxxx |

---

## 9. ç›£æ§èˆ‡æ—¥èªŒ

| é …ç›® | å·¥å…· | èªªæ˜ |
|-----|------|------|
| **æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ** | Vercel Logs | å³æ™‚æŸ¥çœ‹ API éŒ¯èª¤ |
| **è³‡æ–™åº«ç›£æ§** | Supabase Dashboard | æŸ¥è©¢æ•ˆèƒ½ã€é€£ç·šæ•¸ |
| **éŒ¯èª¤è¿½è¹¤** | (å»ºè­°) Sentry | å‰ç«¯éŒ¯èª¤æ•æ‰ (å¯é¸) |

---

## 10. æŠ€è¡“æ±ºç­–ç´€éŒ„ (ADR)

é€™ä»½æ–‡ä»¶è¨˜éŒ„äº†æœ¬å°ˆæ¡ˆæ‰€æœ‰çš„é—œéµæŠ€è¡“æ±ºç­–ï¼Œå¹«åŠ©æœªä¾†ç¹¼æ¥è€…ç†è§£ã€Œç‚ºä»€éº¼ã€é¸ç”¨é€™äº›å·¥å…·ã€‚

### [ADR-001] æ¸¬è©¦æ¡†æ¶é¸æ“‡ (Vitest & Playwright)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šå°ˆæ¡ˆéœ€è¦å–®å…ƒæ¸¬è©¦èˆ‡ç«¯å°ç«¯æ¸¬è©¦ä»¥ä¿è­‰è³ªé‡ã€‚
* **æ±ºç­–**ï¼š
  - å–®å…ƒæ¸¬è©¦é¸ç”¨ **Vitest**ï¼šèˆ‡ SvelteKit çš„ Vite åº•å±¤å®Œç¾æ•´åˆï¼Œé€Ÿåº¦æ¥µå¿«ã€‚
  - ç«¯å°ç«¯æ¸¬è©¦é¸ç”¨ **Playwright**ï¼šæ¯” Cypress æ›´ç©©å®šã€å¤šç€è¦½å™¨æ”¯æ´æ›´å¥½ä¸”é…ç½®ç°¡å–®ã€‚
* **å½±éŸ¿**ï¼šæ–°å¢äº† `vitest.config.ts` èˆ‡ `playwright.config.ts`ã€‚

### [ADR-002] èªè­‰èˆ‡æˆæ¬Š (Supabase Auth & RLS)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šç³»çµ±éœ€è¦è™•ç†æ•æ„Ÿçš„å¸³å‹™èˆ‡å“¡å·¥è³‡æ–™ã€‚
* **æ±ºç­–**ï¼š
  - ä½¿ç”¨ **Supabase SSR**ï¼šç¢ºä¿ Server-side æ¸²æŸ“æ™‚ä¹Ÿèƒ½ç²å¾—èº«åˆ†ã€‚
  - å¼·åˆ¶å•Ÿç”¨ **Row Level Security (RLS)**ï¼šåœ¨è³‡æ–™åº«å±¤ç´šä¿è­·éš±ç§ï¼Œè€Œéåƒ…ä¾è³´å¾Œç«¯ APIã€‚
  - **Profiles åˆ†é›¢**ï¼šå°‡å“¡å·¥è©³ç´°è³‡è¨Šå­˜æ–¼ `public.profiles`ï¼Œä¸ç›´æ¥ä¿®æ”¹ `auth.users`ï¼Œä»¥ç¬¦åˆå®‰å…¨å¯¦å‹™ã€‚
  - **ç°¡åŒ–æ¶æ§‹ (ç§»é™¤éƒ¨é–€)**ï¼šæ ¹æ“šä½¿ç”¨è€…å›é¥‹ (2026-02-08)ï¼Œç³»çµ±ç§»é™¤ `departments` å±¤ç´šï¼Œç°¡åŒ–ç‚ºä»¥å€‹äººç‚ºæ ¸å¿ƒçš„å ±éŠ·æµç¨‹ã€‚
* **å½±éŸ¿**ï¼šæ‰€æœ‰æŸ¥è©¢å¿…é ˆè€ƒæ…® RLS æ”¿ç­–ï¼Œä¸”æ‰€æœ‰é€£å‹•æ¬„ä½ (dept_id) å·²å…¨æ•¸ç§»é™¤ï¼ŒRLS ç°¡åŒ–ç‚ºåƒ…é©—è­‰ä½¿ç”¨è€…å€‹äººæ¬Šé™ã€‚

### [ADR-004] UI å…ƒä»¶åº«é¸æ“‡ (Shadcn UI)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šéœ€è¦å¿«é€Ÿå»ºç«‹å°ˆæ¥­ã€ä¸€è‡´ä¸”é«˜åº¦å¯è‡ªè¨‚çš„ UI ä»‹é¢ã€‚
* **æ±ºç­–**ï¼šé¸ç”¨ **shadcn-svelte**ã€‚
* **ç†ç”±**ï¼š
  - éå¥—ä»¶å®‰è£ï¼Œä»£ç¢¼ç›´æ¥è¤‡è£½åˆ°å°ˆæ¡ˆï¼Œéˆæ´»åº¦æœ€é«˜ã€‚
  - åŸºæ–¼ Tailwind CSS v4ï¼Œç¬¦åˆæœ€æ–°å‰ç«¯æŠ€è¡“è¶¨å‹¢ã€‚
* **å½±éŸ¿**ï¼šæ–°å¢ `src/lib/components/ui/` ç›®éŒ„èˆ‡ `components.json`ã€‚

### [ADR-005] è‡ªå‹•åŒ–åŸºç¤è¨­æ–½åˆå§‹åŒ– (Storage Bucket è…³æœ¬)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šæ‰‹å‹•åœ¨ Supabase Console å»ºç«‹ Bucket å®¹æ˜“éºæ¼è¨­å®šï¼ˆå¦‚æ¬Šé™ã€æª”æ¡ˆé™åˆ¶ï¼‰ã€‚
* **æ±ºç­–**ï¼šå»ºç«‹ **`init-supabase.ts`** è‡ªå‹•åŒ–è…³æœ¬ã€‚
* **ç†ç”±**ï¼š
  - ç¢ºä¿é–‹ç™¼ã€æ¸¬è©¦èˆ‡ç”Ÿç”¢ç’°å¢ƒçš„ Bucket è¨­å®šå®Œå…¨ä¸€è‡´ã€‚
  - å¯ç¨‹å¼åŒ–æ§åˆ¶æª”æ¡ˆå¤§å°é™åˆ¶èˆ‡ MIME é¡å‹ã€‚
* **å½±éŸ¿**ï¼šé–‹ç™¼æµç¨‹ä¸­éœ€åŸ·è¡Œä¸€æ¬¡æ­¤è…³æœ¬ã€‚

### [ADR-006] èªè­‰å°å‘ç­–ç•¥ (Redirect URIs)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šGoogle OAuth éœ€è¦æ˜ç¢ºçš„ Redirect URI ä»¥é˜²æ­¢å®‰å…¨æ€§æ”»æ“Šã€‚
* **æ±ºç­–**ï¼šçµ±ä¸€ä½¿ç”¨ `/auth/callback` ä½œç‚ºä¿¡è™Ÿäº¤æ›ç«¯é»ã€‚
* **ç†ç”±**ï¼š
  - é›†ä¸­è™•ç† Code æ› Session çš„é‚è¼¯ã€‚
  - ç°¡åŒ– Google Cloud Console çš„é…ç½®æ¸…å–®ã€‚
* **å½±éŸ¿**ï¼šæ‰€æœ‰ OAuth è«‹æ±‚å¿…é ˆæ”œå¸¶æ­£ç¢ºçš„ `redirectTo` åƒæ•¸ã€‚

### æŠ€è¡“æ±ºç­–è¨˜éŒ„ (é™„éŒ„)

| æ±ºç­– | é¸æ“‡ | ç†ç”± |
|-----|------|------|
| å…¨ç«¯æ¡†æ¶ | SvelteKit (é Next.js) | ç·¨è­¯å‹æ•ˆèƒ½ä½³ã€è¡¨å–®æ“ä½œæµæš¢ |
| å¾Œç«¯æ¶æ§‹ | ç´” SvelteKit (é Go) | æ¸›å°‘ç¶­é‹è¤‡é›œåº¦ã€å…§éƒ¨ç³»çµ±æµé‡å¯æ§ |
| Email æœå‹™ | Google SMTP (é SendGrid) | å·²æœ‰ Workspaceã€å…è²»ã€é«˜é€é”ç‡ |
| å®šæ™‚ä»»å‹™ | Vercel Cron (é pg_cron) | è¨­å®šç°¡å–®ã€èˆ‡éƒ¨ç½²æ•´åˆ |

---

## 11. å°ˆæ¡ˆçµæ§‹èªªæ˜

> é€™ä»½æ–‡ä»¶èªªæ˜å°ˆæ¡ˆä¸­æ¯å€‹æª”æ¡ˆå’Œè³‡æ–™å¤¾çš„ç”¨é€”ï¼Œå¹«åŠ©ä½ å¿«é€Ÿç†è§£ SvelteKit å°ˆæ¡ˆçµæ§‹ã€‚

### 11.1 æ ¹ç›®éŒ„çµæ§‹

```
å ±éŠ·_new/
â”œâ”€â”€ ğŸ“ src/                    â† ğŸ”´ ä½ çš„ç¨‹å¼ç¢¼éƒ½åœ¨é€™è£¡
â”œâ”€â”€ ğŸ“ static/                 â† éœæ…‹æª”æ¡ˆ (åœ–ç‰‡ã€favicon)
â”œâ”€â”€ ğŸ“ node_modules/           â† npm å¥—ä»¶ (ä¸ç”¨ç®¡)
â”œâ”€â”€ ğŸ“ .svelte-kit/            â† ç·¨è­¯å¿«å– (ä¸ç”¨ç®¡)
â”œâ”€â”€ ğŸ“ åƒè€ƒæ–‡ä»¶/                â† è¨­è¨ˆæ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“ tests/                  â† ğŸ§ª E2E æ¸¬è©¦è…³æœ¬
â”‚
â”œâ”€â”€ ğŸ“„ package.json            â† â­ å°ˆæ¡ˆè¨­å®šæª”
â”œâ”€â”€ ğŸ“„ svelte.config.js        â† SvelteKit è¨­å®š
â”œâ”€â”€ ğŸ“„ vite.config.ts          â† Vite æ‰“åŒ…å·¥å…·è¨­å®š
â”œâ”€â”€ ğŸ“„ vitest.config.ts        â† ğŸ§ª å–®å…ƒæ¸¬è©¦è¨­å®š
â”œâ”€â”€ ğŸ“„ playwright.config.ts    â† ğŸ§ª E2E æ¸¬è©¦è¨­å®š
â”œâ”€â”€ ğŸ“„ tsconfig.json           â† TypeScript è¨­å®š
â”œâ”€â”€ ğŸ“„ components.json         â† shadcn-svelte è¨­å®š
â”‚
â”œâ”€â”€ ğŸ“„ .env.example            â† ç’°å¢ƒè®Šæ•¸ç¯„æœ¬
â”œâ”€â”€ ğŸ“„ .gitignore              â† Git å¿½ç•¥æ¸…å–®
â””â”€â”€ ğŸ“„ README.md               â† å°ˆæ¡ˆèªªæ˜
```

### 11.2 src/ (æ ¸å¿ƒç¨‹å¼ç¢¼)

```
src/
â”œâ”€â”€ ğŸ“„ app.html                â† HTML æ¨¡æ¿ (é€šå¸¸ä¸éœ€æ”¹)
â”œâ”€â”€ ğŸ“„ app.css                 â† å…¨åŸŸ CSS æ¨£å¼ (å«è‰²å½©è®Šæ•¸å®šç¾©)
â”œâ”€â”€ ğŸ“„ app.d.ts                â† â­ TypeScript å‹åˆ¥å®šç¾© (å®šç¾©å…¨åŸŸè³‡æ–™æ ¼å¼)
â”œâ”€â”€ ğŸ“„ hooks.server.ts         â† â­ ä¼ºæœå™¨æ””æˆªå™¨ (æª¢æŸ¥ç™»å…¥ã€æ¬Šé™)
â”‚
â”œâ”€â”€ ğŸ“ routes/                 â† â­ é é¢å’Œè·¯ç”±
â”‚   â”œâ”€â”€ ğŸ“„ +page.svelte        â† é¦–é  (/)
â”‚   â”œâ”€â”€ ğŸ“„ +layout.svelte      â† å…±ç”¨ç‰ˆé¢ (æ‰€æœ‰é é¢éƒ½æœƒç”¨ï¼Œå« Sidebar)
â”‚   â”œâ”€â”€ ğŸ“„ +layout.server.ts   â† â­ è¼‰å…¥ç‰ˆé¢è³‡æ–™èˆ‡è·¯ç”±ä¿è­· (RBAC)
â”‚   â”œâ”€â”€ ğŸ“ auth/               â† ğŸ”‘ èªè­‰ç›¸é—œè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ +page.svelte    â† Google ç™»å…¥é é¢
â”‚   â”‚   â””â”€â”€ ğŸ“ callback/       â† OAuth å›å‚³è™•ç†
â”‚   â”‚       â””â”€â”€ ğŸ“„ +server.ts  â† è™•ç†ç™»å…¥æˆåŠŸå¾Œçš„ä»£ç¢¼äº¤æ›
â”‚
â””â”€â”€ ğŸ“ lib/                    â† â­ å…±ç”¨ç¨‹å¼ç¢¼åº«
    â”œâ”€â”€ ğŸ“ components/         â† æ‰€æœ‰ UI å…ƒä»¶
    â”‚   â”œâ”€â”€ ğŸ“ ui/             â† shadcn-svelte åŸºç¤å…ƒä»¶ (16 å€‹)
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ button/     â† Button æŒ‰éˆ•å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ input/      â† Input è¼¸å…¥æ¡†å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ select/     â† Select é¸å–®å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ textarea/   â† Textarea å¤šè¡Œè¼¸å…¥å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ card/       â† Card å¡ç‰‡å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ badge/      â† Badge æ¨™ç±¤å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ dialog/     â† Dialog å°è©±æ¡†å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ sonner/     â† Toast é€šçŸ¥å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ table/      â† Table è¡¨æ ¼å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ label/      â† Label æ¨™ç±¤å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ separator/  â† Separator åˆ†éš”ç·šå…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ scroll-area/ â† ScrollArea æ»¾å‹•å€åŸŸå…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ dropdown-menu/ â† DropdownMenu ä¸‹æ‹‰é¸å–®å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ avatar/     â† Avatar é ­åƒå…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“ tooltip/    â† Tooltip æç¤ºå…ƒä»¶
    â”‚   â”‚   â””â”€â”€ ğŸ“ popover/    â† Popover å½ˆå‡ºæ¡†å…ƒä»¶
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ“ layout/         â† ğŸ†• ä½ˆå±€å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Sidebar.svelte      â† å´é‚Šå°èˆª (å« RBAC éæ¿¾)
    â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Breadcrumb.svelte   â† éºµåŒ…å±‘å°èˆª
    â”‚   â”‚   â”œâ”€â”€ ğŸ“„ PageLayout.svelte   â† é é¢ä½ˆå±€åŒ…è£
    â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts            â† åŒ¯å‡ºå…¥å£
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸ“ shared/         â† ğŸ†• å…±ç”¨å…ƒä»¶
    â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Loading.svelte      â† è¼‰å…¥ä¸­ç‹€æ…‹
    â”‚   â”‚   â”œâ”€â”€ ğŸ“„ EmptyState.svelte   â† ç©ºç‹€æ…‹é¡¯ç¤º
    â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts            â† åŒ¯å‡ºå…¥å£
    â”‚   â”‚
    â”‚   â””â”€â”€ ğŸ“ claims/         â† ğŸ†• è«‹æ¬¾å°ˆç”¨å…ƒä»¶
    â”‚       â”œâ”€â”€ ğŸ“„ StatusBadge.svelte  â† è«‹æ¬¾ç‹€æ…‹æ¨™ç±¤ (9 ç¨®ç‹€æ…‹å°æ‡‰è‰²å½©)
    â”‚       â””â”€â”€ ğŸ“„ index.ts            â† åŒ¯å‡ºå…¥å£
    â”‚
    â”œâ”€â”€ ğŸ“ hooks/              â† è‡ªè¨‚é‚è¼¯ Hooks
    â”œâ”€â”€ ğŸ“ scripts/            â† ğŸ› ï¸ è‡ªå‹•åŒ–è…³æœ¬ (å¦‚ï¼š`init-supabase.ts`)
    â”œâ”€â”€ ğŸ“ assets/             â† è³‡æºæª”æ¡ˆ
    â”œâ”€â”€ ğŸ“„ index.ts            â† â­ lib é›†ä¸­åŒ¯å‡ºå…¥å£ (æ‰€æœ‰å¤–éƒ¨å¼•ç”¨æ‡‰é€éæ­¤æª”)
    â”œâ”€â”€ ğŸ“„ supabase.ts         â† â­ Supabase ç”¨æˆ¶ç«¯è¨­å®š
    â””â”€â”€ ğŸ“„ utils.ts            â† é€šç”¨å·¥å…·å‡½æ•¸ (å¦‚æ ¼å¼åŒ–ã€cn())
```

### 11.3 tests/ (æ¸¬è©¦è…³æœ¬)

```
tests/
â”œâ”€â”€ ğŸ“„ auth.e2e.ts             â† èªè­‰æµç¨‹ E2E æ¸¬è©¦
â””â”€â”€ ğŸ“„ rls.spec.ts              â† â­ RLS å®‰å…¨æ€§é©—è­‰æ¸¬è©¦ (é©—è­‰è³‡æ–™éš”é›¢)
```

### 11.4 é‡è¦æª”æ¡ˆè©³è§£

#### `package.json` â­
**ç”¨é€”**ï¼šå°ˆæ¡ˆçš„ã€Œèº«åˆ†è­‰ã€ï¼Œè¨˜éŒ„ï¼š
- å°ˆæ¡ˆåç¨±ã€ç‰ˆæœ¬
- ä½¿ç”¨çš„å¥—ä»¶ (dependencies)
- å¯åŸ·è¡Œçš„æŒ‡ä»¤ (scripts)

**å¸¸ç”¨æŒ‡ä»¤**ï¼š
```bash
npm run dev      # å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
npm run build    # æ‰“åŒ…æˆæ­£å¼ç‰ˆ
npm run preview  # é è¦½æ­£å¼ç‰ˆ
```

#### `src/routes/+page.svelte`
**ç”¨é€”**ï¼šé¦–é å…§å®¹

**è¦å‰‡**ï¼š
- `routes/` è³‡æ–™å¤¾çµæ§‹ = ç¶²å€çµæ§‹
- `+page.svelte` = é é¢å…§å®¹
- `+layout.svelte` = å…±ç”¨ç‰ˆé¢

**ç¯„ä¾‹**ï¼š
```
src/routes/
â”œâ”€â”€ +page.svelte              â†’ /
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ +page.svelte          â†’ /auth (Google ç™»å…¥)
â”œâ”€â”€ claims/
â”‚   â”œâ”€â”€ +page.svelte          â†’ /claims
â”‚   â””â”€â”€ [id]/
â”‚       â””â”€â”€ +page.svelte      â†’ /claims/123 (å‹•æ…‹è·¯ç”±)
```

#### `src/routes/+layout.svelte`
**ç”¨é€”**ï¼šæ‰€æœ‰é é¢å…±ç”¨çš„å¤–æ¡†ï¼ˆå¦‚å°è¦½åˆ—ã€é å°¾ï¼‰

**ç¯„ä¾‹**ï¼š
```svelte
<script lang="ts">
  import "../app.css";
  import { page } from "$app/state"; // Svelte 5 æ–°èªæ³•
  let { data, children } = $props(); // Svelte 5 Snippets
</script>

{#if data.session}
  <Sidebar user={data.user} />
  <main>
    {@render children()}
  </main>
{:else}
  {@render children()}
{/if}
```

#### `src/lib/` (ç”¨ `$lib` å¼•å…¥)
**ç”¨é€”**ï¼šå­˜æ”¾å¯é‡è¤‡ä½¿ç”¨çš„ç¨‹å¼ç¢¼

**å¼•å…¥æ–¹å¼**ï¼š
```svelte
<script>
  // âŒ ä¸è¦é€™æ¨£å¯«
  import Button from '../../../lib/components/ui/button';
  
  // âœ… ç”¨ $lib åˆ¥å
  import { Button } from '$lib/components/ui/button';
</script>
```

#### `src/hooks.server.ts` â­
**ç”¨é€”**ï¼šä¼ºæœå™¨ç«¯çš„ã€Œç®¡ç†å“¡ã€ã€‚
- æ¯ç•¶æœ‰é é¢è«‹æ±‚æ™‚éƒ½æœƒå…ˆç¶“éé€™è£¡ã€‚
- ç”¨ä¾†æª¢æŸ¥ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹ã€ä¿è­·å¾Œå°è·¯ç”±ã€‚

#### `src/lib/supabase.ts` â­
**ç”¨é€”**ï¼šè¨­å®š SvelteKit èˆ‡ Supabase çš„é€£ç·šå·¥å» ã€‚
- å»ºç«‹é€£ç·šç”¨çš„ Client ç‰©ä»¶ã€‚
- è™•ç† Cookie èˆ‡ Session (ç™»å…¥ç‹€æ…‹) çš„åŒæ­¥ã€‚

#### `src/lib/scripts/init-supabase.ts` ğŸ› ï¸
**ç”¨é€”**ï¼šç’°å¢ƒåˆå§‹åŒ–è…³æœ¬ã€‚
- è‡ªå‹•å»ºç«‹å°ˆæ¡ˆæ‰€éœ€çš„ Storage Buckets (å¦‚ï¼šreceipts)ã€‚
- ä½¿ç”¨ Service Role Key åŸ·è¡Œé«˜æ¬Šé™æ“ä½œã€‚

#### `src/routes/auth/callback/+server.ts` ğŸ”‘
**ç”¨é€”**ï¼šOAuth é©—è­‰å›å‚³è™•ç†å™¨ã€‚
- æ¥æ”¶ Google ç™»å…¥æˆåŠŸå¾Œå›å‚³çš„ä»£ç¢¼ (code)ã€‚
- å°‡ä»£ç¢¼äº¤æ›æˆæ­£å¼çš„ä½¿ç”¨è€… Session ä¸¦å°å›é¦–é ã€‚

#### `.env` (åŠ `.env.example`)
**ç”¨é€”**ï¼šç’°å¢ƒè®Šæ•¸ï¼ˆå­˜æ”¾å¯†é‘°èˆ‡é€£ç·šè³‡è¨Šï¼‰

**ç›®å‰åŒ…å«**ï¼š
- `PUBLIC_SUPABASE_URL`: Supabase ç¶²å€
- `PUBLIC_SUPABASE_ANON_KEY`: å…¬é–‹é‡‘é‘°
- `SUPABASE_SERVICE_ROLE_KEY`: **æ©Ÿå¯†é‡‘é‘°** (ä¸å¯å¤–æµ)
- `PUBLIC_APP_ENV`: ç’°å¢ƒæ¨™è¨˜ (å¦‚ development)

**æ³¨æ„**ï¼š
- `.env` åŒ…å«çœŸå¯¦å¯†é‘°ï¼Œ**çµ•å°ä¸èƒ½ä¸Šå‚³ Git**ã€‚
- `.env.example` æ˜¯ä¹¾æ·¨çš„ç¯„æœ¬ï¼Œå¯ä»¥ä¸Šå‚³ã€‚

### 11.5 SvelteKit è·¯ç”±è¦å‰‡é€ŸæŸ¥

| æª”æ¡ˆåç¨± | ç”¨é€” |
|----------|------|
| `+page.svelte` | é é¢å…§å®¹ |
| `+page.ts` | é é¢è¼‰å…¥è³‡æ–™ (client) |
| `+page.server.ts` | é é¢è¼‰å…¥è³‡æ–™ (server only) |
| `+layout.svelte` | å…±ç”¨ç‰ˆé¢ |
| `+layout.ts` | ç‰ˆé¢è¼‰å…¥è³‡æ–™ |
| `+error.svelte` | éŒ¯èª¤é é¢ |
| `+server.ts` | API ç«¯é» |

### 11.6 é–‹ç™¼æ™‚å¸¸ç”¨è·¯å¾‘

| ä½ æƒ³åšä»€éº¼ | å»å“ªè£¡ |
|------------|--------|
| æ–°å¢é é¢ | `src/routes/` |
| ä¿®æ”¹å…±ç”¨ç‰ˆé¢ | `src/routes/+layout.svelte` |
| æ–°å¢/ä¿®æ”¹ UI å…ƒä»¶ | `src/lib/components/` |
| æ–°å¢å·¥å…·å‡½æ•¸ | `src/lib/utils.ts` |
| ä¿®æ”¹å…¨åŸŸæ¨£å¼ | `src/app.css` |
| è¨­å®šç’°å¢ƒè®Šæ•¸ | `.env` |

### 11.7 ä¸éœ€è¦ç®¡çš„è³‡æ–™å¤¾

| è³‡æ–™å¤¾ | èªªæ˜ |
|--------|------|
| `node_modules/` | npm å¥—ä»¶ï¼Œè‡ªå‹•ç”Ÿæˆ |
| `.svelte-kit/` | ç·¨è­¯å¿«å–ï¼Œè‡ªå‹•ç”Ÿæˆ |
| `.git/` | Git ç‰ˆæœ¬æ§åˆ¶è³‡æ–™ |

---

## 12. æ¸¬è©¦ç­–ç•¥

### 12.1 æ¸¬è©¦æ¶æ§‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ¸¬è©¦é‡‘å­—å¡”                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                        â”‚   E2E   â”‚  â† Playwright (é—œéµæµç¨‹)     â”‚
â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                      â”‚  æ•´åˆæ¸¬è©¦   â”‚  â† Vitest (API + DB)       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                 â”‚       å–®å…ƒæ¸¬è©¦         â”‚  â† Vitest (å‡½æ•¸)      â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚  åº•å±¤æ¸¬è©¦å¤šã€å¿«é€ŸåŸ·è¡Œ â†’ ä¸Šå±¤æ¸¬è©¦å°‘ã€é©—è­‰å®Œæ•´æµç¨‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 æ¸¬è©¦å·¥å…·é¸æ“‡

| å±¤ç´š | å·¥å…· | ç”¨é€” |
|------|------|------|
| **å–®å…ƒæ¸¬è©¦** | Vitest | æ¸¬è©¦å·¥å…·å‡½æ•¸ã€è¨ˆç®—é‚è¼¯ |
| **æ•´åˆæ¸¬è©¦** | Vitest + Supertest | æ¸¬è©¦ API ç«¯é» |
| **ç«¯å°ç«¯æ¸¬è©¦** | Playwright | æ¨¡æ“¬ä½¿ç”¨è€…æ“ä½œç€è¦½å™¨ |
| **è¦†è“‹ç‡å ±å‘Š** | c8 (å…§å»º) | è¨ˆç®—ç¨‹å¼ç¢¼è¦†è“‹ç‡ |

### 12.3 è¨­å®šæª”ç¯„ä¾‹

#### å®‰è£ä¾è³´
```bash
npm install -D vitest @testing-library/svelte jsdom playwright @playwright/test
```

#### vitest.config.ts
```typescript
import { defineConfig } from 'vitest/config';
import { sveltekit } from '@sveltejs/kit/vite';

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    include: ['src/**/*.{test,spec}.{js,ts}'],
    environment: 'jsdom',
    globals: true,
    coverage: {
      reporter: ['text', 'html'],
      exclude: ['node_modules/', 'tests/']
    }
  }
});
```

#### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

#### package.json scripts
```json
{
  "scripts": {
    "test:unit": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```

### 12.4 æ¸¬è©¦æ¡ˆä¾‹è¦åŠƒ

#### å–®å…ƒæ¸¬è©¦ (Vitest)

| æ¨¡çµ„ | æ¸¬è©¦é …ç›® | å„ªå…ˆç´š |
|------|----------|:------:|
| **é‡‘é¡è¨ˆç®—** | `calculateTotal()` æ­£ç¢ºåŠ ç¸½ | é«˜ |
| **é‡‘é¡è¨ˆç®—** | è™•ç†ç©ºé™£åˆ— | é«˜ |
| **é‡‘é¡è¨ˆç®—** | è™•ç†è² æ•¸ï¼ˆæ‡‰æ‹’çµ•ï¼‰ | é«˜ |
| **ç™¼ç¥¨é©—è­‰** | `validateInvoiceNumber()` æ ¼å¼æ­£ç¢º | é«˜ |
| **ç™¼ç¥¨é©—è­‰** | æ ¼å¼éŒ¯èª¤å›å‚³ false | é«˜ |
| **ç‹€æ…‹æ©Ÿ** | `getNextStatus()` è½‰æ›æ­£ç¢º | é«˜ |
| **ç‹€æ…‹æ©Ÿ** | éæ³•è½‰æ›æ‹‹å‡ºéŒ¯èª¤ | ä¸­ |

**ç¯„ä¾‹**ï¼š
```typescript
// src/lib/utils/calculate.test.ts
import { describe, it, expect } from 'vitest';
import { calculateTotal } from './calculate';

describe('calculateTotal', () => {
  it('should sum all amounts correctly', () => {
    expect(calculateTotal([100, 200, 300])).toBe(600);
  });

  it('should return 0 for empty array', () => {
    expect(calculateTotal([])).toBe(0);
  });

  it('should throw error for negative amounts', () => {
    expect(() => calculateTotal([-100])).toThrow();
  });
});
```

#### ç«¯å°ç«¯æ¸¬è©¦ (Playwright)

| æµç¨‹ | æ¸¬è©¦é …ç›® | å„ªå…ˆç´š |
|------|----------|:------:|
| **ç™»å…¥** | Google OAuth ç™»å…¥æˆåŠŸ | é«˜ |
| **ç™»å…¥** | æœªç™»å…¥å°å‘ç™»å…¥é  | é«˜ |
| **è«‹æ¬¾** | æ–°å¢å“¡å·¥å ±éŠ· â†’ å„²å­˜è‰ç¨¿ | é«˜ |
| **è«‹æ¬¾** | æ–°å¢å» å•†è«‹æ¬¾ â†’ æäº¤ | é«˜ |
| **å¯©æ ¸** | ä¸»ç®¡æ ¸å‡†æµç¨‹ | é«˜ |
| **å¯©æ ¸** | è²¡å‹™é§å›æµç¨‹ | ä¸­ |
| **ä»˜æ¬¾** | å–®ç­†ä»˜æ¬¾å®Œæˆ | é«˜ |
| **ä»˜æ¬¾** | æ‰¹æ¬¡ä»˜æ¬¾ | ä¸­ |

**ç¯„ä¾‹**ï¼š
```typescript
// tests/claims.spec.ts
import { test, expect } from '@playwright/test';

test.describe('è«‹æ¬¾å–®æµç¨‹', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å…¥ï¼ˆä½¿ç”¨æ¸¬è©¦å¸³è™Ÿï¼‰
    await page.goto('/auth/login');
    // ... ç™»å…¥é‚è¼¯
  });

  test('æ–°å¢å“¡å·¥å ±éŠ·ä¸¦å„²å­˜è‰ç¨¿', async ({ page }) => {
    await page.goto('/claims/new?type=employee');
    
    // å¡«å¯«è¡¨å–®
    await page.fill('[data-testid="description"]', 'æ¸¬è©¦å ±éŠ·');
    await page.fill('[data-testid="item-amount-0"]', '1000');
    await page.selectOption('[data-testid="item-category-0"]', 'äº¤é€šè²»');
    
    // å„²å­˜è‰ç¨¿
    await page.click('[data-testid="save-draft"]');
    
    // é©—è­‰
    await expect(page.locator('.toast-success')).toBeVisible();
    await expect(page).toHaveURL(/\/claims\/[a-z0-9-]+/);
  });

  test('æäº¤è«‹æ¬¾å–®éœ€è¦æ ¸å‡†äºº', async ({ page }) => {
    await page.goto('/claims/new?type=employee');
    
    // å¡«å¯«ä¸¦æäº¤
    await page.fill('[data-testid="description"]', 'æ¸¬è©¦');
    await page.fill('[data-testid="item-amount-0"]', '500');
    await page.click('[data-testid="submit"]');
    
    // æ‡‰è©²çœ‹åˆ°éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœæ²’è¨­å®šæ ¸å‡†äººï¼‰
    await expect(page.locator('.error-message')).toContainText('æ ¸å‡†äºº');
  });
});
```

### 12.5 æ¸¬è©¦åŸ·è¡Œç­–ç•¥

#### é–‹ç™¼æ™‚
```bash
# ç›£è½æ¨¡å¼ï¼Œä¿®æ”¹å¾Œè‡ªå‹•åŸ·è¡Œ
npm run test:unit
```

#### æäº¤å‰
```bash
# åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦ (åƒ…åŸ·è¡Œä¸€æ¬¡)
npm run test:run

# åŸ·è¡Œ E2E æ¸¬è©¦
npm run test:e2e
```

#### CI/CD (GitHub Actions)
```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      
      - name: Run unit tests
        run: npm run test:run
      
      - name: Run E2E tests
        run: npx playwright install && npm run test:e2e
```

### 12.6 è¦†è“‹ç‡ç›®æ¨™

| å±¤ç´š | ç›®æ¨™è¦†è“‹ç‡ | èªªæ˜ |
|------|:----------:|------|
| å–®å…ƒæ¸¬è©¦ | 80% | æ ¸å¿ƒé‚è¼¯å¿…é ˆè¦†è“‹ |
| æ•´åˆæ¸¬è©¦ | 60% | API ä¸»è¦è·¯å¾‘ |
| E2E æ¸¬è©¦ | - | è¦†è“‹æ ¸å¿ƒä½¿ç”¨è€…æµç¨‹ |

### 12.7 å›æ­¸æ¸¬è©¦æ¸…å–®

æ¯æ¬¡ç™¼å¸ƒå‰ï¼Œç¢ºèªä»¥ä¸‹æ ¸å¿ƒæµç¨‹æ­£å¸¸ï¼š

#### èªè­‰
- [ ] Google ç™»å…¥æˆåŠŸ
- [ ] ç™»å‡ºå¾Œå°å‘ç™»å…¥é 

#### è«‹æ¬¾
- [ ] æ–°å¢å“¡å·¥å ±éŠ·
- [ ] æ–°å¢å» å•†è«‹æ¬¾
- [ ] æ–°å¢å€‹äººå‹å‹™
- [ ] å„²å­˜è‰ç¨¿
- [ ] æäº¤è«‹æ¬¾å–®
- [ ] ä¸Šå‚³æ†‘è­‰

#### å¯©æ ¸
- [ ] ä¸»ç®¡æ ¸å‡†
- [ ] ä¸»ç®¡é§å›
- [ ] è²¡å‹™æ ¸å‡†
- [ ] è²¡å‹™é§å›

#### ä»˜æ¬¾
- [ ] å–®ç­†ä»˜æ¬¾
- [ ] æ‰¹æ¬¡ä»˜æ¬¾
- [ ] å–æ¶ˆä»˜æ¬¾

---

> ğŸ“š å¦‚æœ‰ç–‘å•ï¼Œå¯ä»¥æŸ¥é–± [SvelteKit å®˜æ–¹æ–‡ä»¶](https://kit.svelte.dev/docs)

> ğŸ’¡ **ä½¿ç”¨æ–¹å¼**ï¼šå°ˆæ¡ˆåˆå§‹åŒ–æ™‚ï¼Œä¾ç…§æœ¬æ–‡ä»¶è¨­å®šæ¸¬è©¦ç’°å¢ƒã€‚é–‹ç™¼æ–°åŠŸèƒ½æ™‚ï¼ŒåŒæ­¥æ’°å¯«å°æ‡‰çš„æ¸¬è©¦æ¡ˆä¾‹ã€‚
