# 02_æŠ€è¡“æ¶æ§‹èˆ‡è¼”åŠ©è¦ç¯„

> å½™æ•´æ–‡ä»¶ï¼šæŠ€è¡“æ¶æ§‹æ–‡ä»¶ã€æŠ€è¡“æ±ºç­–ç´€éŒ„ (ADR)ã€å°ˆæ¡ˆçµæ§‹èªªæ˜ã€æ¸¬è©¦ç­–ç•¥æ–‡ä»¶  
> æœ€å¾Œæ›´æ–°ï¼š2026-02-11

---

## ğŸ“– ç›®éŒ„

- [1. æ¶æ§‹æ¦‚è¦½](#1-æ¶æ§‹æ¦‚è¦½)
- [2. æŠ€è¡“æ£§è©³ç´°èªªæ˜](#2-æŠ€è¡“æ£§è©³ç´°èªªæ˜)
- [3. è³‡æ–™æµç¨‹](#3-è³‡æ–™æµç¨‹)
- [4. æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥](#4-æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥)
- [5. å®‰å…¨æ€§è¨­è¨ˆ](#5-å®‰å…¨æ€§è¨­è¨ˆ)
- [6. å®šæ™‚ä»»å‹™](#6-å®šæ™‚ä»»å‹™)
- [7. ç‰ˆæœ¬æ§åˆ¶èˆ‡ CI/CD](#7-ç‰ˆæœ¬æ§åˆ¶èˆ‡-cicd)
- [8. ç’°å¢ƒè®Šæ•¸](#8-ç’°å¢ƒè®Šæ•¸)
- [9. ç›£æ§èˆ‡æ—¥èªŒ](#9-ç›£æ§èˆ‡æ—¥èªŒ)
- [10. æŠ€è¡“æ±ºç­–ç´€éŒ„ (ADR)](#10-æŠ€è¡“æ±ºç­–ç´€éŒ„-adr)
- [11. å°ˆæ¡ˆçµæ§‹èªªæ˜](#11-å°ˆæ¡ˆçµæ§‹èªªæ˜)
- [12. æ¸¬è©¦ç­–ç•¥](#12-æ¸¬è©¦ç­–ç•¥)

---

## 1. æ¶æ§‹æ¦‚è¦½

```mermaid
%%{init: { 'flowchart': { 'nodeSpacing': 70, 'rankSpacing': 100 }, 'themeVariables': { 'fontSize': '28px', 'fontFamily': 'arial' } } }%%
graph TD
    User([ä½¿ç”¨è€…<br/>ç€è¦½å™¨ / è¡Œå‹•è£ç½®]):::userStyle

    subgraph Vercel [Vercel Edge Network]
        direction TB
        SK_App[SvelteKit App]:::appStyle
        subgraph SK_Details [æ ¸å¿ƒé‚è¼¯]
            direction LR
            Pages[Pages / SSR]
            API[API Routes / Server]
        end
        SK_App --- SK_Details
    end

    subgraph Supabase [Supabase Cloud Services]
        direction TB
        Auth[Auth / Google OAuth]:::serviceStyle
        DB[(PostgreSQL Database)]:::serviceStyle
        Storage[Storage / æ†‘è­‰æª”æ¡ˆ]:::serviceStyle
        Realtime[Realtime / å³æ™‚æ¨é€]:::serviceStyle
        Functions[Edge Functions / èƒŒæ™¯ä»»å‹™]:::serviceStyle
    end

    subgraph External [å¤–éƒ¨æœå‹™]
        SMTP[Google Workspace / SMTP]:::externalStyle
    end

    %% é€£ç·šé—œä¿‚
    User <--> Vercel
    Vercel <--> Auth
    Vercel <--> DB
    Vercel <--> Storage
    Vercel <--> Realtime
    Vercel --> Functions
    Functions --> SMTP

    %% æ¨£å¼ç¾åŒ– (å°ˆæ¥­å–®è‰²èª¿é¢¨æ ¼)
    classDef userStyle fill:#ffffff,stroke:#333,stroke-width:2px;
    classDef appStyle fill:#334155,stroke:#fff,color:#fff,font-weight:bold;
    classDef serviceStyle fill:#f8fafc,stroke:#64748b,color:#1e293b;
    classDef externalStyle fill:#f1f5f9,stroke:#94a3b8,color:#334155,stroke-dasharray: 5 5;
    
    style Vercel fill:none,stroke:#475569,stroke-width:2px,stroke-dasharray: 5 5
    style Supabase fill:#f8fafc,stroke:#94a3b8,stroke-width:1px
    style External fill:none,stroke:#cbd5e1,stroke-dasharray: 2 2
```

---

## 2. æŠ€è¡“æ£§è©³ç´°èªªæ˜

### 2.1 å‰ç«¯ / å…¨ç«¯æ¡†æ¶ï¼šSvelteKit

| é …ç›® | èªªæ˜ |
|-----|------|
| **æ¡†æ¶ç‰ˆæœ¬** | SvelteKit 2.x |
| **èªè¨€** | TypeScript |
| **æ¨£å¼** | Tailwind CSS |
| **UI å…ƒä»¶åº«** | shadcn-svelte |
| **ç‰¹æ€§** | ç·¨è­¯å‹æ¡†æ¶ï¼Œç„¡ Virtual DOMï¼Œæ¥µè‡´æ•ˆèƒ½ |

**UI å…ƒä»¶åº« (shadcn-svelte)**ï¼š
- åŸºæ–¼ Tailwind CSS çš„å¯è¤‡è£½å…ƒä»¶åº«
- åŒ…å« Button, Input, Select, Table, Dialog, Toast ç­‰ 40+ å…ƒä»¶
- å…ƒä»¶è¤‡è£½åˆ°å°ˆæ¡ˆå…§ï¼Œå¯å®Œå…¨å®¢è£½åŒ–
- å®‰è£æ–¹å¼ï¼š`npx shadcn-svelte@latest init`

**é—œéµæŠ€è¡“å¯¦è¸**ï¼š
- **Link Prefetching**ï¼šæ»‘é¼ ç§»è‡³é€£çµæ™‚é è¼‰è³‡æ–™ï¼Œå¯¦ç¾ã€Œé›¶å»¶é²ã€å°èˆª
- **Optimistic UI**ï¼šå„²å­˜æ“ä½œå…ˆæ›´æ–°ç•«é¢ï¼Œä¸ç­‰ API å›æ‡‰
- **Server Actions**ï¼šå•†å‹™é‚è¼¯æ–¼ä¼ºæœå™¨ç«¯åŸ·è¡Œï¼Œå®‰å…¨ä¸”æ•ˆèƒ½ä½³
- **Form Actions**ï¼šåŸç”Ÿè¡¨å–®æäº¤ï¼Œç„¡éœ€é¡å¤–å‰ç«¯ç‹€æ…‹ç®¡ç†

### 2.2 åŸºç¤è¨­æ–½ï¼šSupabase

| æœå‹™ | ç”¨é€” | å‚™è¨» |
|-----|------|------|
| **PostgreSQL** | ä¸»è¦è³‡æ–™åº« | æ”¯æ´ JSONBã€åŸå­äº‹å‹™ |
| **Auth** | ä½¿ç”¨è€…èªè­‰ | Google OAuth 2.0 + ä¼æ¥­ç¶²åŸŸé™åˆ¶ |
| **Storage** | æ†‘è­‰æª”æ¡ˆå­˜æ”¾ | Signed URL å­˜å–æ§åˆ¶ |
| **Realtime** | å³æ™‚è³‡æ–™æ¨é€ | ç‹€æ…‹è®Šæ›´å³æ™‚é€šçŸ¥ |
| **Edge Functions** | èƒŒæ™¯ä»»å‹™ | Email ç™¼é€ã€æª”æ¡ˆæ¸…ç† |

### 2.3 éƒ¨ç½²å¹³å°ï¼šVercel

| é …ç›® | èªªæ˜ |
|-----|------|
| **éƒ¨ç½²æ–¹å¼** | GitHub ä¸»åˆ†æ”¯ Push è‡ªå‹•éƒ¨ç½² |
| **Edge Network** | å…¨çƒ CDN åŠ é€Ÿ |
| **Cron Jobs** | å®šæ™‚ä»»å‹™åŸ·è¡Œ (æ¯é€±æ¸…ç†å­¤ç«‹æª”æ¡ˆ) |
| **ç’°å¢ƒè®Šæ•¸** | Supabase URLã€API Keyã€SMTP è¨­å®š |

### 2.4 Email é€šçŸ¥ï¼šGoogle Workspace SMTP

| é …ç›® | èªªæ˜ |
|-----|------|
| **ç™¼é€å¸³è™Ÿ** | noreply@company.com |
| **æ¯æ—¥é™é¡** | 2,000 å° (Workspace å¸³è™Ÿ) |
| **è§¸ç™¼æ–¹å¼** | Supabase Edge Functions å‘¼å« |

### 2.5 æ¸¬è©¦æ¶æ§‹ (Testing Stack)

| æœå‹™ | ç”¨é€” | å‚™è¨» |
|-----|------|------|
| **Vitest** | å–®å…ƒæ¸¬è©¦ (Unit Test) | é‡å°å·¥å…·å‡½æ•¸èˆ‡ Svelte çµ„ä»¶é‚è¼¯ |
| **Playwright** | ç«¯å°ç«¯æ¸¬è©¦ (E2E) | æ¨¡æ“¬ç€è¦½å™¨è¡Œç‚ºã€é©—è­‰é—œéµæµç¨‹ |
| **jsdom** | ç€è¦½å™¨ç’°å¢ƒæ¨¡æ“¬ | ä¾› Vitest åœ¨ Node.js ä¸­åŸ·è¡Œç¶²é é‚è¼¯ |

---

## 3. è³‡æ–™æµç¨‹

### 3.1 ä½¿ç”¨è€…èªè­‰æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant A as SvelteKit App
    participant S as Supabase Auth
    participant G as Google OAuth

    U->>A: é»æ“Šã€Œç™»å…¥ã€
    A->>S: ç™¼èµ· OAuth è«‹æ±‚
    S->>G: é‡å°å‘è‡³ Google
    G->>U: é¡¯ç¤ºç™»å…¥é é¢
    U->>G: è¼¸å…¥å¸³å¯†
    G->>S: å›å‚³æˆæ¬Šç¢¼
    S->>S: é©—è­‰ä¼æ¥­ç¶²åŸŸ
    S->>A: å›å‚³ Session Token
    A->>U: ç™»å…¥æˆåŠŸï¼Œå°å‘é¦–é 
```

### 3.2 è«‹æ¬¾å–®æäº¤æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”³è«‹äºº
    participant A as SvelteKit App
    participant D as PostgreSQL
    participant N as Edge Function
    participant M as ä¸»ç®¡

    U->>A: å¡«å¯«è«‹æ¬¾å–®
    A->>D: å„²å­˜è‰ç¨¿
    U->>A: é»æ“Šã€Œæäº¤ã€
    A->>A: é©—è­‰ (æ ¸å‡†äººã€å¸³è™Ÿ)
    A->>D: æ›´æ–°ç‹€æ…‹ç‚ºã€Œä¸»ç®¡å¯©æ ¸ã€
    A->>N: è§¸ç™¼é€šçŸ¥
    N->>M: ç™¼é€ Email
    A->>U: é¡¯ç¤ºã€Œå·²æäº¤ã€
```

### 3.3 æ†‘è­‰ä¸Šå‚³æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä½¿ç”¨è€…
    participant A as SvelteKit App
    participant S as Supabase Storage
    participant D as PostgreSQL

    U->>A: é¸æ“‡æª”æ¡ˆ
    A->>A: é©—è­‰æ ¼å¼ (PDF/JPG/PNG)
    A->>A: é©—è­‰å¤§å° (< 10MB)
    A->>S: ä¸Šå‚³æª”æ¡ˆè‡³ /claims/{id}/attachments/
    S->>A: å›å‚³æª”æ¡ˆè·¯å¾‘
    A->>D: æ›´æ–° attachment_id, attachment_url
    A->>U: é¡¯ç¤ºä¸Šå‚³æˆåŠŸ

### 3.4 æ”¶æ¬¾äººç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant U as ä¸€èˆ¬ä½¿ç”¨è€…
    participant F as è²¡å‹™äººå“¡
    participant A as SvelteKit App
    participant D as PostgreSQL (RPC)

    U->>A: æäº¤æ–°å¢/ä¿®æ”¹å—æ¬¾äºº
    A->>D: å‘¼å« submit_payee_change_request (åŠ å¯†æ•æ„Ÿè³‡æ–™)
    D->>D: å„²å­˜è‡³ payee_change_requests (status: pending)
    A->>U: é¡¯ç¤ºã€Œå¯©æ ¸ä¸­ã€
    
    F->>A: æŸ¥çœ‹å¾…å¯©æ ¸æ¸…å–®
    F->>A: æ ¸å‡†ç”³è«‹
    A->>D: å‘¼å« approve_payee_change_request
    D->>D: è§£å¯†è³‡æ–™ -> å¯«å…¥ payees è¡¨ -> æ›´æ–° request status
    A->>F: é¡¯ç¤ºã€Œå·²æ ¸å‡†ã€
```
```

---

## 4. æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥

| ç­–ç•¥ | å¯¦ä½œæ–¹å¼ | ç›®å‰ç‹€æ…‹ |
|-----|---------|---------|
| **é é¢é è¼‰** | `app.html` å…¨åŸŸ preload + Sidebar ä¸»è¦é€£çµ prefetch | âœ… å·²ä¸Šç·š |
| **æ¨‚è§€æ›´æ–°** | Admin Users æ¬Šé™ç®¡ç†æ¡ optimistic update + rollback | âœ… å·²ä¸Šç·š |
| **åœ–ç‰‡å„ªåŒ–** | å‰ç«¯å£“ç¸® helperï¼ˆæ”¶æ¬¾äººé™„ä»¶ + è«‹æ¬¾æ†‘è­‰ï¼‰ | âœ… å·²ä¸Šç·š |
| **API éŸ¿æ‡‰è§€æ¸¬** | `hooks.server.ts` æ³¨å…¥ `x-response-time`ã€`server-timing`ï¼›client `timedFetch` ç´€éŒ„è€—æ™‚ | âœ… å·²ä¸Šç·š |
| **é€£ç·šæ± ** | Supabase ç®¡ç† | âœ… æŒçºŒä½¿ç”¨ |
| **å¿«å–ç­–ç•¥** | Vercel Edge / éœæ…‹è³‡æºå¿«å– | âœ… æŒçºŒä½¿ç”¨ |

---

## 5. å®‰å…¨æ€§è¨­è¨ˆ

### 5.1 èªè­‰èˆ‡æˆæ¬Š

| å±¤ç´š | æ©Ÿåˆ¶ |
|-----|------|
| **èªè­‰** | Supabase Auth + Google OAuth 2.0 |
| **ä¼æ¥­é™åˆ¶** | åƒ…å…è¨± @company.com ç¶²åŸŸ |
| **Session** | Supabase ç®¡ç†ï¼ŒéæœŸè‡ªå‹•ç™»å‡º |
| **RBAC** | è§’è‰²æ¬Šé™æ§åˆ¶ (ç”³è«‹äºº/ä¸»ç®¡/è²¡å‹™/ç®¡ç†å“¡) |

### 5.2 è³‡æ–™å®‰å…¨

| é …ç›® | æ©Ÿåˆ¶ |
|-----|------|
| **å‚³è¼¸åŠ å¯†** | HTTPS (Vercel è‡ªå‹•) |
| **AES-256 åŠ å¯†** | éŠ€è¡Œå¸³è™Ÿç¶“ PGP å°ç¨±åŠ å¯†å„²å­˜ï¼Œé‡‘é‘°éš”é›¢æ–¼ `system_config` |
| **å®‰å…¨ RPC** | ä½¿ç”¨ `SECURITY DEFINER` å‡½æ•¸å¯¦ä½œæ¬Šé™æª¢æŸ¥ (æœ¬äºº/ç®¡ç†å“¡) |
| **RLS** | Row Level Security (åƒ…å­˜å–è‡ªå·±çš„è³‡æ–™) |
| **OAuth Redirect å®‰å…¨** | `auth/callback` åƒ…æ¥å—å…§éƒ¨ç›¸å°è·¯å¾‘ (`/xxx`)ï¼Œæ‹’çµ• `//` èˆ‡å¤–éƒ¨å°å‘ |
| **Storage æ¬Šé™å¼·åŒ–** | `payees` bucket åƒ…å…è¨±æª”æ¡ˆ owner æˆ–è²¡å‹™/ç®¡ç†å“¡è®€å¯«/åˆªé™¤ |
| **pgcrypto ç›¸å®¹å±¤** | `public.pgp_sym_encrypt/decrypt` wrapper è½‰å‘¼å« `extensions.pgp_sym_*`ï¼Œé¿å… `search_path` é™åˆ¶é€ æˆ RPC å¤±æ•ˆ |

---

## 6. å®šæ™‚ä»»å‹™

| ä»»å‹™ | æ’ç¨‹ | åŸ·è¡Œæ–¹å¼ |
|-----|------|---------| 
| **æ¸…ç†å­¤ç«‹æ†‘è­‰** | æ¯é€±æ—¥ 03:00 | Vercel Cron â†’ API Route â†’ Supabase |

**vercel.json è¨­å®šç¯„ä¾‹**ï¼š
```json
{
  "crons": [
    {
      "path": "/api/cron/cleanup-orphan-files",
      "schedule": "0 3 * * 0"
    }
  ]
}
```

---

## 7. ç‰ˆæœ¬æ§åˆ¶èˆ‡ CI/CD

| é …ç›® | å·¥å…· | èªªæ˜ |
|-----|------|------|
| **ç¨‹å¼ç¢¼è¨—ç®¡** | GitHub | ä¸»åˆ†æ”¯ä¿è­·ï¼Œéœ€ PR Review |
| **è‡ªå‹•éƒ¨ç½²** | Vercel | Push å¾Œè‡ªå‹•å»ºç½®éƒ¨ç½² |
| **ç’°å¢ƒåˆ†é›¢** | Vercel Preview | PR å»ºç«‹æ™‚è‡ªå‹•ç”¢ç”Ÿé è¦½ç’°å¢ƒ |

**åˆ†æ”¯ç­–ç•¥**ï¼š
```
main (ç”Ÿç”¢ç’°å¢ƒ)
  â””â”€â”€ develop (é–‹ç™¼ç’°å¢ƒ)
       â””â”€â”€ feature/* (åŠŸèƒ½åˆ†æ”¯)
```

---

## 8. ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸åç¨± | èªªæ˜ | ç¯„ä¾‹ |
|---------|------|------| 
| `PUBLIC_SUPABASE_URL` | Supabase å°ˆæ¡ˆ URL | https://xxx.supabase.co |
| `PUBLIC_SUPABASE_ANON_KEY` | Supabase å…¬é–‹é‡‘é‘° | eyJhbGciOiJIUzI1NiIs... |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase æœå‹™é‡‘é‘° (Server ç«¯) | eyJhbGciOiJIUzI1NiIs... |
| `SMTP_HOST` | SMTP ä¸»æ©Ÿ | smtp.gmail.com |
| `SMTP_USER` | SMTP å¸³è™Ÿ | noreply@company.com |
| `SMTP_PASS` | SMTP App Password | xxxx-xxxx-xxxx-xxxx |

---

## 9. ç›£æ§èˆ‡æ—¥èªŒ

| é …ç›® | å·¥å…· | èªªæ˜ |
|-----|------|------|
| **æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ** | Vercel Logs | å³æ™‚æŸ¥çœ‹ API éŒ¯èª¤ |
| **è³‡æ–™åº«ç›£æ§** | Supabase Dashboard | æŸ¥è©¢æ•ˆèƒ½ã€é€£ç·šæ•¸ |
| **éŒ¯èª¤è¿½è¹¤** | (å»ºè­°) Sentry | å‰ç«¯éŒ¯èª¤æ•æ‰ (å¯é¸) |

---

## 10. æŠ€è¡“æ±ºç­–ç´€éŒ„ (ADR)

é€™ä»½æ–‡ä»¶è¨˜éŒ„äº†æœ¬å°ˆæ¡ˆæ‰€æœ‰çš„é—œéµæŠ€è¡“æ±ºç­–ï¼Œå¹«åŠ©æœªä¾†ç¹¼æ¥è€…ç†è§£ã€Œç‚ºä»€éº¼ã€é¸ç”¨é€™äº›å·¥å…·ã€‚

### [ADR-001] æ¸¬è©¦æ¡†æ¶é¸æ“‡ (Vitest & Playwright)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šå°ˆæ¡ˆéœ€è¦å–®å…ƒæ¸¬è©¦èˆ‡ç«¯å°ç«¯æ¸¬è©¦ä»¥ä¿è­‰è³ªé‡ã€‚
* **æ±ºç­–**ï¼š
  - å–®å…ƒæ¸¬è©¦é¸ç”¨ **Vitest**ï¼šèˆ‡ SvelteKit çš„ Vite åº•å±¤å®Œç¾æ•´åˆï¼Œé€Ÿåº¦æ¥µå¿«ã€‚
  - ç«¯å°ç«¯æ¸¬è©¦é¸ç”¨ **Playwright**ï¼šæ¯” Cypress æ›´ç©©å®šã€å¤šç€è¦½å™¨æ”¯æ´æ›´å¥½ä¸”é…ç½®ç°¡å–®ã€‚
* **å½±éŸ¿**ï¼šæ–°å¢äº† `vitest.config.ts` èˆ‡ `playwright.config.ts`ã€‚

### [ADR-002] èªè­‰èˆ‡æˆæ¬Š (Supabase Auth & RLS)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šç³»çµ±éœ€è¦è™•ç†æ•æ„Ÿçš„å¸³å‹™èˆ‡å“¡å·¥è³‡æ–™ã€‚
* **æ±ºç­–**ï¼š
  - ä½¿ç”¨ **Supabase SSR**ï¼šç¢ºä¿ Server-side æ¸²æŸ“æ™‚ä¹Ÿèƒ½ç²å¾—èº«åˆ†ã€‚
  - å¼·åˆ¶å•Ÿç”¨ **Row Level Security (RLS)**ï¼šåœ¨è³‡æ–™åº«å±¤ç´šä¿è­·éš±ç§ï¼Œè€Œéåƒ…ä¾è³´å¾Œç«¯ APIã€‚
  - **Profiles åˆ†é›¢**ï¼šå°‡å“¡å·¥è©³ç´°è³‡è¨Šå­˜æ–¼ `public.profiles`ï¼Œä¸ç›´æ¥ä¿®æ”¹ `auth.users`ï¼Œä»¥ç¬¦åˆå®‰å…¨å¯¦å‹™ã€‚
  - **ç°¡åŒ–æ¶æ§‹ (ç§»é™¤éƒ¨é–€)**ï¼šæ ¹æ“šä½¿ç”¨è€…å›é¥‹ (2026-02-08)ï¼Œç³»çµ±ç§»é™¤ `departments` å±¤ç´šï¼Œç°¡åŒ–ç‚ºä»¥å€‹äººç‚ºæ ¸å¿ƒçš„å ±éŠ·æµç¨‹ã€‚
* **å½±éŸ¿**ï¼šæ‰€æœ‰æŸ¥è©¢å¿…é ˆè€ƒæ…® RLS æ”¿ç­–ï¼Œä¸”æ‰€æœ‰é€£å‹•æ¬„ä½ (dept_id) å·²å…¨æ•¸ç§»é™¤ï¼ŒRLS ç°¡åŒ–ç‚ºåƒ…é©—è­‰ä½¿ç”¨è€…å€‹äººæ¬Šé™ã€‚

### [ADR-004] UI å…ƒä»¶åº«é¸æ“‡ (Shadcn UI)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šéœ€è¦å¿«é€Ÿå»ºç«‹å°ˆæ¥­ã€ä¸€è‡´ä¸”é«˜åº¦å¯è‡ªè¨‚çš„ UI ä»‹é¢ã€‚
* **æ±ºç­–**ï¼šé¸ç”¨ **shadcn-svelte**ã€‚
* **ç†ç”±**ï¼š
  - éå¥—ä»¶å®‰è£ï¼Œä»£ç¢¼ç›´æ¥è¤‡è£½åˆ°å°ˆæ¡ˆï¼Œéˆæ´»åº¦æœ€é«˜ã€‚
  - åŸºæ–¼ Tailwind CSS v4ï¼Œç¬¦åˆæœ€æ–°å‰ç«¯æŠ€è¡“è¶¨å‹¢ã€‚
* **å½±éŸ¿**ï¼šæ–°å¢ `src/lib/components/ui/` ç›®éŒ„èˆ‡ `components.json`ã€‚

### [ADR-005] è‡ªå‹•åŒ–åŸºç¤è¨­æ–½åˆå§‹åŒ– (Storage Bucket è…³æœ¬)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šæ‰‹å‹•åœ¨ Supabase Console å»ºç«‹ Bucket å®¹æ˜“éºæ¼è¨­å®šï¼ˆå¦‚æ¬Šé™ã€æª”æ¡ˆé™åˆ¶ï¼‰ã€‚
* **æ±ºç­–**ï¼šå»ºç«‹ **`init-supabase.ts`** è‡ªå‹•åŒ–è…³æœ¬ã€‚
* **ç†ç”±**ï¼š
  - ç¢ºä¿é–‹ç™¼ã€æ¸¬è©¦èˆ‡ç”Ÿç”¢ç’°å¢ƒçš„ Bucket è¨­å®šå®Œå…¨ä¸€è‡´ã€‚
  - å¯ç¨‹å¼åŒ–æ§åˆ¶æª”æ¡ˆå¤§å°é™åˆ¶èˆ‡ MIME é¡å‹ã€‚
* **å½±éŸ¿**ï¼šé–‹ç™¼æµç¨‹ä¸­éœ€åŸ·è¡Œä¸€æ¬¡æ­¤è…³æœ¬ã€‚

### [ADR-006] èªè­‰å°å‘ç­–ç•¥ (Redirect URIs)

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-08)
* **èƒŒæ™¯**ï¼šGoogle OAuth éœ€è¦æ˜ç¢ºçš„ Redirect URI ä»¥é˜²æ­¢å®‰å…¨æ€§æ”»æ“Šã€‚
* **æ±ºç­–**ï¼šçµ±ä¸€ä½¿ç”¨ `/auth/callback` ä½œç‚ºä¿¡è™Ÿäº¤æ›ç«¯é»ã€‚
* **ç†ç”±**ï¼š
  - é›†ä¸­è™•ç† Code æ› Session çš„é‚è¼¯ã€‚
  - ç°¡åŒ– Google Cloud Console çš„é…ç½®æ¸…å–®ã€‚
* **å½±éŸ¿**ï¼šæ‰€æœ‰ OAuth è«‹æ±‚å¿…é ˆæ”œå¸¶æ­£ç¢ºçš„ `redirectTo` åƒæ•¸ã€‚

### [ADR-007] 2026-02 å®‰å…¨ç¡¬åŒ–èˆ‡ç›¸å®¹æ€§ä¿®è£œ

* **ç‹€æ…‹**ï¼šå·²æ¡ç´ (2026-02-11)
* **èƒŒæ™¯**ï¼š
  - OAuth callback è‹¥ç›´æ¥ä½¿ç”¨æœªéæ¿¾ `next` åƒæ•¸ï¼Œå­˜åœ¨ Open Redirect é¢¨éšªã€‚
  - Storage `payees` bucket æ—©æœŸç­–ç•¥éå¯¬ï¼Œå¯èƒ½è®“ä¸€èˆ¬ç™»å…¥è€…è®€å–ä¸æ‡‰è®€å–çš„é™„ä»¶ã€‚
  - å•Ÿç”¨ `SECURITY DEFINER + search_path=public` å¾Œï¼Œ`pgp_sym_encrypt/decrypt` å¯èƒ½æ‰¾ä¸åˆ° `extensions` schema å‡½æ•¸ã€‚
* **æ±ºç­–**ï¼š
  - callback åƒ…å…è¨±ç«™å…§å®‰å…¨ç›¸å°è·¯å¾‘ã€‚
  - å¼·åŒ– `payees` bucket policyï¼šé™åˆ¶ç‚º owner æˆ–è²¡å‹™/ç®¡ç†å“¡ã€‚
  - å»ºç«‹ `public.pgp_sym_encrypt/decrypt` wrapperï¼Œçµ±ä¸€è½‰å‘¼å« `extensions.pgp_sym_*`ã€‚
* **å½±éŸ¿**ï¼š
  - ç™»å…¥å°å‘æ›´å®‰å…¨ï¼Œä¸”ä¿ç•™ `next` å›è·³èƒ½åŠ›ã€‚
  - æ”¶æ¬¾äººé™„ä»¶éš±ç§é‚Šç•Œæ›´æ¸…æ¥šã€‚
  - æ—¢æœ‰ claims/payees åŠ å¯† RPC åœ¨ hardened `search_path` ä¸‹ç¶­æŒå¯ç”¨ã€‚

### æŠ€è¡“æ±ºç­–è¨˜éŒ„ (é™„éŒ„)

| æ±ºç­– | é¸æ“‡ | ç†ç”± |
|-----|------|------|
| å…¨ç«¯æ¡†æ¶ | SvelteKit (é Next.js) | ç·¨è­¯å‹æ•ˆèƒ½ä½³ã€è¡¨å–®æ“ä½œæµæš¢ |
| å¾Œç«¯æ¶æ§‹ | ç´” SvelteKit (é Go) | æ¸›å°‘ç¶­é‹è¤‡é›œåº¦ã€å…§éƒ¨ç³»çµ±æµé‡å¯æ§ |
| Email æœå‹™ | Google SMTP (é SendGrid) | å·²æœ‰ Workspaceã€å…è²»ã€é«˜é€é”ç‡ |
| å®šæ™‚ä»»å‹™ | Vercel Cron (é pg_cron) | è¨­å®šç°¡å–®ã€èˆ‡éƒ¨ç½²æ•´åˆ |

---

## 11. å°ˆæ¡ˆçµæ§‹èªªæ˜

> æ­¤ç« ç¯€å·²ä¾ç›®å‰å¯¦éš›æª”æ¡ˆæ¨¹æ›´æ–°ï¼Œæ¶µè“‹ `claims`ã€`payees`ã€`admin`ã€`auth`ã€`api`ã€`supabase/migrations` èˆ‡æ¸¬è©¦è…³æœ¬ã€‚

### 11.1 æ ¹ç›®éŒ„çµæ§‹ (ç•¶å‰)

```text
å ±éŠ·_new/
â”œâ”€â”€ src/                       # SvelteKit æ‡‰ç”¨ä¸»é«”
â”œâ”€â”€ static/                    # éœæ…‹è³‡æº
â”œâ”€â”€ tests/                     # Playwright / Vitest æ¸¬è©¦
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/            # DB schema / RPC / policy migration
â”‚   â””â”€â”€ .temp/                 # Supabase CLI æš«å­˜
â”œâ”€â”€ åƒè€ƒæ–‡ä»¶/                  # å°ˆæ¡ˆæ–‡ä»¶
â”œâ”€â”€ playwright-report/         # E2E å ±è¡¨è¼¸å‡ºï¼ˆæ¸¬è©¦ç”¢ç‰©ï¼Œå·² gitignoreï¼‰
â”œâ”€â”€ test-results/              # E2E åŸ·è¡Œç”¢ç‰©ï¼ˆå·² gitignoreï¼‰
â”œâ”€â”€ package.json
â”œâ”€â”€ playwright.config.ts
â”œâ”€â”€ vitest.config.ts
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ svelte.config.js
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### 11.2 `src/` çµæ§‹

```text
src/
â”œâ”€â”€ app.html
â”œâ”€â”€ app.css
â”œâ”€â”€ app.d.ts
â”œâ”€â”€ hooks.server.ts
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ supabase.ts
â”‚   â”œâ”€â”€ utils.ts
â”‚   â”œâ”€â”€ utils.test.ts
â”‚   â”œâ”€â”€ client/
â”‚   â”‚   â”œâ”€â”€ image-compression.ts
â”‚   â”‚   â””â”€â”€ timed-fetch.ts
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ storage-upload.ts
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â””â”€â”€ init-supabase.ts
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ favicon.svg
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ ui/                # shadcn-svelte åŸºç¤å…ƒä»¶
â”‚       â”œâ”€â”€ layout/            # Sidebar / UserAccountSheet / Breadcrumb...
â”‚       â”œâ”€â”€ claims/            # è«‹æ¬¾ç›¸é—œå±•ç¤ºå…ƒä»¶
â”‚       â””â”€â”€ shared/            # Loading / EmptyState ç­‰å…±ç”¨å…ƒä»¶
â””â”€â”€ routes/
    â”œâ”€â”€ +layout.server.ts
    â”œâ”€â”€ +layout.svelte
    â”œâ”€â”€ +page.server.ts
    â”œâ”€â”€ +page.svelte
    â”œâ”€â”€ account/
    â”‚   â””â”€â”€ +page.server.ts
    â”œâ”€â”€ admin/users/
    â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â””â”€â”€ +page.svelte
    â”œâ”€â”€ approval/
    â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â””â”€â”€ +page.svelte
    â”œâ”€â”€ auth/
    â”‚   â”œâ”€â”€ +page.svelte
    â”‚   â””â”€â”€ callback/+server.ts
    â”œâ”€â”€ claims/
    â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â”œâ”€â”€ +page.svelte
    â”‚   â”œâ”€â”€ new/
    â”‚   â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â”‚   â””â”€â”€ +page.svelte
    â”‚   â””â”€â”€ [id]/
    â”‚       â”œâ”€â”€ +page.server.ts
    â”‚       â”œâ”€â”€ +page.svelte
    â”‚       â””â”€â”€ edit/
    â”‚           â”œâ”€â”€ +page.server.ts
    â”‚           â””â”€â”€ +page.svelte
    â”œâ”€â”€ payees/
    â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â”œâ”€â”€ +page.svelte
    â”‚   â”œâ”€â”€ new/
    â”‚   â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â”‚   â””â”€â”€ +page.svelte
    â”‚   â””â”€â”€ [id]/edit/
    â”‚       â”œâ”€â”€ +page.server.ts
    â”‚       â””â”€â”€ +page.svelte
    â”œâ”€â”€ payments/
    â”‚   â”œâ”€â”€ +page.server.ts
    â”‚   â”œâ”€â”€ +page.svelte
    â”‚   â””â”€â”€ [id]/
    â”‚       â”œâ”€â”€ +page.server.ts
    â”‚       â””â”€â”€ +page.svelte
    â””â”€â”€ api/claims/attachment/[item_id]/+server.ts
```

### 11.3 `supabase/migrations/` (ç›®å‰ä¸»è¦æª”æ¡ˆ)

```text
supabase/migrations/
â”œâ”€â”€ 20260210123000_create_payee_rpcs.sql
â”œâ”€â”€ 20260210183000_fix_payee_rls.sql
â”œâ”€â”€ 20260211100000_add_claim_description.sql
â”œâ”€â”€ 20260211124839_secure_claims_module.sql
â”œâ”€â”€ 20260211125058_harden_function_search_path_and_system_config_rls_v2.sql
â”œâ”€â”€ 20260211130752_secure_payee_storage_policies.sql
â”œâ”€â”€ 20260211131710_ensure_pgcrypto_extension.sql
â”œâ”€â”€ 20260211131950_add_public_pgcrypto_wrappers.sql
â”œâ”€â”€ 20260211133403_fix_create_claim_type_cast.sql
â”œâ”€â”€ 20260211140049_allow_approver_read_subordinate_profiles.sql
â”œâ”€â”€ 20260211151000_allow_finance_read_profiles.sql
â”œâ”€â”€ 20260211160000_fix_attachment_upload.sql
â”œâ”€â”€ 20260211170000_add_payee_attachments.sql
â”œâ”€â”€ 20260211180000_drop_old_payee_rpc.sql
â”œâ”€â”€ 20260211190000_add_claim_floating_account.sql
â”œâ”€â”€ 20260211193000_create_claim_rpc.sql
â”œâ”€â”€ 20260211200000_get_claim_detail_rpc.sql
â””â”€â”€ 20260211201500_update_claim_rpc.sql
```

### 11.4 `tests/` çµæ§‹ (ç•¶å‰)

```text
tests/
â”œâ”€â”€ helpers.ts
â”œâ”€â”€ account_actions.spec.ts
â”œâ”€â”€ account_sheet.spec.ts
â”œâ”€â”€ admin_users.spec.ts
â”œâ”€â”€ approval_flow.spec.ts
â”œâ”€â”€ auth.spec.ts
â”œâ”€â”€ claim_creation.spec.ts
â”œâ”€â”€ claim_creation_variants.spec.ts
â”œâ”€â”€ claim_detail.spec.ts
â”œâ”€â”€ claim_state_machine.spec.ts
â”œâ”€â”€ claims_list_filters.spec.ts
â”œâ”€â”€ claims_submission_guards.spec.ts
â”œâ”€â”€ dashboard.spec.ts
â”œâ”€â”€ payee_flow.spec.ts
â”œâ”€â”€ payee_management.spec.ts
â”œâ”€â”€ payee_request_edges.spec.ts
â”œâ”€â”€ payee_rls.spec.ts
â”œâ”€â”€ payment_flow.spec.ts
â”œâ”€â”€ payment_guards.spec.ts
â”œâ”€â”€ rls.spec.ts
â””â”€â”€ verify_rpc.test.ts
```

### 11.5 é—œéµæª”æ¡ˆèªªæ˜

| æª”æ¡ˆ/è·¯å¾‘ | è§’è‰² |
|----------|------|
| `src/hooks.server.ts` | SSR èªè­‰ã€è·¯ç”±ä¿è­·ã€`locals.user` æ³¨å…¥ã€`x-response-time`/`server-timing` |
| `src/lib/supabase.ts` | Supabase SSR / Browser client åˆå§‹åŒ– |
| `src/lib/client/image-compression.ts` | å‰ç«¯åœ–ç‰‡å£“ç¸®å…±ç”¨å·¥å…· |
| `src/lib/client/timed-fetch.ts` | å‰ç«¯ API è€—æ™‚ç›£æ¸¬ wrapper |
| `src/lib/server/storage-upload.ts` | æª”æ¡ˆé©—è­‰èˆ‡ Storage ä¸Šå‚³å…±ç”¨å·¥å…· |
| `src/routes/auth/callback/+server.ts` | OAuth code exchange + å®‰å…¨ redirect éæ¿¾ |
| `src/routes/claims/new/+page.server.ts` | å»ºå–® actionï¼Œå‘¼å« `create_claim` RPC + æ˜ç´°å¯«å…¥ |
| `src/routes/claims/[id]/+page.server.ts` | è«‹æ¬¾è©³æƒ…/é™„ä»¶ action |
| `src/routes/payees/new/+page.server.ts` | å—æ¬¾äººæ–°å¢ç”³è«‹ + é™„ä»¶ä¸Šå‚³ |
| `src/routes/payees/[id]/edit/+page.server.ts` | å—æ¬¾äººæ›´æ–°ç”³è«‹ + æ¬Šé™åˆ¤æ–· |
| `src/routes/api/claims/attachment/[item_id]/+server.ts` | å—ä¿è­·é™„ä»¶ä¸‹è¼‰å…¥å£ |
| `supabase/migrations/*.sql` | DB schemaã€RLSã€RPC çš„å”¯ä¸€æ­·å²ä¾†æº |

### 11.6 è‡ªå‹•ç”¢ç”Ÿèˆ‡æ¸¬è©¦ç”¢ç‰©ç›®éŒ„

| è·¯å¾‘ | èªªæ˜ |
|------|------|
| `node_modules/` | å¥—ä»¶å®‰è£ç”¢ç‰© |
| `.svelte-kit/` | SvelteKit ç·¨è­¯ç”¢ç‰© |
| `playwright-report/` | Playwright HTML å ±è¡¨ |
| `test-results/` | Playwright åŸ·è¡Œçµæœèˆ‡éŒ¯èª¤ä¸Šä¸‹æ–‡ |

### 11.7 é–‹ç™¼ç¶­è­·å»ºè­°

- æ–‡ä»¶ä¸­çš„æª”æ¡ˆæ¸…å–®ä»¥ã€Œæ¨¡çµ„å±¤ç´šã€ç‚ºä¸»ï¼Œä¸è¿½è¹¤æ¯å€‹ UI å­å…ƒä»¶æª”åï¼Œé¿å…é »ç¹éæ™‚ã€‚
- DB è¦æ ¼è‹¥èˆ‡æ–‡ä»¶è¡çªï¼Œä»¥ `supabase/migrations/` èˆ‡å¯¦éš›è³‡æ–™åº« schema ç‚ºæº–ã€‚
- æ–°å¢é—œéµè·¯ç”±æˆ– migration æ™‚ï¼Œè«‹åŒæ­¥æ›´æ–°æœ¬ç«  `11.2`ã€`11.3`ã€`11.4`ã€‚

---

## 12. æ¸¬è©¦ç­–ç•¥

### 12.0 ç•¶å‰æ¸¬è©¦ç‹€æ…‹ï¼ˆ2026-02-12ï¼‰

- `npm run check`ï¼šâœ… 0 errors / 0 warnings
- `npm run test:e2e`ï¼šâœ… 40 passed
- E2E å·²æ¶µè“‹ï¼š
  - Claims å»ºç«‹/è©³æƒ…/åˆ—è¡¨ç¯©é¸/ç‹€æ…‹æ©Ÿ
  - Approval æµç¨‹ï¼ˆä¸»ç®¡/è²¡å‹™æ ¸å‡†èˆ‡é§å›ï¼‰
  - Payment æµç¨‹ï¼ˆæ‰¹æ¬¡ä»˜æ¬¾ã€æ­·ç¨‹ã€å–æ¶ˆä»˜æ¬¾èˆ‡ guardï¼‰
  - Payee ç®¡ç†ï¼ˆæ–°å¢/æ›´æ–°/åœç”¨/é§å›/æ’¤å›ï¼‰
  - Account/Admin/RLS æ¬Šé™é©—è­‰

### 12.1 æ¸¬è©¦æ¶æ§‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ¸¬è©¦é‡‘å­—å¡”                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                        â”‚   E2E   â”‚  â† Playwright (é—œéµæµç¨‹)     â”‚
â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                      â”‚  æ•´åˆæ¸¬è©¦   â”‚  â† Vitest (API + DB)       â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                 â”‚       å–®å…ƒæ¸¬è©¦         â”‚  â† Vitest (å‡½æ•¸)      â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚  åº•å±¤æ¸¬è©¦å¤šã€å¿«é€ŸåŸ·è¡Œ â†’ ä¸Šå±¤æ¸¬è©¦å°‘ã€é©—è­‰å®Œæ•´æµç¨‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 æ¸¬è©¦å·¥å…·é¸æ“‡

| å±¤ç´š | å·¥å…· | ç”¨é€” |
|------|------|------|
| **å–®å…ƒæ¸¬è©¦** | Vitest | æ¸¬è©¦å·¥å…·å‡½æ•¸ã€è¨ˆç®—é‚è¼¯ |
| **æ•´åˆæ¸¬è©¦** | Vitest | æ¸¬è©¦å‡½æ•¸èˆ‡è³‡æ–™é‚è¼¯ |
| **ç«¯å°ç«¯æ¸¬è©¦** | Playwright | æ¨¡æ“¬ä½¿ç”¨è€…æ“ä½œç€è¦½å™¨ |
| **è¦†è“‹ç‡å ±å‘Š** | vitest coverage | è¨ˆç®—ç¨‹å¼ç¢¼è¦†è“‹ç‡ |

### 12.3 è¨­å®šæª”ç¯„ä¾‹

#### å®‰è£ä¾è³´
```bash
npm install -D vitest @testing-library/svelte jsdom playwright @playwright/test
```

#### vitest.config.ts
```typescript
import { defineConfig } from 'vitest/config';
import { sveltekit } from '@sveltejs/kit/vite';

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    include: ['src/**/*.{test,spec}.{js,ts}'],
    environment: 'jsdom',
    globals: true,
    coverage: {
      reporter: ['text', 'html'],
      exclude: ['node_modules/', 'tests/']
    }
  }
});
```

#### playwright.config.ts
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

#### package.json scripts
```json
{
  "scripts": {
    "test:unit": "vitest",
    "test:run": "vitest run",
    "test:e2e": "playwright test"
  }
}
```

### 12.4 æ¸¬è©¦æ¡ˆä¾‹è¦åŠƒ

#### å–®å…ƒæ¸¬è©¦ (Vitest)

| æ¨¡çµ„ | æ¸¬è©¦é …ç›® | å„ªå…ˆç´š |
|------|----------|:------:|
| **é‡‘é¡è¨ˆç®—** | `calculateTotal()` æ­£ç¢ºåŠ ç¸½ | é«˜ |
| **é‡‘é¡è¨ˆç®—** | è™•ç†ç©ºé™£åˆ— | é«˜ |
| **é‡‘é¡è¨ˆç®—** | è™•ç†è² æ•¸ï¼ˆæ‡‰æ‹’çµ•ï¼‰ | é«˜ |
| **ç™¼ç¥¨é©—è­‰** | `validateInvoiceNumber()` æ ¼å¼æ­£ç¢º | é«˜ |
| **ç™¼ç¥¨é©—è­‰** | æ ¼å¼éŒ¯èª¤å›å‚³ false | é«˜ |
| **ç‹€æ…‹æ©Ÿ** | `getNextStatus()` è½‰æ›æ­£ç¢º | é«˜ |
| **ç‹€æ…‹æ©Ÿ** | éæ³•è½‰æ›æ‹‹å‡ºéŒ¯èª¤ | ä¸­ |

**ç¯„ä¾‹**ï¼š
```typescript
// src/lib/utils/calculate.test.ts
import { describe, it, expect } from 'vitest';
import { calculateTotal } from './calculate';

describe('calculateTotal', () => {
  it('should sum all amounts correctly', () => {
    expect(calculateTotal([100, 200, 300])).toBe(600);
  });

  it('should return 0 for empty array', () => {
    expect(calculateTotal([])).toBe(0);
  });

  it('should throw error for negative amounts', () => {
    expect(() => calculateTotal([-100])).toThrow();
  });
});
```

#### ç«¯å°ç«¯æ¸¬è©¦ (Playwright)

| æµç¨‹ | æ¸¬è©¦é …ç›®ï¼ˆç¾æ³ï¼‰ | å„ªå…ˆç´š |
|------|------------------|:------:|
| **ç™»å…¥/Session** | OAuth å…¥å£ã€æœªç™»å…¥å°å‘ã€session æ³¨å…¥ | é«˜ |
| **è«‹æ¬¾å»ºç«‹** | å“¡å·¥/å» å•†/å‹å‹™ä¸‰ç¨®å»ºå–® | é«˜ |
| **è«‹æ¬¾ç‹€æ…‹æ©Ÿ** | æäº¤/æ ¸å‡†/é§å›/æ’¤å›/æ’¤éŠ· | é«˜ |
| **è«‹æ¬¾åˆ—è¡¨** | tabs ç¯©é¸èˆ‡ç‹€æ…‹ç¾¤çµ„æ­£ç¢ºæ€§ | é«˜ |
| **å¯©æ ¸ä¸­å¿ƒ** | ä¸»ç®¡/è²¡å‹™æ ¸å‡†èˆ‡é§å›æ¬Šé™ | é«˜ |
| **ä»˜æ¬¾æµç¨‹** | æ‰¹æ¬¡ä»˜æ¬¾ã€ä»˜æ¬¾æ­·ç¨‹ã€å–æ¶ˆä»˜æ¬¾ | é«˜ |
| **ä»˜æ¬¾é˜²è­·** | mixed payeeã€invalid statusã€éè²¡å‹™è§’è‰²é™åˆ¶ | é«˜ |
| **å—æ¬¾äººæµç¨‹** | æ–°å¢/æ›´æ–°/åœç”¨ç”³è«‹ã€é§å›ã€æ’¤å› | é«˜ |
| **RLS å®‰å…¨** | profiles/claims/payees æ¬Šé™é‚Šç•Œ | é«˜ |

**ç¯„ä¾‹**ï¼š
```typescript
// tests/claims.spec.ts
import { test, expect } from '@playwright/test';

test.describe('è«‹æ¬¾å–®æµç¨‹', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å…¥ï¼ˆä½¿ç”¨æ¸¬è©¦å¸³è™Ÿï¼‰
    await page.goto('/auth/login');
    // ... ç™»å…¥é‚è¼¯
  });

  test('æ–°å¢å“¡å·¥å ±éŠ·ä¸¦å„²å­˜è‰ç¨¿', async ({ page }) => {
    await page.goto('/claims/new?type=employee');
    
    // å¡«å¯«è¡¨å–®
    await page.fill('[data-testid="description"]', 'æ¸¬è©¦å ±éŠ·');
    await page.fill('[data-testid="item-amount-0"]', '1000');
    await page.selectOption('[data-testid="item-category-0"]', 'äº¤é€šè²»');
    
    // å„²å­˜è‰ç¨¿
    await page.click('[data-testid="save-draft"]');
    
    // é©—è­‰
    await expect(page.locator('.toast-success')).toBeVisible();
    await expect(page).toHaveURL(/\/claims\/[a-z0-9-]+/);
  });

  test('æäº¤è«‹æ¬¾å–®éœ€è¦æ ¸å‡†äºº', async ({ page }) => {
    await page.goto('/claims/new?type=employee');
    
    // å¡«å¯«ä¸¦æäº¤
    await page.fill('[data-testid="description"]', 'æ¸¬è©¦');
    await page.fill('[data-testid="item-amount-0"]', '500');
    await page.click('[data-testid="submit"]');
    
    // æ‡‰è©²çœ‹åˆ°éŒ¯èª¤è¨Šæ¯ï¼ˆå¦‚æœæ²’è¨­å®šæ ¸å‡†äººï¼‰
    await expect(page.locator('.error-message')).toContainText('æ ¸å‡†äºº');
  });
});
```

### 12.5 æ¸¬è©¦åŸ·è¡Œç­–ç•¥

#### é–‹ç™¼æ™‚
```bash
# ç›£è½æ¨¡å¼ï¼Œä¿®æ”¹å¾Œè‡ªå‹•åŸ·è¡Œ
npm run test:unit
```

#### æäº¤å‰
```bash
# åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦ (åƒ…åŸ·è¡Œä¸€æ¬¡)
npm run test:run

# åŸ·è¡Œ E2E æ¸¬è©¦
npm run test:e2e
```

#### CI/CD (GitHub Actions)
```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      
      - name: Run unit tests
        run: npm run test:run
      
      - name: Run E2E tests
        run: npx playwright install && npm run test:e2e
```

### 12.6 è¦†è“‹ç‡ç›®æ¨™

| å±¤ç´š | ç›®æ¨™è¦†è“‹ç‡ | èªªæ˜ |
|------|:----------:|------|
| å–®å…ƒæ¸¬è©¦ | 80% | æ ¸å¿ƒé‚è¼¯å¿…é ˆè¦†è“‹ |
| æ•´åˆæ¸¬è©¦ | 60% | API ä¸»è¦è·¯å¾‘ |
| E2E æ¸¬è©¦ | - | è¦†è“‹æ ¸å¿ƒä½¿ç”¨è€…æµç¨‹ |

### 12.7 å›æ­¸æ¸¬è©¦æ¸…å–®

æ¯æ¬¡ç™¼å¸ƒå‰ï¼Œç¢ºèªä»¥ä¸‹æ ¸å¿ƒæµç¨‹æ­£å¸¸ï¼š

#### èªè­‰
- [ ] Google OAuth çœŸå¯¦ç™»å…¥æµç¨‹
- [ ] ç™»å‡ºå¾Œå°å‘ç™»å…¥é 

#### è«‹æ¬¾
- [x] æ–°å¢å“¡å·¥å ±éŠ·
- [x] æ–°å¢å» å•†è«‹æ¬¾
- [x] æ–°å¢å€‹äººå‹å‹™
- [x] å„²å­˜è‰ç¨¿
- [x] æäº¤è«‹æ¬¾å–®
- [x] ä¸Šå‚³æ†‘è­‰

#### å¯©æ ¸
- [x] ä¸»ç®¡æ ¸å‡†
- [x] ä¸»ç®¡é§å›
- [x] è²¡å‹™æ ¸å‡†
- [x] è²¡å‹™é§å›

#### ä»˜æ¬¾
- [ ] å–®ç­†ä»˜æ¬¾
- [x] æ‰¹æ¬¡ä»˜æ¬¾
- [x] å–æ¶ˆä»˜æ¬¾

---

> ğŸ“š å¦‚æœ‰ç–‘å•ï¼Œå¯ä»¥æŸ¥é–± [SvelteKit å®˜æ–¹æ–‡ä»¶](https://kit.svelte.dev/docs)

> ğŸ’¡ **ä½¿ç”¨æ–¹å¼**ï¼šå°ˆæ¡ˆåˆå§‹åŒ–æ™‚ï¼Œä¾ç…§æœ¬æ–‡ä»¶è¨­å®šæ¸¬è©¦ç’°å¢ƒã€‚é–‹ç™¼æ–°åŠŸèƒ½æ™‚ï¼ŒåŒæ­¥æ’°å¯«å°æ‡‰çš„æ¸¬è©¦æ¡ˆä¾‹ã€‚
