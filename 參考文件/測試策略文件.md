# 請款系統 測試策略文件

> 版本：1.0  
> 最後更新：2026-02-07  
> 適用框架：SvelteKit + Vitest + Playwright

---

## 1. 測試架構總覽

```
┌─────────────────────────────────────────────────────────────────┐
│                         測試金字塔                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        ┌─────────┐                              │
│                        │   E2E   │  ← Playwright (關鍵流程)     │
│                        └────┬────┘                              │
│                      ┌──────┴──────┐                            │
│                      │  整合測試   │  ← Vitest (API + DB)       │
│                      └──────┬──────┘                            │
│                 ┌───────────┴───────────┐                       │
│                 │       單元測試         │  ← Vitest (函數)      │
│                 └───────────────────────┘                       │
│                                                                 │
│  底層測試多、快速執行 → 上層測試少、驗證完整流程                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 測試工具選擇

| 層級 | 工具 | 用途 |
|------|------|------|
| **單元測試** | Vitest | 測試工具函數、計算邏輯 |
| **整合測試** | Vitest + Supertest | 測試 API 端點 |
| **端對端測試** | Playwright | 模擬使用者操作瀏覽器 |
| **覆蓋率報告** | c8 (內建) | 計算程式碼覆蓋率 |

---

## 3. 專案結構

```
報銷_new/
├── src/
│   ├── lib/
│   │   ├── utils/
│   │   │   ├── calculate.ts      # 業務邏輯
│   │   │   └── calculate.test.ts # 對應的單元測試
│   │   └── server/
│   │       ├── claims.ts
│   │       └── claims.test.ts
│   └── routes/
├── tests/                         # E2E 測試
│   ├── auth.spec.ts
│   ├── claims.spec.ts
│   └── approval.spec.ts
├── vitest.config.ts
├── playwright.config.ts
└── package.json
```

---

## 4. 設定檔範例

### 4.1 安裝依賴

```bash
npm install -D vitest @testing-library/svelte jsdom playwright @playwright/test
```

### 4.2 vitest.config.ts

```typescript
import { defineConfig } from 'vitest/config';
import { sveltekit } from '@sveltejs/kit/vite';

export default defineConfig({
  plugins: [sveltekit()],
  test: {
    include: ['src/**/*.{test,spec}.{js,ts}'],
    environment: 'jsdom',
    globals: true,
    coverage: {
      reporter: ['text', 'html'],
      exclude: ['node_modules/', 'tests/']
    }
  }
});
```

### 4.3 playwright.config.ts

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});
```

### 4.4 package.json scripts

```json
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```

---

## 5. 測試案例規劃

### 5.1 單元測試 (Vitest)

| 模組 | 測試項目 | 優先級 |
|------|----------|:------:|
| **金額計算** | `calculateTotal()` 正確加總 | 高 |
| **金額計算** | 處理空陣列 | 高 |
| **金額計算** | 處理負數（應拒絕） | 高 |
| **發票驗證** | `validateInvoiceNumber()` 格式正確 | 高 |
| **發票驗證** | 格式錯誤回傳 false | 高 |
| **狀態機** | `getNextStatus()` 轉換正確 | 高 |
| **狀態機** | 非法轉換拋出錯誤 | 中 |

**範例**：

```typescript
// src/lib/utils/calculate.test.ts
import { describe, it, expect } from 'vitest';
import { calculateTotal } from './calculate';

describe('calculateTotal', () => {
  it('should sum all amounts correctly', () => {
    expect(calculateTotal([100, 200, 300])).toBe(600);
  });

  it('should return 0 for empty array', () => {
    expect(calculateTotal([])).toBe(0);
  });

  it('should throw error for negative amounts', () => {
    expect(() => calculateTotal([-100])).toThrow();
  });
});
```

### 5.2 整合測試 (API)

| 端點 | 測試項目 | 優先級 |
|------|----------|:------:|
| `POST /claims` | 建立請款單成功 | 高 |
| `POST /claims` | 缺少必填欄位回傳 400 | 高 |
| `PATCH /claims/:id/submit` | 提交後狀態變更 | 高 |
| `PATCH /claims/:id/approve` | 無權限回傳 403 | 中 |

### 5.3 端對端測試 (Playwright)

| 流程 | 測試項目 | 優先級 |
|------|----------|:------:|
| **登入** | Google OAuth 登入成功 | 高 |
| **登入** | 未登入導向登入頁 | 高 |
| **請款** | 新增員工報銷 → 儲存草稿 | 高 |
| **請款** | 新增廠商請款 → 提交 | 高 |
| **審核** | 主管核准流程 | 高 |
| **審核** | 財務駁回流程 | 中 |
| **付款** | 單筆付款完成 | 高 |
| **付款** | 批次付款 | 中 |

**範例**：

```typescript
// tests/claims.spec.ts
import { test, expect } from '@playwright/test';

test.describe('請款單流程', () => {
  test.beforeEach(async ({ page }) => {
    // 登入（使用測試帳號）
    await page.goto('/auth/login');
    // ... 登入邏輯
  });

  test('新增員工報銷並儲存草稿', async ({ page }) => {
    await page.goto('/claims/new?type=employee');
    
    // 填寫表單
    await page.fill('[data-testid="description"]', '測試報銷');
    await page.fill('[data-testid="item-amount-0"]', '1000');
    await page.selectOption('[data-testid="item-category-0"]', '交通費');
    
    // 儲存草稿
    await page.click('[data-testid="save-draft"]');
    
    // 驗證
    await expect(page.locator('.toast-success')).toBeVisible();
    await expect(page).toHaveURL(/\/claims\/[a-z0-9-]+/);
  });

  test('提交請款單需要核准人', async ({ page }) => {
    await page.goto('/claims/new?type=employee');
    
    // 填寫並提交
    await page.fill('[data-testid="description"]', '測試');
    await page.fill('[data-testid="item-amount-0"]', '500');
    await page.click('[data-testid="submit"]');
    
    // 應該看到錯誤訊息（如果沒設定核准人）
    await expect(page.locator('.error-message')).toContainText('核准人');
  });
});
```

---

## 6. 測試執行策略

### 6.1 開發時

```bash
# 監聽模式，修改後自動執行
npm run test
```

### 6.2 提交前

```bash
# 執行所有單元測試
npm run test:run

# 執行 E2E 測試
npm run test:e2e
```

### 6.3 CI/CD (GitHub Actions)

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      
      - name: Run unit tests
        run: npm run test:run
      
      - name: Run E2E tests
        run: npx playwright install && npm run test:e2e
```

---

## 7. 測試資料策略

### 7.1 單元測試
- 使用 mock 資料，不連接真實資料庫

### 7.2 整合/E2E 測試
- 使用 Supabase 測試專案
- 每次測試前清理測試資料
- 使用固定的測試帳號

```typescript
// tests/setup.ts
export const TEST_USER = {
  email: 'test@company.com',
  password: 'test-password'
};
```

---

## 8. 覆蓋率目標

| 層級 | 目標覆蓋率 | 說明 |
|------|:----------:|------|
| 單元測試 | 80% | 核心邏輯必須覆蓋 |
| 整合測試 | 60% | API 主要路徑 |
| E2E 測試 | - | 覆蓋核心使用者流程 |

---

## 9. 回歸測試清單

每次發布前，確認以下核心流程正常：

### 認證
- [ ] Google 登入成功
- [ ] 登出後導向登入頁

### 請款
- [ ] 新增員工報銷
- [ ] 新增廠商請款
- [ ] 新增個人勞務
- [ ] 儲存草稿
- [ ] 提交請款單
- [ ] 上傳憑證

### 審核
- [ ] 主管核准
- [ ] 主管駁回
- [ ] 財務核准
- [ ] 財務駁回

### 付款
- [ ] 單筆付款
- [ ] 批次付款
- [ ] 取消付款

---

> 💡 **使用方式**：專案初始化時，依照本文件設定測試環境。開發新功能時，同步撰寫對應的測試案例。
