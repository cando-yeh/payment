# 請款系統 開發計劃

> 最後更新：2026-02-07  
> 預估開發時程：8-10 週  
> 相關文件：[產品規格書](./產品規格書_請款系統.md)、[技術架構文件](./技術架構文件.md)、[資料庫設計文件](./資料庫設計文件.md)

---

## 📋 開發階段總覽

> **開發策略**：DB Schema 先行 + 垂直切片  
> 先建立完整資料庫結構，再以「功能模組」為單位，前後端同時開發

| 階段 | 名稱 | 預估時間 | 狀態 |
|:---:|------|:--------:|:----:|
| 0 | 環境建置 + 專案初始化 | 0.5 週 | ⬜ |
| 1 | **Database Schema 全部建立** | 0.5 週 | ⬜ |
| 2 | UI 元件庫 | 0.5 週 | ⬜ |
| 3 | 登入認證 (前後端) | 0.5 週 | ⬜ |
| 4 | 我的請款 - 完整功能 (前後端) | 2 週 | ⬜ |
| 5 | 審核中心 - 完整功能 (前後端) | 1.5 週 | ⬜ |
| 6 | 付款模組 - 完整功能 (前後端) | 1 週 | ⬜ |
| 7 | 廠商管理 - 完整功能 (前後端) | 1 週 | ⬜ |
| 8 | 通知系統 | 0.5 週 | ⬜ |
| 9 | 測試與優化 | 1 週 | ⬜ |

### 為什麼這樣安排？

1. **DB Schema 先完成** — 資料結構是基礎，避免後續反覆修改
2. **垂直切片** — 每個功能前後端一起做，完成即可測試
3. **SvelteKit 特性** — `+page.server.ts` 天生就是前後端寫在一起

---

## 階段 0：環境建置 (0.5 週)

### 目標
建立開發環境與專案基礎結構

### 任務清單

- [ ] **0.1 專案初始化**
  - [ ] 建立 SvelteKit 專案 (`npx create svelte@latest`)
  - [ ] 設定 TypeScript
  - [ ] 設定 Tailwind CSS
  - [ ] 建立 `.env.example` 環境變數範本

- [ ] **0.2 Supabase 設定**
  - [ ] 建立 Supabase 專案
  - [ ] 設定 Google OAuth 認證
  - [ ] 設定企業網域限制 (@company.com)
  - [ ] 建立 Storage bucket (憑證存放)

- [ ] **0.3 版本控制**
  - [ ] 初始化 Git 倉庫
  - [ ] 建立 `.gitignore`
  - [ ] 連結 GitHub 倉庫
  - [ ] 分支策略：直接使用 `main`（獨立開發簡化版）

- [ ] **0.4 部署設定**
  - [ ] 連結 Vercel
  - [ ] 設定環境變數
  - [ ] 測試自動部署

- [ ] **0.5 測試架構設定**
  - [ ] 安裝 Vitest + Testing Library
  - [ ] 安裝 Playwright
  - [ ] 建立 `vitest.config.ts`
  - [ ] 建立 `playwright.config.ts`
  - [ ] 設定 package.json scripts

### 驗收標準
✅ 專案可本地運行  
✅ 可成功部署至 Vercel  
✅ Supabase 連線正常  
✅ `npm run test` 可執行  
✅ `npm run test:e2e` 可執行

---

## 階段 1：基礎架構 (1 週)

### 目標
建立資料庫結構與共用元件

### 任務清單

- [ ] **1.1 資料庫 Schema**
  - [ ] 建立 users 表
  - [ ] 建立 claims 表
  - [ ] 建立 claim_items 表
  - [ ] 建立 claim_history 表
  - [ ] 建立 vendors 表
  - [ ] 建立 vendor_change_requests 表
  - [ ] 建立 payments 表
  - [ ] 建立 expense_categories 表
  - [ ] 建立 Enum 類型 (claim_status, claim_type, vendor_status...)
  - [ ] 設定 RLS 策略

- [ ] **1.2 UI 設計系統**
  - [ ] 定義色彩變數 (CSS Variables)
  - [ ] 建立 Typography 規範
  - [ ] 建立 Button 元件 (Primary / Secondary / Danger)
  - [ ] 建立 Input / Select / Textarea 元件
  - [ ] 建立 Card 元件
  - [ ] 建立 Badge 元件 (狀態標籤)
  - [ ] 建立 Modal 元件
  - [ ] 建立 Toast 通知元件

- [ ] **1.3 佈局元件**
  - [ ] 建立 Sidebar 導航
  - [ ] 建立 Header 元件
  - [ ] 建立 Breadcrumb 元件
  - [ ] 建立 PageLayout 包裝元件
  - [ ] 建立 Loading / Skeleton 元件

### 驗收標準
✅ 所有資料表建立完成  
✅ RLS 策略測試通過  
✅ UI 元件庫完整可用

---

## 階段 2：使用者模組 (1 週)

### 目標
完成登入、個人資料與權限管理

### 任務清單

- [ ] **2.1 認證流程**
  - [ ] 實作 Google OAuth 登入頁
  - [ ] 實作登入 callback 處理
  - [ ] 實作登出功能
  - [ ] 實作 Session 管理 (hooks)
  - [ ] 實作未登入保護 (redirect)

- [ ] **2.2 個人帳戶頁**
  - [ ] 顯示基本資料 (姓名、Email、部門)
  - [ ] 顯示目前核准人
  - [ ] 編輯匯款資訊 (員工報銷用)
  - [ ] 匯款欄位驗證

- [ ] **2.3 使用者管理 (Admin)**
  - [ ] 使用者清單頁面
  - [ ] 指派核准人功能
  - [ ] 開關財務/管理員權限
  - [ ] 搜尋使用者

### 驗收標準
✅ Google 登入可正常使用  
✅ 權限控管正確 (驗證各角色存取)  
✅ 個人資料可編輯並儲存

---

## 階段 3：請款核心 (2 週)

### 目標
完成三種請款單的建立與編輯

### 任務清單

- [ ] **3.1 我的請款頁**
  - [ ] 建立 Tab 導航 (草稿 / 處理中 / 待處理 / 歷程)
  - [ ] 請款單清單表格
  - [ ] 搜尋功能 (單號 / 對象 / 說明)
  - [ ] 篩選功能 (日期區間 / 類別 / 狀態)
  - [ ] 排序功能 (時間降序)

- [ ] **3.2 員工報銷表單**
  - [ ] 主表單結構
  - [ ] 多筆明細 (新增 / 編輯 / 刪除)
  - [ ] 費用類別選單
  - [ ] 金額驗證 (> 0)
  - [ ] 發票號碼格式驗證
  - [ ] 憑證上傳 (單筆明細)
  - [ ] 總金額自動計算
  - [ ] 儲存草稿功能
  - [ ] 提交前驗證 (核准人 / 匯款帳號)

- [ ] **3.3 廠商請款表單**
  - [ ] 廠商選擇器 (搜尋 + 選取)
  - [ ] 快速新增廠商入口
  - [ ] 多筆明細
  - [ ] 浮動帳號處理
  - [ ] 儲存草稿 / 提交

- [ ] **3.4 個人勞務表單**
  - [ ] 受款人資訊 (姓名 / 身分證 / Email / 地址)
  - [ ] 銀行匯款資訊
  - [ ] 服務期間選擇
  - [ ] 單筆明細 (案由 / 金額)
  - [ ] 三項必要附件 (身分證正反 + 存摺)
  - [ ] 儲存草稿 / 提交

- [ ] **3.5 請款單詳情頁**
  - [ ] 2:1 分割佈局 (資訊 + 附件)
  - [ ] 完整明細表格
  - [ ] 審核時間軸
  - [ ] 附件預覽
  - [ ] 操作按鈕 (依角色/狀態動態顯示)

- [ ] **3.6 憑證管理**
  - [ ] 檔案上傳 (PDF / JPG / PNG)
  - [ ] 檔案大小驗證 (< 10MB)
  - [ ] 產生 attachment_id
  - [ ] Signed URL 取得
  - [ ] 刪除 / 更換憑證

### 驗收標準
✅ 三種請款單皆可建立並儲存草稿  
✅ 表單驗證完整  
✅ 憑證上傳下載正常

---

## 階段 4：審核流程 (1.5 週)

### 目標
完成主管與財務的審核功能

### 任務清單

- [ ] **4.1 狀態機實作**
  - [ ] 定義狀態轉換 Map
  - [ ] 建立狀態變更 API
  - [ ] 自動記錄 claim_history
  - [ ] 二次確認 Modal (撤銷、核准、駁回)

- [ ] **4.2 申請人操作**
  - [ ] 提交功能 (草稿 → 主管審核)
  - [ ] 撤回功能 (主管審核 / 財務審核 → 草稿)
  - [ ] 重新提交 (已退回 → 主管審核)
  - [ ] 撤銷功能 (已退回 → 已撤銷)
  - [ ] 補件處理 (上傳或填寫原因)

- [ ] **4.3 審核中心頁面**
  - [ ] 主管待審核清單
  - [ ] 財務待審核清單
  - [ ] 待付款清單
  - [ ] 補件審核清單
  - [ ] 所有單據 (財務全域檢視)

- [ ] **4.4 主管審核**
  - [ ] 核准功能 (→ 財務審核)
  - [ ] 駁回功能 (→ 已退回)
  - [ ] 填寫審核意見

- [ ] **4.5 財務審核**
  - [ ] 核准功能 (→ 待付款)
  - [ ] 駁回功能 (→ 已退回)
  - [ ] 填寫審核意見
  - [ ] 補件審核 (核准 / 駁回)

- [ ] **4.6 重複發票檢查**
  - [ ] 提交時檢查
  - [ ] 主管核准時檢查
  - [ ] 財務核准時檢查
  - [ ] 警示 Modal (顯示重複資訊)

### 驗收標準
✅ 完整狀態流程可走通  
✅ 審核歷程正確記錄  
✅ 重複發票正確警示

---

## 階段 5：付款模組 (1 週)

### 目標
完成付款執行與管理

### 任務清單

- [ ] **5.1 單筆付款**
  - [ ] 完成付款功能
  - [ ] 完成付款(需補件)功能
  - [ ] 產生付款單 (Payment)
  - [ ] 更新請款單狀態

- [ ] **5.2 批次付款**
  - [ ] 多選請款單 (同一對象)
  - [ ] 驗證對象一致性
  - [ ] 合併產生付款單
  - [ ] 批次更新請款單狀態

- [ ] **5.3 付款清單**
  - [ ] 付款單列表
  - [ ] 付款單詳情 (包含的請款單)
  - [ ] 取消付款功能
  - [ ] 取消時狀態處理

- [ ] **5.4 取消付款邏輯**
  - [ ] 檢查補件審核狀態
  - [ ] 退回對應狀態
  - [ ] 保留已補件資訊

### 驗收標準
✅ 單筆/批次付款正常  
✅ 付款單記錄完整  
✅ 取消付款邏輯正確

---

## 階段 6：廠商管理 (1 週)

### 目標
完成廠商 CRUD 與審核

### 任務清單

- [ ] **6.1 廠商列表頁**
  - [ ] 廠商表格
  - [ ] 搜尋功能 (廠商名稱)
  - [ ] 篩選 (狀態)
  - [ ] 依使用者角色顯示操作

- [ ] **6.2 新增廠商**
  - [ ] 填寫基本資訊
  - [ ] 填寫匯款資訊
  - [ ] 浮動帳號設定
  - [ ] 產生異動申請 (待審核)

- [ ] **6.3 修改廠商**
  - [ ] 編輯表單
  - [ ] 產生異動申請
  - [ ] 記錄異動前後快照

- [ ] **6.4 停用廠商**
  - [ ] 確認對話框
  - [ ] 產生停用申請

- [ ] **6.5 廠商異動審核 (財務)**
  - [ ] 異動申請列表
  - [ ] 檢視異動差異
  - [ ] 核准 (同步更新主檔)
  - [ ] 駁回

- [ ] **6.6 停用影響處理**
  - [ ] 進行中單據可繼續
  - [ ] 禁止新建請款

### 驗收標準
✅ 廠商 CRUD 完整  
✅ 異動審核流程正確  
✅ 停用後新建受限

---

## 階段 7：通知系統 (0.5 週)

### 目標
建立 Email 通知機制

### 任務清單

- [ ] **7.1 Edge Function 設定**
  - [ ] 建立 Email 發送函數
  - [ ] 設定 SMTP 連線
  - [ ] 測試發送

- [ ] **7.2 通知觸發點**
  - [ ] 提交通知 (→ 主管)
  - [ ] 核准通知 (→ 申請人 / 下一關)
  - [ ] 駁回通知 (→ 申請人)
  - [ ] 付款完成通知 (→ 申請人)
  - [ ] 補件請求通知 (→ 申請人)

- [ ] **7.3 Email 模板**
  - [ ] 設計 HTML 模板
  - [ ] 包含快速連結

- [ ] **7.4 免通知規則**
  - [ ] 動作者 = 接收者時不發送

### 驗收標準
✅ Email 通知可正常發送  
✅ 模板呈現正確

---

## 階段 8：測試與優化 (1 週)

### 目標
確保品質與效能

### 任務清單

- [ ] **8.1 功能測試**
  - [ ] 端對端流程測試
  - [ ] 各角色權限驗證
  - [ ] 邊界條件測試
  - [ ] 錯誤處理測試

- [ ] **8.2 效能優化**
  - [ ] Prefetching 設定
  - [ ] 樂觀更新實作
  - [ ] 圖片壓縮
  - [ ] 測量 API 響應時間

- [ ] **8.3 安全性檢查**
  - [ ] RLS 策略審查
  - [ ] XSS 防護確認
  - [ ] 敏感資料加密確認

- [ ] **8.4 定時任務**
  - [ ] 建立孤立檔案清理 Cron
  - [ ] 測試執行

- [ ] **8.5 文件更新**
  - [ ] 更新 README
  - [ ] API 文件
  - [ ] 部署文件

### 驗收標準
✅ 核心流程測試通過  
✅ 效能指標達標  
✅ 安全性檢查通過

---

## 🛠️ 開發原則

### Git 提交規範
```
feat: 新增功能
fix: 修復 bug
docs: 文件更新
style: 樣式調整 (不影響邏輯)
refactor: 重構
test: 測試
chore: 雜項
```

### 每日開發流程
1. 📋 查看今天要做的任務
2. 🔀 建立 feature branch
3. 💻 開發與本地測試
4. ✅ 提交 PR 並 Review 自己的 code
5. 🚀 Merge 至 develop
6. 📝 更新開發計劃進度

### 里程碑檢查點
| 週數 | 里程碑 | 驗證目標 |
|:---:|--------|----------|
| 2 | MVP Demo | 登入 + 草稿儲存 |
| 4 | Alpha | 完整審核流程 |
| 6 | Beta | 付款 + 廠商管理 |
| 8 | RC | 通知 + 測試完成 |

---

## 📊 風險與對策

| 風險 | 機率 | 影響 | 對策 |
|------|:----:|:----:|------|
| Supabase 服務中斷 | 低 | 高 | 設定備份、監控 Alert |
| OAuth 設定問題 | 中 | 中 | 先做 POC 驗證 |
| 檔案上傳失敗 | 中 | 中 | 實作重試機制 |
| 效能不達標 | 低 | 中 | 預留優化時間 |

---

## 📁 建議專案結構

```
報銷_new/
├── src/
│   ├── routes/
│   │   ├── +layout.svelte        # 主佈局
│   │   ├── +page.svelte          # 首頁 (我的請款)
│   │   ├── auth/                 # 登入相關
│   │   ├── claims/               # 請款單
│   │   │   ├── new/              # 新增請款
│   │   │   └── [id]/             # 請款詳情
│   │   ├── approval/             # 審核中心
│   │   ├── payments/             # 付款管理
│   │   ├── vendors/              # 廠商管理
│   │   ├── account/              # 個人帳戶
│   │   └── admin/                # 系統管理
│   ├── lib/
│   │   ├── components/           # UI 元件
│   │   ├── stores/               # Svelte Stores
│   │   ├── utils/                # 工具函數
│   │   └── server/               # Server 端邏輯
│   └── app.css                   # 全域樣式
├── static/                       # 靜態資源
├── supabase/
│   └── migrations/               # 資料庫遷移
├── .env.example
├── package.json
├── svelte.config.js
├── tailwind.config.js
└── README.md
```

---

> 💡 **使用方式**：完成一項任務後，將 `[ ]` 改為 `[x]`，並記錄於 Git commit 中。
