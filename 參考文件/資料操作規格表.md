# 請款系統 資料操作規格表

> 版本：1.0  
> 最後更新：2026-02-07  
> 說明：定義系統中所有資料操作的輸入/輸出規格，供開發時參考

---

## 1. 認證模組 (Auth)

| 操作 | 說明 | 輸入 | 輸出 |
|------|------|------|------|
| `signInWithGoogle()` | Google OAuth 登入 | - | `Session` |
| `signOut()` | 登出 | - | - |
| `getSession()` | 取得目前 Session | - | `Session \| null` |
| `getCurrentUser()` | 取得目前使用者資料 | - | `User` |

---

## 2. 使用者模組 (Users)

### 讀取操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `getUsers()` | 取得使用者清單 | `{ search?, role? }` | `User[]` | Admin |
| `getUserById()` | 取得單一使用者 | `userId` | `User` | Self/Admin |
| `getApproverOptions()` | 取得可選擇的核准人 | - | `User[]` | Admin |

### 寫入操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `updateProfile()` | 更新個人資料 | `{ name, bank_code, bank_account, ... }` | `User` | Self |
| `assignApprover()` | 指派核准人 | `{ userId, approverId }` | `User` | Admin |
| `updateUserRole()` | 更新使用者角色 | `{ userId, role }` | `User` | Admin |

---

## 3. 請款單模組 (Claims)

### 讀取操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `getMyClaims()` | 取得我的請款單 | `{ status?, type?, dateFrom?, dateTo? }` | `Claim[]` | All |
| `getDraftClaims()` | 取得草稿 | - | `Claim[]` | Self |
| `getPendingClaims()` | 取得處理中單據 | - | `Claim[]` | Self |
| `getReturnedClaims()` | 取得已退回單據 | - | `Claim[]` | Self |
| `getClaimById()` | 取得單一請款單 | `claimId` | `ClaimDetail` | Owner/Approver/Finance |
| `getClaimHistory()` | 取得審核歷程 | `claimId` | `ClaimHistory[]` | Owner/Approver/Finance |

### 寫入操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `createClaim()` | 新增請款單 | `ClaimInput` | `Claim` | All |
| `updateClaim()` | 更新請款單 (草稿) | `{ claimId, ...ClaimInput }` | `Claim` | Owner (draft only) |
| `deleteClaim()` | 刪除請款單 | `claimId` | - | Owner (draft only) |
| `submitClaim()` | 提交請款單 | `claimId` | `Claim` | Owner |
| `withdrawClaim()` | 撤回請款單 | `claimId` | `Claim` | Owner |
| `resubmitClaim()` | 重新提交 | `claimId` | `Claim` | Owner (returned) |
| `cancelClaim()` | 撤銷請款單 | `claimId` | `Claim` | Owner (returned) |

### 資料結構

```typescript
// 請款單輸入
interface ClaimInput {
  claim_type: 'employee' | 'vendor' | 'personal_service';
  description: string;
  vendor_id?: string;              // 廠商請款用
  personal_service_data?: {        // 個人勞務用
    name: string;
    id_number: string;
    email: string;
    address: string;
    bank_code: string;
    bank_account: string;
    service_period_start: string;
    service_period_end: string;
  };
  items: ClaimItemInput[];
}

// 請款明細輸入
interface ClaimItemInput {
  date: string;
  category: string;
  description: string;
  amount: number;
  invoice_number?: string;
  invoice_date?: string;
  no_evidence_flag?: boolean;
  no_evidence_reason?: string;
  attachment?: File;
}
```

---

## 4. 審核模組 (Approval)

### 讀取操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `getPendingApproval()` | 取得待審核清單 (主管) | - | `Claim[]` | Manager |
| `getFinanceReview()` | 取得待財務審核 | - | `Claim[]` | Finance |
| `getPendingPayment()` | 取得待付款清單 | - | `Claim[]` | Finance |
| `getDocReview()` | 取得補件審核清單 | - | `Claim[]` | Finance |
| `getAllClaims()` | 取得所有單據 | `{ search?, status?, type?, ... }` | `Claim[]` | Finance/Admin |

### 寫入操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `approveClaim()` | 核准請款單 | `{ claimId, comment? }` | `Claim` | Manager/Finance |
| `rejectClaim()` | 駁回請款單 | `{ claimId, comment }` | `Claim` | Manager/Finance |
| `approveDoc()` | 核准補件 | `{ claimId, comment? }` | `Claim` | Finance |
| `rejectDoc()` | 駁回補件 | `{ claimId, comment }` | `Claim` | Finance |

### 狀態轉換規則

```
┌──────────────────────────────────────────────────────────────────────────┐
│                             狀態轉換圖                                     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  draft ──submit──▶ pending_manager ──approve──▶ pending_finance          │
│    ▲                   │      │                     │      │             │
│    │                   │   withdraw                 │   withdraw         │
│    │                   │      │                     │      │             │
│    │                   ▼      │                     ▼      │             │
│    │                reject    │                  reject    │             │
│    │                   │      │                     │      │             │
│    │                   ▼      └────────┐            ▼      │             │
│    │               returned ◀──────────┼────────────┘      │             │
│    │                 │   │             │                   │             │
│    │           cancel│   │ resubmit   └───────────────────┘              │
│    │                 ▼   ▼                                               │
│    │            cancelled  pending_manager                               │
│    │                                                                     │
│    └──────────────────────── (withdraw 回到 draft)                        │
│                                                                          │
│                      revoke_approval                                     │
│                            │                                             │
│  pending_finance ◀─────────┤                                             │
│         │                  │                                             │
│      approve               │                                             │
│         ▼                  │                                             │
│  pending_payment ──────────┘                                             │
│         │                                                                │
│    pay  │  pay(需補件)                                                    │
│         ▼         ▼                                                      │
│       paid    paid_pending_doc ◀───────────────────────┐                 │
│         ▲         │                                    │                 │
│         │    submit_doc                              reject              │
│         │         ▼                                    │                 │
│         │   pending_doc_review ────────────────────────┘                 │
│         │         │                                                      │
│         └─approve─┘                                                      │
│                                                                          │
│  ┌─ cancel_payment ──────────────────────────────────────┐               │
│  │  paid ──────────────▶ pending_payment                 │               │
│  │  paid_pending_doc ──▶ pending_payment                 │               │
│  └───────────────────────────────────────────────────────┘               │
└──────────────────────────────────────────────────────────────────────────┘
```

**狀態轉換動作對照**：

| 動作 | 來源狀態 | 目標狀態 | 執行者 |
|------|----------|----------|--------|
| submit | draft | pending_manager | 申請人 |
| withdraw | pending_manager | draft | 申請人 |
| withdraw | pending_finance | draft | 申請人 |
| approve | pending_manager | pending_finance | 主管 |
| reject | pending_manager | returned | 主管 |
| approve | pending_finance | pending_payment | 財務 |
| reject | pending_finance | returned | 財務 |
| resubmit | returned | pending_manager | 申請人 |
| cancel | returned | cancelled | 申請人 |
| pay | pending_payment | paid | 財務 |
| pay (需補件) | pending_payment | paid_pending_doc | 財務 |
| submit_doc | paid_pending_doc | pending_doc_review | 申請人 |
| approve | pending_doc_review | paid | 財務 |
| reject | pending_doc_review | paid_pending_doc | 財務 |
| revoke_approval | pending_payment | pending_finance | 財務 |
| cancel_payment | paid | pending_payment | 財務 |
| cancel_payment | paid_pending_doc | pending_payment | 財務 |

> ⚠️ **取消付款注意**：取消付款是針對「付款單」執行，會將該付款單內所有請款單退回 `pending_payment`

---

## 5. 付款模組 (Payments)

### 讀取操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `getPayments()` | 取得付款單清單 | `{ status?, dateFrom?, dateTo? }` | `Payment[]` | Finance |
| `getPaymentById()` | 取得付款單詳情 | `paymentId` | `PaymentDetail` | Finance |

### 寫入操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `createPayment()` | 執行付款 (單筆) | `{ claimId, needDoc? }` | `Payment` | Finance |
| `createBatchPayment()` | 執行批次付款 | `{ claimIds[], needDoc? }` | `Payment` | Finance |
| `cancelPayment()` | 取消付款 | `paymentId` | `Payment` | Finance |
| `revokeApproval()` | 取消核准 | `claimId` | `Claim` | Finance |

### 批次付款規則

```typescript
// 批次付款驗證
function validateBatchPayment(claims: Claim[]): boolean {
  // 1. 所有單據必須是 pending_payment 狀態
  // 2. 所有單據必須是同一付款對象 (同一 vendor_id 或同一 applicant_id)
  // 3. 無筆數上限、無金額上限
}
```

---

## 6. 補件模組 (Document Supplement)

### 寫入操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `submitDocument()` | 提交補件 | `{ claimId, items: DocInput[] }` | `Claim` | Owner |

### 資料結構

```typescript
interface DocInput {
  item_id: string;
  type: 'upload' | 'no_evidence';
  attachment?: File;              // type = 'upload' 時
  no_evidence_reason?: string;    // type = 'no_evidence' 時
}
```

---

## 7. 廠商模組 (Vendors)

### 讀取操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `getVendors()` | 取得廠商清單 | `{ search?, status? }` | `Vendor[]` | All |
| `getVendorById()` | 取得廠商詳情 | `vendorId` | `Vendor` | All |
| `getVendorChangeRequests()` | 取得異動申請 | `{ status? }` | `VendorChangeRequest[]` | Finance |

### 寫入操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `requestCreateVendor()` | 申請新增廠商 | `VendorInput` | `VendorChangeRequest` | All |
| `requestUpdateVendor()` | 申請修改廠商 | `{ vendorId, ...VendorInput }` | `VendorChangeRequest` | All |
| `requestDisableVendor()` | 申請停用廠商 | `{ vendorId, reason }` | `VendorChangeRequest` | All |
| `approveVendorChange()` | 核准廠商異動 | `{ requestId, comment? }` | `VendorChangeRequest` | Finance |
| `rejectVendorChange()` | 駁回廠商異動 | `{ requestId, comment }` | `VendorChangeRequest` | Finance |

---

## 8. 憑證模組 (Attachments)

### 操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `uploadAttachment()` | 上傳憑證 | `{ claimId, itemIndex, file }` | `{ attachment_id, url }` | Owner |
| `deleteAttachment()` | 刪除憑證 | `attachment_id` | - | Owner (draft) |
| `getAttachmentUrl()` | 取得憑證 URL | `attachment_id` | `signedUrl` | Authorized |

### 檔案限制

```typescript
const ATTACHMENT_RULES = {
  allowedTypes: ['application/pdf', 'image/jpeg', 'image/png'],
  maxSize: 10 * 1024 * 1024,  // 10MB
  path: '/claims/{claim_id}/attachments/{attachment_id}.{ext}'
};
```

---

## 9. 費用類別模組 (Categories)

### 操作

| 操作 | 說明 | 輸入 | 輸出 | 權限 |
|------|------|------|------|------|
| `getCategories()` | 取得費用類別 | - | `Category[]` | All |
| `createCategory()` | 新增類別 | `{ name }` | `Category` | Admin |
| `updateCategory()` | 更新類別 | `{ id, name, is_active }` | `Category` | Admin |

---

## 10. 發票重複檢查

### 操作

| 操作 | 說明 | 輸入 | 輸出 |
|------|------|------|------|
| `checkDuplicateInvoice()` | 檢查發票是否重複 | `{ invoice_number, vendor_id? }` | `DuplicateInfo \| null` |

### 回傳結構

```typescript
interface DuplicateInfo {
  claim_id: string;
  claim_number: string;
  payee_name: string;
  amount: number;
  description: string;
}
```

---

## 附錄：通用資料結構

### User

```typescript
interface User {
  id: string;
  email: string;
  name: string;
  role: 'applicant' | 'manager' | 'finance' | 'admin';
  approver_id: string | null;
  approver_name: string | null;
  bank_code: string | null;
  bank_name: string | null;
  bank_branch: string | null;
  bank_account: string | null;
  created_at: string;
  updated_at: string;
}
```

### Claim

```typescript
interface Claim {
  id: string;
  claim_number: string;
  claim_type: 'employee' | 'vendor' | 'personal_service';
  status: ClaimStatus;
  applicant_id: string;
  applicant_name: string;
  vendor_id: string | null;
  vendor_name: string | null;
  total_amount: number;
  description: string;
  has_evidence: boolean;
  created_at: string;
  updated_at: string;
  submitted_at: string | null;
  completed_at: string | null;
}

type ClaimStatus = 
  | 'draft'
  | 'pending_manager'
  | 'pending_finance'
  | 'pending_payment'
  | 'paid'
  | 'paid_pending_doc'
  | 'pending_doc_review'
  | 'returned'
  | 'cancelled';
```

### Vendor

```typescript
interface Vendor {
  id: string;
  name: string;
  service_description: string | null;
  bank_code: string;
  bank_name: string | null;
  bank_account: string;
  is_floating_account: boolean;
  status: 'pending' | 'approved' | 'disabled';
  created_at: string;
  updated_at: string;
}
```

### Payment

```typescript
interface Payment {
  id: string;
  payment_number: string;
  payee_type: 'employee' | 'vendor' | 'personal';
  payee_id: string;
  payee_name: string;
  total_amount: number;
  bank_code: string;
  bank_account: string;
  status: 'completed' | 'cancelled';
  paid_by: string;
  paid_at: string;
  cancelled_at: string | null;
  claims: Claim[];  // 包含的請款單
}
```
