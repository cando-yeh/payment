# 請款系統 資料庫設計文件

> 版本：1.0  
> 最後更新：2026-02-07  
> 資料庫：PostgreSQL (Supabase)  
> 相關文件：[產品規格書](./產品規格書_請款系統.md)、[技術架構文件](./技術架構文件.md)

---

## 1. 資料模型概覽

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   users     │────▶│   claims    │────▶│ claim_items │
│  (使用者)    │     │  (請款單)    │     │ (請款明細)   │
└─────────────┘     └──────┬──────┘     └─────────────┘
      │                    │
      │              ┌─────┼─────┐
      │              │     │     │
      │              ▼     ▼     ▼
      │   ┌─────────────┐  ┌─────────────┐
      │   │claim_history│  │  payments   │
      │   │ (審核歷程)   │  │ (付款單)    │
      │   └─────────────┘  └─────────────┘
      │
      ▼
┌─────────────┐     ┌─────────────┐
│  vendors    │────▶│vendor_change│
│  (廠商)     │     │ _requests   │
└─────────────┘     │ (異動申請)   │
                    └─────────────┘
```

**關聯說明**：
- 一個「付款單」可包含多個「請款單」 (批次付款)
- 一個「請款單」僅屬於一個「付款單」
- 直接透過 `claims.payment_id` 外鍵建立一對多關係 (無需關聯表)

---

## 2. 資料表定義

### 2.1 users (使用者)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | Supabase Auth 自動產生 |
| `email` | varchar(255) | Email | 唯一，企業網域 |
| `name` | varchar(100) | 姓名 | |
| `role` | enum | 角色 | applicant/manager/finance/admin |
| `approver_id` | uuid | 核准人 | FK → users.id |
| `bank_code` | varchar(10) | 銀行代碼 | 加密儲存 |
| `bank_name` | varchar(50) | 銀行名稱 | |
| `bank_branch` | varchar(50) | 分行名稱 | |
| `bank_account` | varchar(20) | 銀行帳號 | 加密儲存 |
| `created_at` | timestamptz | 建立時間 | |
| `updated_at` | timestamptz | 更新時間 | |

**索引**：
- `users_email_idx` ON (email)
- `users_approver_id_idx` ON (approver_id)

---

### 2.2 claims (請款單主檔)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `claim_number` | varchar(20) | 單號 | 唯一，格式：CLM{YYYYMMDD}{seq} |
| `claim_type` | enum | 類別 | employee/vendor/personal_service |
| `status` | enum | 狀態 | 見狀態列舉 |
| `applicant_id` | uuid | 申請人 | FK → users.id |
| `vendor_id` | uuid | 廠商 | FK → vendors.id (僅廠商請款) |
| `total_amount` | decimal(12,2) | 總金額 | |
| `currency` | varchar(3) | 幣別 | 固定為 TWD |
| `description` | text | 請款說明 | |
| `has_evidence` | boolean | 是否有憑證 | 補件後設為 true |
| `created_at` | timestamptz | 建立時間 | |
| `updated_at` | timestamptz | 更新時間 | |
| `submitted_at` | timestamptz | 提交時間 | |
| `completed_at` | timestamptz | 完成時間 | |
| `payment_id` | uuid | 付款單 | FK → payments.id (付款後填入) |
| `payee_id_number` | varchar(20) | 受款人身分證 | 僅個人勞務，加密儲存 |
| `payee_bank_code` | varchar(10) | 受款人銀行代碼 | 僅個人勞務，加密儲存 |
| `payee_bank_account` | varchar(20) | 受款人帳號 | 僅個人勞務，加密儲存 |
| `personal_service_data` | jsonb | 個人勞務資訊 | 僅個人勞務，見下方結構 |

**個人勞務 JSONB 結構** (`personal_service_data`)：
```json
{
  "name": "王小明",
  "email": "test@example.com",
  "address": "台北市...",
  "bank_name": "中國信託",
  "service_period_start": "2026-01-01",
  "service_period_end": "2026-01-31",
  "id_front_attachment": "https://...",
  "id_back_attachment": "https://...",
  "bankbook_attachment": "https://..."
}
```

**請款單狀態列舉 (claim_status)**：
```sql
CREATE TYPE claim_status AS ENUM (
  'draft',              -- 草稿
  'pending_manager',    -- 主管審核
  'pending_finance',    -- 財務審核
  'pending_payment',    -- 待付款
  'paid',               -- 付款完成
  'paid_pending_doc',   -- 付款完成(待補件)
  'pending_doc_review', -- 補件審核
  'returned',           -- 已退回
  'cancelled'           -- 已撤銷
);
```

**索引**：
- `claims_applicant_id_idx` ON (applicant_id)
- `claims_vendor_id_idx` ON (vendor_id)
- `claims_status_idx` ON (status)
- `claims_created_at_idx` ON (created_at DESC)
- `claims_payment_id_idx` ON (payment_id)

---

### 2.3 claim_items (請款明細)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `claim_id` | uuid | 請款單 | FK → claims.id |
| `item_index` | int | 項目序號 | |
| `date` | date | 交易日期 | |
| `category` | varchar(50) | 費用類別 | |
| `description` | text | 說明 | |
| `amount` | decimal(12,2) | 金額 | |
| `invoice_number` | varchar(20) | 發票號碼 | 格式：2英文+8數字 |
| `invoice_date` | date | 發票日期 | |
| `no_evidence_flag` | boolean | 無憑證標記 | |
| `no_evidence_reason` | text | 無法取得原因 | |
| `attachment_id` | uuid | 憑證 ID | |
| `attachment_url` | text | 憑證 URL | Signed URL |
| `attachment_status` | enum | 憑證狀態 | pending/uploaded/none |
| `created_at` | timestamptz | 建立時間 | |
| `updated_at` | timestamptz | 更新時間 | |

**索引**：
- `claim_items_claim_id_idx` ON (claim_id)
- `claim_items_invoice_number_idx` ON (invoice_number)

---

### 2.5 claim_history (審核歷程)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `claim_id` | uuid | 請款單 | FK → claims.id |
| `actor_id` | uuid | 執行者 | FK → users.id |
| `action` | varchar(50) | 動作 | submit/approve/reject/withdraw... |
| `from_status` | enum | 來源狀態 | |
| `to_status` | enum | 目標狀態 | |
| `comment` | text | 備註 | |
| `snapshot` | jsonb | 資料快照 | 異動內容 |
| `created_at` | timestamptz | 時間 | |

**索引**：
- `claim_history_claim_id_idx` ON (claim_id)
- `claim_history_created_at_idx` ON (created_at DESC)

---

### 2.6 vendors (廠商主檔)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `name` | varchar(200) | 廠商名稱 | 唯一 |
| `service_description` | text | 服務內容 | |
| `bank_code` | varchar(10) | 銀行代碼 | 加密儲存 |
| `bank_name` | varchar(50) | 銀行名稱 | |
| `bank_account` | varchar(20) | 銀行帳號 | 加密儲存 |
| `is_floating_account` | boolean | 浮動帳號 | 虛擬帳號使用 |
| `status` | enum | 狀態 | pending/approved/disabled |
| `created_at` | timestamptz | 建立時間 | |
| `updated_at` | timestamptz | 更新時間 | |

**索引**：
- `vendors_name_idx` ON (name)
- `vendors_status_idx` ON (status)

---

### 2.7 vendor_change_requests (廠商異動申請)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `vendor_id` | uuid | 廠商 | FK → vendors.id (新增時為 null) |
| `change_type` | enum | 異動類型 | create/update/disable |
| `requested_by` | uuid | 申請人 | FK → users.id |
| `reviewed_by` | uuid | 審核人 | FK → users.id |
| `status` | enum | 狀態 | pending/approved/rejected |
| `reason` | text | 申請原因 | |
| `review_comment` | text | 審核意見 | |
| `before_snapshot` | jsonb | 異動前資料 | |
| `after_snapshot` | jsonb | 異動後資料 | |
| `created_at` | timestamptz | 申請時間 | |
| `reviewed_at` | timestamptz | 審核時間 | |

---

### 2.8 payments (付款單)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `payment_number` | varchar(20) | 付款單號 | 唯一 |
| `payee_type` | enum | 付款對象類型 | employee/vendor/personal |
| `payee_id` | uuid | 付款對象 ID | users.id 或 vendors.id |
| `payee_name` | varchar(200) | 付款對象名稱 | |
| `total_amount` | decimal(12,2) | 付款總額 | |
| `bank_code` | varchar(10) | 銀行代碼 | |
| `bank_account` | varchar(20) | 銀行帳號 | |
| `status` | enum | 狀態 | completed/cancelled |
| `paid_by` | uuid | 付款執行者 | FK → users.id |
| `paid_at` | timestamptz | 付款時間 | |
| `cancelled_at` | timestamptz | 取消時間 | |
| `created_at` | timestamptz | 建立時間 | |

---

### 2.10 expense_categories (費用類別)

| 欄位 | 型別 | 說明 | 備註 |
|-----|------|------|------|
| `id` | uuid | 主鍵 | |
| `name` | varchar(50) | 類別名稱 | 唯一 |
| `is_active` | boolean | 啟用中 | |
| `sort_order` | int | 排序 | |
| `created_at` | timestamptz | 建立時間 | |

---

## 3. Row Level Security (RLS) 策略

### 3.1 claims 表

```sql
-- 申請人：只能看自己的單據
CREATE POLICY "applicants_own_claims" ON claims
  FOR ALL USING (applicant_id = auth.uid());

-- 主管：可以看待審核的單據 (需進一步過濾是自己團隊的)
CREATE POLICY "managers_pending_claims" ON claims
  FOR SELECT USING (
    status = 'pending_manager' 
    AND EXISTS (
      SELECT 1 FROM users 
      WHERE id = claims.applicant_id 
      AND approver_id = auth.uid()
    )
  );

-- 財務：可以看所有待財務處理的單據
CREATE POLICY "finance_all_claims" ON claims
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM users 
      WHERE id = auth.uid() 
      AND role IN ('finance', 'admin')
    )
  );
```

---

## 4. 加密欄位處理

敏感欄位使用 PostgreSQL `pgcrypto` 加密：

```sql
-- 加密
UPDATE users SET bank_account = pgp_sym_encrypt(
  '123456789', 
  current_setting('app.encryption_key')
);

-- 解密
SELECT pgp_sym_decrypt(
  bank_account::bytea, 
  current_setting('app.encryption_key')
) FROM users;
```

**加密欄位清單**：
- `users.bank_code`, `users.bank_account`
- `vendors.bank_code`, `vendors.bank_account`
- `claims.payee_id_number`, `claims.payee_bank_code`, `claims.payee_bank_account` (個人勞務)

---

## 5. 索引策略摘要

| 表格 | 索引 | 用途 |
|-----|------|------|
| claims | applicant_id | 查詢「我的請款」 |
| claims | status | 依狀態篩選 |
| claims | created_at DESC | 時間排序 |
| claim_items | claim_id | 關聯查詢 |
| claim_items | invoice_number | 重複發票檢查 |
| claim_history | claim_id + created_at | 審核軌跡查詢 |
| vendors | name | 廠商搜尋 |
