# 03_資料庫與資料規約

> 最後更新：2026-02-20  
> 來源依據：目前 Supabase 實際 schema + 專案程式碼（server actions / RPC 呼叫）  
> 備註：開發階段 migration 已收斂為單一檔案

---

## 1. 當前資料模型（摘要）

- `profiles`：使用者、角色、核准人、個人銀行資訊
- `claims`：請款主檔（狀態機、收款對象、浮動帳號）
- `claim_items`：請款明細（含憑證決策、附件 metadata）
- `claim_history`：狀態變更歷程
- `payees`：收款人主檔（廠商/個人；統編明文、身分證加密）
- `payee_change_requests`：收款人異動申請
- `payments`：付款單與撤銷撥款紀錄
- `system_config`：系統設定（含加密金鑰）

---

## 2. 主要資料表定義（當前）

### 2.1 `profiles`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | uuid | PK，對應 `auth.users.id` |
| `full_name` | text | 使用者名稱 |
| `approver_id` | uuid | 核准人 |
| `is_finance` / `is_admin` | bool | 角色旗標 |
| `is_active` | bool | 啟用狀態 |
| `email` | text | 使用者信箱 |
| `bank` | varchar | 銀行代碼+名稱（如 `007-第一銀行`） |
| `bank_account` | bytea | 加密帳號 |
| `bank_account_tail` | text | 帳號末碼（遮罩顯示） |
| `deactivated_at/by/reason` | timestamptz/uuid/text | 停用資訊 |
| `created_at` / `updated_at` | timestamptz | 時間戳 |

### 2.2 `claims`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | varchar(8) | PK，短碼 ID |
| `claim_type` | enum | `employee` / `vendor` / `personal_service` |
| `status` | enum | 見狀態機 |
| `applicant_id` | uuid | 申請人 |
| `payee_id` | uuid nullable | 收款人（員工報銷可為空） |
| `payment_id` | varchar(8) nullable | 關聯付款單 |
| `description` | text nullable | 主檔說明（仍存在） |
| `total_amount` | numeric | 總金額 |
| `bank_code` | text nullable | 浮動帳號銀行代碼 |
| `bank_account` | bytea nullable | 浮動帳號加密帳號 |
| `pay_first_patch_doc` | bool | 先付款後補件 |
| `last_comment` | text nullable | 最後一次審核註記 |
| `submitted_at` / `created_at` / `updated_at` | timestamptz | 時間戳 |

### 2.3 `claim_items`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | uuid | PK |
| `claim_id` | varchar(8) | FK → claims |
| `item_index` | int | 明細排序 |
| `category` | text | 費用類別 |
| `description` | text | 明細說明 |
| `amount` | numeric | 金額 |
| `invoice_number` | text nullable | 發票號碼 |
| `date_start` / `date_end` | date nullable | 日期（個人勞務用區間） |
| `attachment_status` | enum | `uploaded` / `pending_supplement` / `exempt` |
| `extra` | jsonb | 附件或無憑證理由等資料 |

> 已移除：`attachment_id`（由 `extra.file_path` 承載）

### 2.4 `claim_history`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | uuid | PK |
| `claim_id` | varchar(8) | FK → claims |
| `actor_id` | uuid | 執行者 |
| `action` | text | submit/approve/reject/pay/withdraw... |
| `from_status` / `to_status` | claim_status | 狀態轉移 |
| `comment` | text nullable | 備註 |
| `created_at` | timestamptz | 時間戳 |

### 2.5 `payees`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | uuid | PK |
| `type` | enum | `employee` / `vendor` / `personal` |
| `name` | text | 收款人名稱 |
| `status` | enum | `pending_add/pending_update/pending_disable/available/disabled` |
| `bank` | varchar nullable | 銀行代碼+名稱 |
| `bank_account` | bytea nullable | 加密帳號 |
| `bank_account_tail` | text nullable | 末碼 |
| `editable_account` | bool | 非固定帳號（僅廠商） |
| `unified_no` | text nullable | 統編（廠商，明文） |
| `national_id` | bytea nullable | 身分證（個人，加密） |
| `service_description` | text nullable | 服務說明 |
| `attachments` | jsonb | 附件資訊 |
| `extra_info` | jsonb | 額外資料（email/address...） |
| `created_at` / `updated_at` | timestamptz | 時間戳 |

> 已移除：`tax_id`、`national_id_tail`

### 2.6 `payee_change_requests`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | uuid | PK |
| `payee_id` | uuid nullable | 既有收款人（create 可為空） |
| `change_type` | enum | `create/update/disable` |
| `status` | enum | `pending/approved/rejected/withdrawn` |
| `requested_by` / `reviewed_by` | uuid | 申請/審核人 |
| `reason` / `reject_reason` | text | 原因/駁回原因 |
| `proposed_data` | jsonb | 非敏感異動資料 |
| `proposed_unified_no` | text nullable | 提案統編（明文） |
| `proposed_national_id` | bytea nullable | 提案身分證（加密） |
| `proposed_bank_account` | bytea nullable | 提案銀行帳號（加密） |
| `proposed_bank_account_tail` | text nullable | 提案帳號末碼 |
| `proposed_attachments` | jsonb | 提案附件 |
| `created_at` / `reviewed_at` | timestamptz | 時間戳 |

> 已移除：`proposed_tax_id`、`proposed_national_id_tail`

### 2.7 `payments`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `id` | varchar(8) | PK，短碼 ID |
| `payee_id` | uuid | 收款人 |
| `payee_name` | text | 收款人名稱快照 |
| `bank` | varchar | 銀行快照 |
| `bank_account` | bytea | 加密帳號快照 |
| `total_amount` | numeric | 付款金額 |
| `status` | enum | `completed/cancelled` |
| `paid_by` | uuid | 經辦人 |
| `paid_at` / `cancelled_at` / `created_at` | timestamptz | 時間戳 |

### 2.8 `system_config`

| 欄位 | 型別 | 說明 |
|---|---|---|
| `key` | text | PK |
| `value` | text | 設定值（含加密金鑰來源） |

---

## 3. 請款狀態機（claim_status）

`draft → pending_manager → pending_finance → pending_payment → paid`

補件相關：
- `pending_payment → paid_pending_doc`
- `paid_pending_doc → pending_doc_review → paid`

其他：
- 駁回：`* → returned`
- 撤回：`pending_manager → draft`
- 取消：`* → cancelled`（依權限與流程）

---

## 4. 敏感資料與加密規則

- 加密（bytea）：
  - `profiles.bank_account`
  - `claims.bank_account`
  - `payees.bank_account`
  - `payees.national_id`
  - `payee_change_requests.proposed_bank_account`
  - `payee_change_requests.proposed_national_id`
  - `payments.bank_account`
- 明文：
  - `payees.unified_no`
  - `payee_change_requests.proposed_unified_no`

解密路徑以 `public.get_crypto_key()` 為主，並在部分 reveal RPC 內含 backward-compatible fallback。

---

## 5. 目前使用中的核心 RPC

- `create_claim(...)`
  - 目前保留 2 個簽名（含 `_description` 與不含 `_description`）
- `update_claim(_claim_id, _payee_id, _total_amount, _bank_code, _bank_account, _pay_first_patch_doc)`
- `get_claim_detail(_claim_id)`
- `submit_payee_change_request(...)`
- `approve_payee_change_request(_request_id)`
- `reject_payee_change_request(_request_id)`（既有流程使用）
- `reveal_profile_bank_account(_profile_id)`
- `reveal_payee_bank_account(_payee_id)`
- `reveal_payee_tax_id(_payee_id)`
- `reveal_payee_change_request_bank_account(_request_id)`
- `reveal_payee_change_request_tax_id(_request_id)`
- `update_profile_bank_account(...)`
- `get_crypto_key()`

---

## 6. Migration 策略（開發階段）

目前 repo 內 `supabase/migrations` 已收斂為單一檔：

- `/Users/candoyeh/Downloads/報銷系統/報銷_new/supabase/migrations/20260220012000_consolidate_current_schema.sql`

說明：
- 用於將 schema、RPC、敏感欄位與授權一次對齊到現行程式
- 適合開發期重整環境

---

## 7. 與前端行為對應的資料規約

- 員工報銷：收款人預設申請人；銀行資訊帶入 `profiles.bank` + `profiles.bank_account`
- 廠商請款 / 個人勞務：收款人自 `payees` 選擇
- `editable_account=true` 的廠商可在請款單覆寫 `claims.bank_code/bank_account`
- 個人勞務：固定單筆明細、無憑證流程
- 一般明細憑證決策：
  - `uploaded`：需有附件
  - `pending_supplement`：待補件
  - `exempt`：需填無憑證原因（放在 `claim_items.extra`）

---

## 8. 文件維護規則

- 若文件與系統不一致，以「DB 實際 schema + 程式碼」為準
- 變更下列任一項時，需同步更新本文件：
  - table 欄位
  - enum 狀態
  - RPC 參數或回傳
  - 加密欄位策略
