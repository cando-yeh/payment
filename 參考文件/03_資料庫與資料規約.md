# 03_è³‡æ–™åº«èˆ‡è³‡æ–™è¦ç´„

> å½™æ•´æ–‡ä»¶ï¼šè³‡æ–™åº«è¨­è¨ˆæ–‡ä»¶ã€è³‡æ–™æ“ä½œè¦æ ¼è¡¨ã€éŠ€è¡Œä»£ç¢¼å°ç…§è¡¨  
> æœ€å¾Œæ›´æ–°ï¼š2026-02-11  
> è³‡æ–™åº«ï¼šPostgreSQL (Supabase)

---

## ğŸ“– ç›®éŒ„

- [1. è³‡æ–™æ¨¡å‹æ¦‚è¦½](#1-è³‡æ–™æ¨¡å‹æ¦‚è¦½)
- [2. è³‡æ–™è¡¨å®šç¾©](#2-è³‡æ–™è¡¨å®šç¾©)
    - [2.1 profiles (å“¡å·¥è³‡è¨Šè¡¨)](#21-profiles-å“¡å·¥è³‡è¨Šè¡¨)
    - [2.2 claims (è«‹æ¬¾å–®ä¸»æª”)](#22-claims-è«‹æ¬¾å–®ä¸»æª”)
    - [2.3 claim_items (è«‹æ¬¾æ˜ç´°)](#23-claim_items-è«‹æ¬¾æ˜ç´°)
    - [2.4 claim_history (å¯©æ ¸æ­·ç¨‹)](#24-claim_history-å¯©æ ¸æ­·ç¨‹)
    - [2.5 payees (å—æ¬¾äººä¸»æª”)](#25-payees-å—æ¬¾äººä¸»æª”)
    - [2.6 payee_change_requests (å—æ¬¾äººç•°å‹•ç”³è«‹)](#26-payee_change_requests-å—æ¬¾äººç•°å‹•ç”³è«‹)
    - [2.7 payments (ä»˜æ¬¾å–®)](#27-payments-ä»˜æ¬¾å–®)
    - [2.8 expense_categories (è²»ç”¨é¡åˆ¥)](#28-expense_categories-è²»ç”¨é¡åˆ¥)
- [3. Row Level Security (RLS) ç­–ç•¥](#3-row-level-security-rls-ç­–ç•¥)
- [4. è‡ªå‹•åŒ–è§¸ç™¼å™¨ (Triggers)](#4-è‡ªå‹•åŒ–è§¸ç™¼å™¨-triggers)
- [5. åŠ å¯†æ¬„ä½è™•ç†](#5-åŠ å¯†æ¬„ä½è™•ç†)
- [6. ç´¢å¼•ç­–ç•¥æ‘˜è¦](#6-ç´¢å¼•ç­–ç•¥æ‘˜è¦)
- [7. è³‡æ–™æ“ä½œè¦æ ¼ (API)](#7-è³‡æ–™æ“ä½œè¦æ ¼-api)
    - [7.1 èªè­‰æ¨¡çµ„ (Auth)](#71-èªè­‰æ¨¡çµ„-auth)
    - [7.2 ä½¿ç”¨è€…æ¨¡çµ„ (Users)](#72-ä½¿ç”¨è€…æ¨¡çµ„-users)
    - [7.3 è«‹æ¬¾å–®æ¨¡çµ„ (Claims)](#73-è«‹æ¬¾å–®æ¨¡çµ„-claims)
    - [7.4 å¯©æ ¸æ¨¡çµ„ (Approval)](#74-å¯©æ ¸æ¨¡çµ„-approval)
    - [7.5 ä»˜æ¬¾æ¨¡çµ„ (Payments)](#75-ä»˜æ¬¾æ¨¡çµ„-payments)
    - [7.6 è£œä»¶æ¨¡çµ„ (Document Supplement)](#76-è£œä»¶æ¨¡çµ„-document-supplement)
    - [7.7 å» å•†æ¨¡çµ„ (Vendors)](#77-å» å•†æ¨¡çµ„-vendors)
    - [7.8 æ†‘è­‰æ¨¡çµ„ (Attachments)](#78-æ†‘è­‰æ¨¡çµ„-attachments)
    - [7.9 è²»ç”¨é¡åˆ¥æ¨¡çµ„ (Categories)](#79-è²»ç”¨é¡åˆ¥æ¨¡çµ„-categories)
    - [7.10 ç™¼ç¥¨é‡è¤‡æª¢æŸ¥](#710-ç™¼ç¥¨é‡è¤‡æª¢æŸ¥)
- [8. é€šç”¨è³‡æ–™çµæ§‹ (TypeScript)](#8-é€šç”¨è³‡æ–™çµæ§‹-typescript)
- [9. éŠ€è¡Œä»£ç¢¼å°ç…§è¡¨](#9-éŠ€è¡Œä»£ç¢¼å°ç…§è¡¨)

---

## 1. è³‡æ–™æ¨¡å‹æ¦‚è¦½

```mermaid
%%{init: { 'flowchart': { 'nodeSpacing': 50, 'rankSpacing': 80 }, 'themeVariables': { 'fontSize': '28px', 'fontFamily': 'arial' } } }%%
graph TD
    Profiles[profiles<br/>ä½¿ç”¨è€…è³‡æ–™]:::mainStyle
    Claims[claims<br/>è«‹æ¬¾å–®ä¸»è¡¨]:::mainStyle
    Items[claim_items<br/>è«‹æ¬¾æ˜ç´°]:::mainStyle
    History[claim_history<br/>å¯©æ ¸æ­·ç¨‹]:::subStyle
    Payments[payments<br/>ä»˜æ¬¾å–®]:::subStyle
    Payees[payees<br/>å—æ¬¾äºº/å» å•†]:::mainStyle
    PayeeChanges[payee_change_requests<br/>å—æ¬¾äººç•°å‹•ç”³è«‹]:::subStyle
    Categories[expense_categories<br/>è²»ç”¨é¡åˆ¥]:::subStyle

    %% é—œè¯é—œä¿‚
    Profiles -- "1:N<br/>ç”³è«‹äºº/æ ¸å‡†äºº" --> Claims
    Claims -- "1:N" --> Items
    Claims -- "1:N" --> History
    Claims -- "N:1" --> Payments
    Claims -- "N:1<br/>å» å•†è«‹æ¬¾" --> Payees
    
    Items -- "N:1" --> Categories
    
    Profiles -- "1:N<br/>ç•°å‹•ç”³è«‹äºº/å¯©æ ¸äºº" --> PayeeChanges
    Payees -- "1:N" --> PayeeChanges

    %% æ¨£å¼å®šç¾©
    classDef mainStyle fill:#ffffff,stroke:#333,stroke-width:2px,color:#000;
    classDef subStyle fill:#f8fafc,stroke:#64748b,stroke-width:1px,color:#475569;

    style Profiles stroke-width:3px
```

**é—œè¯èªªæ˜**ï¼š
- ä¸€å€‹ã€Œä»˜æ¬¾å–®ã€å¯åŒ…å«å¤šå€‹ã€Œè«‹æ¬¾å–®ã€ (æ‰¹æ¬¡ä»˜æ¬¾)
- ä¸€å€‹ã€Œè«‹æ¬¾å–®ã€åƒ…å±¬æ–¼ä¸€å€‹ã€Œä»˜æ¬¾å–®ã€
- ç›´æ¥é€é `claims.payment_id` å¤–éµå»ºç«‹ä¸€å°å¤šé—œä¿‚ (ç„¡éœ€é—œè¯è¡¨)

---

## 2. è³‡æ–™è¡¨å®šç¾©

### 2.1 profiles (å“¡å·¥è³‡è¨Šè¡¨)

> è·è²¬ï¼šæ“´å…… Supabase Auth çš„ä½¿ç”¨è€…è³‡è¨Šï¼Œå„²å­˜å·¥è™Ÿèˆ‡è§’è‰²ã€‚

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | FK â†’ auth.users.id |
| `full_name` | text | å§“å | |
| `is_finance` | boolean | è²¡å‹™æ¬Šé™ | é è¨­ false |
| `is_admin` | boolean | ç®¡ç†å“¡æ¬Šé™ | é è¨­ false |
| `approver_id` | uuid | æ ¸å‡†äºº | FK â†’ profiles.id |
| `bank` | varchar(20) | å‚³å¸³éŠ€è¡Œ | æ ¼å¼: ä»£ç¢¼-åç¨± (å¦‚ 004-å°ç£éŠ€è¡Œ) |
| `bank_account` | bytea | å‚³å¸³å¸³è™Ÿ | åŠ å¯†å„²å­˜ï¼Œé¦–æ¬¡ç™»å…¥å¡«å¯«ï¼Œå¾ŒçºŒåƒ…ç®¡ç†å“¡å¯ä¿®æ”¹ |
| `avatar_url` | text | å¤§é ­è²¼ | |
| `created_at` | timestamptz | å»ºç«‹æ™‚é–“ | |
| `updated_at` | timestamptz | æ›´æ–°æ™‚é–“ | |

**ç´¢å¼•**ï¼š
- `profiles_approver_id_idx` ON (approver_id)

---

### 2.2 claims (è«‹æ¬¾å–®ä¸»æª”)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | varchar(8) | ä¸»éµ | 8 ç¢¼éš¨æ©Ÿè‹±æ•¸å­—è­˜åˆ¥ç¢¼ |
| `claim_type` | enum | é¡åˆ¥ | employee/vendor/personal_service |
| `status` | enum | ç‹€æ…‹ | è¦‹ç‹€æ…‹åˆ—èˆ‰ |
| `applicant_id` | uuid | ç”³è«‹äºº | FK â†’ profiles.id |
| `payee_id` | uuid | å¤–éƒ¨å—æ¬¾äºº | FK â†’ payees.id (NULL å‰‡ç‚ºç”³è«‹äººæœ¬äºº) |
| `payment_id` | uuid | ä»˜æ¬¾å–® | FK â†’ payments.id (ä»˜æ¬¾å¾Œå›å¡«) |
| `total_amount` | decimal(12,0) | ç¸½é‡‘é¡ | æ±‚å’Œ claim_items |
| `submitted_at` | timestamptz | é€å‡ºæ™‚é–“ | |
| `created_at` | timestamptz | å»ºç«‹æ™‚é–“ | |
| `updated_at` | timestamptz | æ›´æ–°æ™‚é–“ | |

*(è¨»ï¼šæ¡æ–¹æ¡ˆ C è¨­è¨ˆã€‚å“¡å·¥å€‹äººå ±éŠ·æ™‚ payee_id ç‚ºç©ºï¼›å§”å¤–å» å•†æˆ–å€‹äººå‹å‹™å‰‡é€£çµè‡³å—æ¬¾äººä¸»æª”)*

**è«‹æ¬¾å–®ç‹€æ…‹åˆ—èˆ‰ (claim_status)**ï¼š
```sql
CREATE TYPE claim_status AS ENUM (
  'draft',              -- è‰ç¨¿
  'pending_manager',    -- ä¸»ç®¡å¯©æ ¸
  'pending_finance',    -- è²¡å‹™å¯©æ ¸
  'pending_payment',    -- å¾…ä»˜æ¬¾
  'paid',               -- ä»˜æ¬¾å®Œæˆ
  'paid_pending_doc',   -- ä»˜æ¬¾å®Œæˆ(å¾…è£œä»¶)
  'pending_doc_review', -- è£œä»¶å¯©æ ¸
  'returned',           -- å·²é€€å›
  'cancelled'           -- å·²æ’¤éŠ·
);
```

**ç´¢å¼•**ï¼š
- `claims_applicant_id_idx` ON (applicant_id)
- `claims_payee_id_idx` ON (payee_id)
- `claims_status_idx` ON (status)
- `claims_created_at_idx` ON (created_at DESC)
- `claims_payment_id_idx` ON (payment_id)

---

### 2.3 claim_items (è«‹æ¬¾æ˜ç´°)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | |
| `claim_id` | varchar(8) | è«‹æ¬¾å–® | FK â†’ claims.id |
| `item_index` | int | é …ç›®åºè™Ÿ | |
| `date_start` | date | ç™¼ç¥¨/é–‹å§‹æ—¥ | å“¡å·¥/å» å•†å ±éŠ· = ç™¼ç¥¨æ—¥æœŸ |
| `date_end` | date | äº¤æ˜“çµæŸæ—¥ | å“¡å·¥/å» å•†å ±éŠ· = NULL |
| `category` | varchar(10) | è²»ç”¨é¡åˆ¥ | |
| `description` | text | èªªæ˜ | |
| `amount` | decimal(12,0) | é‡‘é¡ | |
| `invoice_number` | varchar(10) | ç™¼ç¥¨è™Ÿç¢¼ | |
| `attachment_id` | uuid | æ†‘è­‰ ID | |
| `attachment_status` | enum | æ†‘è­‰ç‹€æ…‹ | uploaded/exempt/pending_supplement |
| `extra` | jsonb | é¡å¤–è³‡è¨Š | no_evidence_reason: å…é™„åŸå›  (status=exempt æ™‚), file_path/original_name: æ†‘è­‰æª”æ¡ˆè³‡è¨Š |

**ç´¢å¼•**ï¼š
- `claim_items_claim_id_idx` ON (claim_id)
- `claim_items_invoice_number_idx` ON (invoice_number)

---

### 2.4 claim_history (å¯©æ ¸æ­·ç¨‹)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | |
| `claim_id` | varchar(8) | è«‹æ¬¾å–® | FK â†’ claims.id |
| `actor_id` | uuid | åŸ·è¡Œè€… | FK â†’ profiles.id |
| `action` | varchar(10) | å‹•ä½œ | submit/approve/reject/withdraw... |
| `from_status` | enum | ä¾†æºç‹€æ…‹ | |
| `to_status` | enum | ç›®æ¨™ç‹€æ…‹ | |
| `comment` | text | å‚™è¨» | |
| `created_at` | timestamptz | æ™‚é–“ | |

**ç´¢å¼•**ï¼š
- `claim_history_claim_id_idx` ON (claim_id)
- `claim_history_created_at_idx` ON (created_at DESC)

---

### 2.5 payees (å—æ¬¾äººä¸»æª”)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | |
| `type` | enum | å—æ¬¾äººé¡å‹ | vendor/personal |
| `name` | varchar(20) | åç¨± | å…¬å¸åæˆ–å€‹äººå§“å |
| `tax_id` | bytea | çµ±ç·¨/èº«åˆ†è­‰ | åŠ å¯†å„²å­˜ |
| `bank` | varchar(20) | éŠ€è¡Œ | æ ¼å¼: ä»£ç¢¼-åç¨± (å¦‚ 004-å°ç£éŠ€è¡Œ) |
| `bank_account` | bytea | éŠ€è¡Œå¸³è™Ÿ | åŠ å¯†å„²å­˜ |
| `service_description` | text | æœå‹™å…§å®¹ | |
| `extra_info` | jsonb | é¡å‹å°ˆå±¬è³‡æ–™ | vendor: {is_floating_account}, personal: {email, address} |
| `status` | enum | ç‹€æ…‹ | pending_add/pending_update/pending_disable/available/disabled |
| `created_at` | timestamptz | å»ºç«‹æ™‚é–“ | |
| `updated_at` | timestamptz | æ›´æ–°æ™‚é–“ | |

**ç´¢å¼•**ï¼š
- `payees_name_idx` ON (name)
- `payees_status_idx` ON (status)
- `payees_type_idx` ON (type)

---

### 2.6 payee_change_requests (å—æ¬¾äººç•°å‹•ç”³è«‹)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | |
| `payee_id` | uuid | å—æ¬¾äºº | FK â†’ payees.id (æ–°å¢æ™‚ç‚º null) |
| `change_type` | enum | ç•°å‹•é¡å‹ | create/update/disable |
| `requested_by` | uuid | ç”³è«‹äºº | FK â†’ profiles.id |
| `reviewed_by` | uuid | å¯©æ ¸äºº | FK â†’ profiles.id |
| `status` | enum | ç‹€æ…‹ | pending/approved/rejected |
| `reason` | text | ç”³è«‹åŸå›  | |
| `reject_reason` | text | é§å›åŸå›  | |
| `proposed_data` | jsonb | ç•°å‹•æ¬„ä½ | åªå«æœ‰ç•°å‹•çš„éæ•æ„Ÿæ¬„ä½ |
| `proposed_bank_account` | bytea | æ–°éŠ€è¡Œå¸³è™Ÿ | åŠ å¯†å„²å­˜ï¼Œæœ‰ç•°å‹•æ™‚æ‰å¡« |
| `created_at` | timestamptz | ç”³è«‹æ™‚é–“ | |
| `reviewed_at` | timestamptz | å¯©æ ¸æ™‚é–“ | |

---

### 2.7 payments (ä»˜æ¬¾å–®)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | UUID ä½œç‚ºå”¯ä¸€è­˜åˆ¥ç¢¼ |
| `payee_id` | uuid | å¤–éƒ¨å—æ¬¾äºº ID | FK â†’ payees.id (NULL å‰‡ç‚ºå“¡å·¥æœ¬äºº) |
| `payee_name` | varchar(20) | å—æ¬¾å°è±¡åç¨± | å†—é¤˜å„²å­˜ä»¥ä¾¿å¿«é€Ÿæª¢è¦– |
| `total_amount` | decimal(12,0) | ä»˜æ¬¾ç¸½é¡ | |
| `bank` | varchar(20) | å‚³å¸³éŠ€è¡Œ | ä»˜æ¬¾ç•¶ä¸‹å¿«ç…§ |
| `bank_account` | bytea | å‚³å¸³å¸³è™Ÿ | åŠ å¯†å„²å­˜ï¼Œä»˜æ¬¾ç•¶ä¸‹å¿«ç…§ |
| `status` | enum | ç‹€æ…‹ | completed/cancelled |
| `paid_by` | uuid | ä»˜æ¬¾åŸ·è¡Œè€… | FK â†’ profiles.id |
| `paid_at` | timestamptz | ä»˜æ¬¾æ™‚é–“ | |
| `cancelled_at` | timestamptz | å–æ¶ˆæ™‚é–“ | |
| `created_at` | timestamptz | å»ºç«‹æ™‚é–“ | |

---

### 2.8 expense_categories (è²»ç”¨é¡åˆ¥)

| æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | å‚™è¨» |
|-----|------|------|------|
| `id` | uuid | ä¸»éµ | |
| `name` | varchar(50) | é¡åˆ¥åç¨± | å”¯ä¸€ |
| `is_active` | boolean | å•Ÿç”¨ä¸­ | |
| `updated_at` | timestamptz | æ›´æ–°æ™‚é–“ | |
| `created_at` | timestamptz | å»ºç«‹æ™‚é–“ | |

---

## 3. Row Level Security (RLS) ç­–ç•¥

### 3.1 æ¬Šé™è¼”åŠ©å‡½æ•¸ (Security Definer)

ç‚ºäº†é¿å… RLS éè¿´ä¸¦æé«˜æ•ˆèƒ½ï¼Œä½¿ç”¨ `SECURITY DEFINER` å‡½æ•¸ä¾†æª¢æŸ¥è§’è‰²æ¬Šé™ï¼š

```sql
-- æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS boolean AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles 
    WHERE id = auth.uid() AND is_admin = true
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- æª¢æŸ¥æ˜¯å¦ç‚ºè²¡å‹™äººå“¡
CREATE OR REPLACE FUNCTION public.is_finance()
RETURNS boolean AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles 
    WHERE id = auth.uid() AND is_finance = true
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 3.2 æ ¸å¿ƒ RLS æ”¿ç­–

```sql
-- =============================================
-- profiles (å“¡å·¥è³‡è¨Šè¡¨)
-- =============================================
-- æœ¬äººå¯è®€è‡ªå·±çš„è³‡æ–™
CREATE POLICY "profiles_individual_read" ON profiles 
    FOR SELECT USING (auth.uid() = id);

-- æœ¬äººå¯æ›´æ–°è‡ªå·±çš„è³‡æ–™ (é¦–æ¬¡å¡«å¯«éŠ€è¡Œå¸³è™Ÿï¼Œå¾ŒçºŒä¿®æ”¹éœ€ç®¡ç†å“¡)
CREATE POLICY "profiles_individual_update" ON profiles 
    FOR UPDATE USING (auth.uid() = id);

-- ç®¡ç†å“¡å¯ç®¡ç†æ‰€æœ‰ profile
CREATE POLICY "profiles_admin_all" ON profiles 
    FOR ALL USING (public.is_admin());

-- =============================================
-- claims (è«‹æ¬¾å–®)
-- =============================================
-- ç”³è«‹äººï¼šå¯å®Œå…¨ç®¡ç†è‡ªå·±çš„è«‹æ¬¾å–®
CREATE POLICY "claims_applicant" ON claims 
    FOR ALL USING (auth.uid() = applicant_id);

-- ä¸»ç®¡ï¼šå¯è®€å–ä¸‹å±¬çš„è«‹æ¬¾å–®
CREATE POLICY "claims_approver_read" ON claims 
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM profiles 
            WHERE profiles.id = claims.applicant_id 
            AND profiles.approver_id = auth.uid()
        )
    );

-- ä¸»ç®¡ï¼šå¯æ›´æ–°ä¸‹å±¬çš„è«‹æ¬¾å–® (æ ¸å‡†/é€€å›)
CREATE POLICY "claims_approver_update" ON claims 
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM profiles 
            WHERE profiles.id = claims.applicant_id 
            AND profiles.approver_id = auth.uid()
        )
    );

-- è²¡å‹™ï¼šå¯è®€å–æ‰€æœ‰è«‹æ¬¾å–®
CREATE POLICY "claims_finance_read" ON claims 
    FOR SELECT USING (public.is_finance());

-- è²¡å‹™ï¼šå¯æ›´æ–°æ‰€æœ‰è«‹æ¬¾å–®ç‹€æ…‹ (æ ¸å‡†/é§å›/ä»˜æ¬¾)
CREATE POLICY "claims_finance_update" ON claims 
    FOR UPDATE USING (public.is_finance());

-- =============================================
-- claim_items (è«‹æ¬¾æ˜ç´°)
-- =============================================
-- ç”³è«‹äººï¼šå¯ç®¡ç†è‡ªå·±è«‹æ¬¾å–®çš„æ˜ç´°
CREATE POLICY "items_applicant" ON claim_items 
    FOR ALL USING (
        EXISTS (SELECT 1 FROM claims WHERE claims.id = claim_items.claim_id AND claims.applicant_id = auth.uid())
    );

-- ä¸»ç®¡ï¼šå¯è®€å–ä¸‹å±¬è«‹æ¬¾å–®çš„æ˜ç´°
CREATE POLICY "items_approver_read" ON claim_items 
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM claims 
            JOIN profiles ON profiles.id = claims.applicant_id
            WHERE claims.id = claim_items.claim_id 
            AND profiles.approver_id = auth.uid()
        )
    );

-- è²¡å‹™ï¼šå¯è®€å–æ‰€æœ‰æ˜ç´°
CREATE POLICY "items_finance_read" ON claim_items 
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.is_finance = true)
    );

-- =============================================
-- claim_history (å¯©æ ¸æ­·ç¨‹)
-- =============================================
-- ç”³è«‹äººï¼šå¯è®€å–è‡ªå·±è«‹æ¬¾å–®çš„æ­·ç¨‹
CREATE POLICY "history_applicant_read" ON claim_history 
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM claims WHERE claims.id = claim_history.claim_id AND claims.applicant_id = auth.uid())
    );

-- ä¸»ç®¡ï¼šå¯è®€å–ä¸‹å±¬è«‹æ¬¾å–®çš„æ­·ç¨‹
CREATE POLICY "history_approver_read" ON claim_history 
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM claims 
            JOIN profiles ON profiles.id = claims.applicant_id
            WHERE claims.id = claim_history.claim_id 
            AND profiles.approver_id = auth.uid()
        )
    );

-- è²¡å‹™ï¼šå¯è®€å–æ‰€æœ‰æ­·ç¨‹
CREATE POLICY "history_finance_read" ON claim_history 
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.is_finance = true)
    );

-- =============================================
-- payees (å—æ¬¾äººä¸»æª”)
-- =============================================
-- æ‰€æœ‰å“¡å·¥å¯è®€å–
CREATE POLICY "payees_read_all" ON payees 
    FOR SELECT USING (true);

-- (è¨»ï¼šå—æ¬¾äººç•°å‹•å‡é€é payee_change_requests æµç¨‹ï¼Œæ ¸å‡†å¾Œç”± Trigger/Function è‡ªå‹•æ›´æ–° payees è¡¨)

-- =============================================
-- payee_change_requests (å—æ¬¾äººç•°å‹•ç”³è«‹)
-- =============================================
-- ç”³è«‹äººå¯å®Œå…¨ç®¡ç†è‡ªå·±çš„ç”³è«‹ (æ–°å¢/è®€å–/æ›´æ–°/åˆªé™¤)
CREATE POLICY "payee_change_own" ON payee_change_requests 
    FOR ALL USING (requested_by = auth.uid());

-- è²¡å‹™å¯è®€å–æ‰€æœ‰ç”³è«‹
CREATE POLICY "payee_change_read_finance" ON payee_change_requests 
    FOR SELECT USING (
        EXISTS (SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.is_finance = true)
    );

-- è²¡å‹™å¯æ›´æ–°ç”³è«‹ (æ ¸å‡†/é§å›)
CREATE POLICY "payee_change_update_finance" ON payee_change_requests 
    FOR UPDATE USING (
        EXISTS (SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.is_finance = true)
    );

-- =============================================
-- payments (ä»˜æ¬¾å–®)
-- =============================================
-- ç”³è«‹äººï¼šå¯è®€å–è‡ªå·±ç›¸é—œçš„ä»˜æ¬¾å–®
CREATE POLICY "payments_applicant_read" ON payments 
    FOR SELECT USING (
        id IN (SELECT payment_id FROM claims WHERE applicant_id = auth.uid())
    );

-- ä¸»ç®¡ï¼šå¯è®€å–ä¸‹å±¬ç›¸é—œçš„ä»˜æ¬¾å–®
CREATE POLICY "payments_approver_read" ON payments 
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM claims 
            JOIN profiles ON profiles.id = claims.applicant_id
            WHERE claims.payment_id = payments.id 
            AND profiles.approver_id = auth.uid()
        )
    );

-- è²¡å‹™ï¼šå¯å®Œå…¨ç®¡ç†ä»˜æ¬¾å–®
CREATE POLICY "payments_finance" ON payments 
    FOR ALL USING (
        EXISTS (SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.is_finance = true)
    );

-- =============================================
-- expense_categories (è²»ç”¨é¡åˆ¥)
-- =============================================
-- æ‰€æœ‰å“¡å·¥å¯è®€å–
CREATE POLICY "categories_read_all" ON expense_categories 
    FOR SELECT USING (true);

-- ç®¡ç†å“¡å¯ç®¡ç†
CREATE POLICY "categories_admin" ON expense_categories 
    FOR ALL USING (
        EXISTS (SELECT 1 FROM profiles p WHERE p.id = auth.uid() AND p.is_admin = true)
    );
```

### 3.3 Storage ç‰©ä»¶æ¬Šé™è£œå…… (storage.objects)

> ä¸‹åˆ—ç‚ºèˆ‡æ†‘è­‰æª”æ¡ˆç›´æ¥ç›¸é—œçš„å®‰å…¨ç­–ç•¥æ‘˜è¦ï¼Œå¯¦éš›ä»¥ migration ç‚ºæº–ï¼š

- `claims` bucketï¼š
  - `SELECT`ï¼šåƒ…ç”³è«‹äººæœ¬äººã€å…¶ä¸»ç®¡éˆã€è²¡å‹™ã€ç®¡ç†å“¡å¯è®€å–
  - `INSERT/UPDATE/DELETE`ï¼šé™å®šè«‹æ¬¾å–®æ“æœ‰è€…èˆ‡å¯ç·¨è¼¯ç‹€æ…‹
- `payees` bucketï¼š
  - `SELECT/UPDATE/DELETE`ï¼šåƒ…æª”æ¡ˆ owner æˆ– `is_finance` / `is_admin`
  - `INSERT`ï¼šç™»å…¥ä½¿ç”¨è€…å¯ä¸Šå‚³ï¼ˆä¾›å—æ¬¾äººç”³è«‹æµç¨‹ä½¿ç”¨ï¼‰

---

## 4. è‡ªå‹•åŒ–è§¸ç™¼å™¨ (Triggers)

### 4.1 ä½¿ç”¨è€…è‡ªå‹•åŒæ­¥ (Auth Sync)

ç•¶æ–°ä½¿ç”¨è€…é€é Google OAuth è¨»å†Šæ™‚ï¼Œæœƒè‡ªå‹•å»ºç«‹å°æ‡‰çš„ `profiles` è¡¨ç´€éŒ„ã€‚

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, full_name, avatar_url, is_admin, is_finance)
    VALUES (
        new.id,
        COALESCE(new.raw_user_meta_data->>'full_name', split_part(new.email, '@', 1)),
        new.raw_user_meta_data->>'avatar_url',
        false, -- æ­£å¼ç’°å¢ƒé è¨­ç‚ºä¸€èˆ¬å“¡å·¥
        false  -- æ­£å¼ç’°å¢ƒé è¨­éè²¡å‹™äººå“¡
    );
    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ç¢ºä¿å…ˆç§»é™¤èˆŠçš„è§¸ç™¼å™¨å†å»ºç«‹ï¼Œé¿å… "already exists" éŒ¯èª¤
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### 4.2 å¯©æ ¸æ­·ç¨‹è‡ªå‹•è¨˜éŒ„ (Claim History)

ç•¶è«‹æ¬¾å–®ç‹€æ…‹è®Šæ›´æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•åœ¨ `claim_history` è¡¨æ’å…¥ä¸€ç­†å¯©æ ¸ç´€éŒ„ï¼Œä¸éœ€æ‡‰ç”¨ç«¯æ‰‹å‹•å¯«å…¥ã€‚

```sql
CREATE OR REPLACE FUNCTION log_claim_status_change()
RETURNS TRIGGER AS $$
BEGIN
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        INSERT INTO claim_history (
            claim_id, actor_id, action, from_status, to_status, created_at
        ) VALUES (
            NEW.id, auth.uid(), 'status_change', OLD.status, NEW.status, now()
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER trigger_claim_status_change
AFTER UPDATE ON claims
FOR EACH ROW EXECUTE FUNCTION log_claim_status_change();
```

---

## 5. åŠ å¯†æ¬„ä½è™•ç†

æ•æ„Ÿæ¬„ä½ä½¿ç”¨ PostgreSQL `pgcrypto` åŠ å¯†ï¼š

> å¯¦å‹™è£œå……ï¼š
> 1. extension å®‰è£æ–¼ `extensions` schemaï¼š`CREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA extensions;`
> 2. ç‚ºé¿å… `SECURITY DEFINER + search_path=public` å‡½æ•¸æ‰¾ä¸åˆ° pgcryptoï¼Œç³»çµ±æä¾› `public.pgp_sym_encrypt/decrypt` wrapper è½‰å‘¼å« `extensions.pgp_sym_*`ã€‚

```sql
-- åŠ å¯†
UPDATE profiles SET bank_account = pgp_sym_encrypt(
  '123456789', 
  current_setting('app.encryption_key')
);

-- è§£å¯†
SELECT pgp_sym_decrypt(
  bank_account::bytea, 
  current_setting('app.encryption_key')
) FROM profiles;
```

**åŠ å¯†æ¬„ä½æ¸…å–®**ï¼š
- `profiles.bank_account`
- `payees.tax_id`, `payees.bank_account`
- `payments.bank_account`
- `payee_change_requests.proposed_bank_account`

---

## 6. ç´¢å¼•ç­–ç•¥æ‘˜è¦

| è¡¨æ ¼ | ç´¢å¼• | ç”¨é€” |
|-----|------|------|
| claims | applicant_id | æŸ¥è©¢ã€Œæˆ‘çš„è«‹æ¬¾ã€ |
| claims | payee_id | æŸ¥è©¢å°è±¡æ­·å² |
| claims | status | ä¾ç‹€æ…‹ç¯©é¸ |
| claims | created_at DESC | æ™‚é–“æ’åº |
| claims | payment_id | ä»˜æ¬¾å–®é—œè¯æŸ¥è©¢ |
| claim_items | claim_id | é—œè¯æŸ¥è©¢ |
| claim_items | invoice_number | é‡è¤‡ç™¼ç¥¨æª¢æŸ¥ |
| claim_history | claim_id + created_at | å¯©æ ¸è»Œè·¡æŸ¥è©¢ |
| payees | name | å°è±¡æœå°‹ |
| payees | status | ç‹€æ…‹ç¯©é¸ |
| payees | type | é¡å‹ç¯©é¸ |

---

## 7. è³‡æ–™æ“ä½œè¦æ ¼ (API)

> èªªæ˜ï¼šå®šç¾©ç³»çµ±ä¸­æ‰€æœ‰è³‡æ–™æ“ä½œçš„è¼¸å…¥/è¼¸å‡ºè¦æ ¼ï¼Œä¾›é–‹ç™¼æ™‚åƒè€ƒ

### 7.1 èªè­‰æ¨¡çµ„ (Auth)

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º |
|------|------|------|------|
| `signInWithGoogle()` | Google OAuth ç™»å…¥ | - | `Session` |
| `signOut()` | ç™»å‡º | - | - |
| `getSession()` | å–å¾—ç›®å‰ Session | - | `Session \| null` |
| `getCurrentUser()` | å–å¾—ç›®å‰ä½¿ç”¨è€…è³‡æ–™ | - | `User` |

---

### 7.2 ä½¿ç”¨è€…æ¨¡çµ„ (Users)

#### è®€å–æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `getUsers()` | å–å¾—ä½¿ç”¨è€…æ¸…å–® | `{ search?, role? }` | `User[]` | Admin |
| `getUserById()` | å–å¾—å–®ä¸€ä½¿ç”¨è€… | `userId` | `User` | Self/Admin |
| `getApproverOptions()` | å–å¾—å¯é¸æ“‡çš„æ ¸å‡†äºº | - | `User[]` | Admin |

#### å¯«å…¥æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `updateProfile()` | æ›´æ–°å€‹äººè³‡æ–™ | `{ name, bank_code, bank_account, ... }` | `User` | Self |
| `assignApprover()` | æŒ‡æ´¾æ ¸å‡†äºº | `{ userId, approverId }` | `User` | Admin |
| `updateUserRole()` | æ›´æ–°ä½¿ç”¨è€…è§’è‰² | `{ userId, role }` | `User` | Admin |

---

### 7.3 è«‹æ¬¾å–®æ¨¡çµ„ (Claims)

#### è®€å–æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `getMyClaims()` | å–å¾—æˆ‘çš„è«‹æ¬¾å–® | `{ status?, type?, dateFrom?, dateTo? }` | `Claim[]` | All |
| `getDraftClaims()` | å–å¾—è‰ç¨¿ | - | `Claim[]` | Self |
| `getPendingClaims()` | å–å¾—è™•ç†ä¸­å–®æ“š | - | `Claim[]` | Self |
| `getReturnedClaims()` | å–å¾—å·²é€€å›å–®æ“š | - | `Claim[]` | Self |
| `getClaimById()` | å–å¾—å–®ä¸€è«‹æ¬¾å–® | `claimId` | `ClaimDetail` | Owner/Approver/Finance |
| `getClaimHistory()` | å–å¾—å¯©æ ¸æ­·ç¨‹ | `claimId` | `ClaimHistory[]` | Owner/Approver/Finance |

#### å¯«å…¥æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `createClaim()` | æ–°å¢è«‹æ¬¾å–® | `ClaimInput` | `Claim` | All |
| `updateClaim()` | æ›´æ–°è«‹æ¬¾å–® (è‰ç¨¿) | `{ claimId, ...ClaimInput }` | `Claim` | Owner (draft only) |
| `deleteClaim()` | åˆªé™¤è«‹æ¬¾å–® | `claimId` | - | Owner (draft only) |
| `submitClaim()` | æäº¤è«‹æ¬¾å–® | `claimId` | `Claim` | Owner |
| `withdrawClaim()` | æ’¤å›è«‹æ¬¾å–® | `claimId` | `Claim` | Owner |
| `resubmitClaim()` | é‡æ–°æäº¤ | `claimId` | `Claim` | Owner (returned) |
| `cancelClaim()` | æ’¤éŠ·è«‹æ¬¾å–® | `claimId` | `Claim` | Owner (returned) |

#### è«‹æ¬¾å–®è¼¸å…¥çµæ§‹

```typescript
// è«‹æ¬¾å–®è¼¸å…¥
interface ClaimInput {
  claim_type: 'employee' | 'vendor' | 'personal_service';
  description: string;
  vendor_id?: string;              // å» å•†è«‹æ¬¾ç”¨
  personal_service_data?: {        // å€‹äººå‹å‹™ç”¨
    name: string;
    id_number: string;
    email: string;
    address: string;
    bank_code: string;
    bank_account: string;
    service_period_start: string;
    service_period_end: string;
  };
  items: ClaimItemInput[];
}

// è«‹æ¬¾æ˜ç´°è¼¸å…¥
interface ClaimItemInput {
  date: string;
  category: string;
  description: string;
  amount: number;
  invoice_number?: string;
  invoice_date?: string;
  no_evidence_flag?: boolean;
  no_evidence_reason?: string;
  attachment?: File;
}
```

---

### 7.4 å¯©æ ¸æ¨¡çµ„ (Approval)

#### è®€å–æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `getPendingApproval()` | å–å¾—å¾…å¯©æ ¸æ¸…å–® (ä¸»ç®¡) | - | `Claim[]` | Manager |
| `getFinanceReview()` | å–å¾—å¾…è²¡å‹™å¯©æ ¸ | - | `Claim[]` | Finance |
| `getPendingPayment()` | å–å¾—å¾…ä»˜æ¬¾æ¸…å–® | - | `Claim[]` | Finance |
| `getDocReview()` | å–å¾—è£œä»¶å¯©æ ¸æ¸…å–® | - | `Claim[]` | Finance |
| `getAllClaims()` | å–å¾—æ‰€æœ‰å–®æ“š | `{ search?, status?, type?, ... }` | `Claim[]` | Finance/Admin |

#### å¯«å…¥æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `approveClaim()` | æ ¸å‡†è«‹æ¬¾å–® | `{ claimId, comment? }` | `Claim` | Manager/Finance |
| `rejectClaim()` | é§å›è«‹æ¬¾å–® | `{ claimId, comment }` | `Claim` | Manager/Finance |
| `approveDoc()` | æ ¸å‡†è£œä»¶ | `{ claimId, comment? }` | `Claim` | Finance |
| `rejectDoc()` | é§å›è£œä»¶ | `{ claimId, comment }` | `Claim` | Finance |

#### ç‹€æ…‹è½‰æ›åœ–

> [!NOTE]
> ç‚ºç¢ºä¿æ¥­å‹™é‚è¼¯çš„ä¸€è‡´æ€§ï¼Œè©³ç´°çš„ç‹€æ…‹æ©Ÿè¦–è¦ºåŒ–æµç¨‹åœ–å·²çµ±ä¸€ç¶­è­·æ–¼ [01_ç”¢å“è—åœ–èˆ‡é–‹ç™¼è¨ˆç•«.md - 1.3.2 æµç¨‹èˆ‡ç‹€æ…‹æ©Ÿå¯è¦–åŒ–](file:///Users/candoyeh/Downloads/å ±éŠ·ç³»çµ±/å ±éŠ·_new/åƒè€ƒæ–‡ä»¶/01_ç”¢å“è—åœ–èˆ‡é–‹ç™¼è¨ˆç•«.md#132-æµç¨‹èˆ‡ç‹€æ…‹æ©Ÿå¯è¦–åŒ–-state-diagram)ã€‚

#### ç‹€æ…‹è½‰æ›å‹•ä½œå°ç…§è¡¨

| å‹•ä½œ | ä¾†æºç‹€æ…‹ | ç›®æ¨™ç‹€æ…‹ | åŸ·è¡Œè€… |
|------|----------|----------|--------|
| submit | draft | pending_manager | ç”³è«‹äºº |
| withdraw | pending_manager | draft | ç”³è«‹äºº |
| withdraw | pending_finance | draft | ç”³è«‹äºº |
| approve | pending_manager | pending_finance | ä¸»ç®¡ |
| reject | pending_manager | returned | ä¸»ç®¡ |
| approve | pending_finance | pending_payment | è²¡å‹™ |
| reject | pending_finance | returned | è²¡å‹™ |
| resubmit | returned | pending_manager | ç”³è«‹äºº |
| cancel | returned | cancelled | ç”³è«‹äºº |
| pay | pending_payment | paid | è²¡å‹™ |
| pay (éœ€è£œä»¶) | pending_payment | paid_pending_doc | è²¡å‹™ |
| submit_doc | paid_pending_doc | pending_doc_review | ç”³è«‹äºº |
| approve | pending_doc_review | paid | è²¡å‹™ |
| reject | pending_doc_review | paid_pending_doc | è²¡å‹™ |
| revoke_approval | pending_payment | pending_finance | è²¡å‹™ |
| cancel_payment | paid | pending_payment | è²¡å‹™ |
| cancel_payment | paid_pending_doc | pending_payment | è²¡å‹™ |

> âš ï¸ **å–æ¶ˆä»˜æ¬¾æ³¨æ„**ï¼šå–æ¶ˆä»˜æ¬¾æ˜¯é‡å°ã€Œä»˜æ¬¾å–®ã€åŸ·è¡Œï¼Œæœƒå°‡è©²ä»˜æ¬¾å–®å…§æ‰€æœ‰è«‹æ¬¾å–®é€€å› `pending_payment`

---

### 7.5 ä»˜æ¬¾æ¨¡çµ„ (Payments)

#### è®€å–æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `getPayments()` | å–å¾—ä»˜æ¬¾å–®æ¸…å–® | `{ status?, dateFrom?, dateTo? }` | `Payment[]` | Finance |
| `getPaymentById()` | å–å¾—ä»˜æ¬¾å–®è©³æƒ… | `paymentId` | `PaymentDetail` | Finance |

#### å¯«å…¥æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `createPayment()` | åŸ·è¡Œä»˜æ¬¾ (å–®ç­†) | `{ claimId, needDoc? }` | `Payment` | Finance |
| `createBatchPayment()` | åŸ·è¡Œæ‰¹æ¬¡ä»˜æ¬¾ | `{ claimIds[], needDoc? }` | `Payment` | Finance |
| `cancelPayment()` | å–æ¶ˆä»˜æ¬¾ | `paymentId` | `Payment` | Finance |
| `revokeApproval()` | å–æ¶ˆæ ¸å‡† | `claimId` | `Claim` | Finance |

#### æ‰¹æ¬¡ä»˜æ¬¾è¦å‰‡

```typescript
// æ‰¹æ¬¡ä»˜æ¬¾é©—è­‰
function validateBatchPayment(claims: Claim[]): boolean {
  // 1. æ‰€æœ‰å–®æ“šå¿…é ˆæ˜¯ pending_payment ç‹€æ…‹
  // 2. æ‰€æœ‰å–®æ“šå¿…é ˆæ˜¯åŒä¸€ä»˜æ¬¾å°è±¡ (åŒä¸€ vendor_id æˆ–åŒä¸€ applicant_id)
  // 3. ç„¡ç­†æ•¸ä¸Šé™ã€ç„¡é‡‘é¡ä¸Šé™
}
```

---

### 7.6 è£œä»¶æ¨¡çµ„ (Document Supplement)

#### å¯«å…¥æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `submitDocument()` | æäº¤è£œä»¶ | `{ claimId, items: DocInput[] }` | `Claim` | Owner |

#### è£œä»¶è¼¸å…¥çµæ§‹

```typescript
interface DocInput {
  item_id: string;
  type: 'upload' | 'no_evidence';
  attachment?: File;              // type = 'upload' æ™‚
  no_evidence_reason?: string;    // type = 'no_evidence' æ™‚
}
```

---

### 7.7 å» å•†æ¨¡çµ„ (Vendors)

#### è®€å–æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `getVendors()` | å–å¾—å» å•†æ¸…å–® | `{ search?, status? }` | `Vendor[]` | All |
| `getVendorById()` | å–å¾—å» å•†è©³æƒ… | `vendorId` | `Vendor` | All |
| `getVendorChangeRequests()` | å–å¾—ç•°å‹•ç”³è«‹ | `{ status? }` | `VendorChangeRequest[]` | Finance |

#### å¯«å…¥æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `requestCreateVendor()` | ç”³è«‹æ–°å¢å» å•† | `VendorInput` | `VendorChangeRequest` | All |
| `requestUpdateVendor()` | ç”³è«‹ä¿®æ”¹å» å•† | `{ vendorId, ...VendorInput }` | `VendorChangeRequest` | All |
| `requestDisableVendor()` | ç”³è«‹åœç”¨å» å•† | `{ vendorId, reason }` | `VendorChangeRequest` | All |
| `approveVendorChange()` | æ ¸å‡†å» å•†ç•°å‹• | `{ requestId, comment? }` | `VendorChangeRequest` | Finance |
| `rejectVendorChange()` | é§å›å» å•†ç•°å‹• | `{ requestId, comment }` | `VendorChangeRequest` | Finance |

---

### 7.8 æ†‘è­‰æ¨¡çµ„ (Attachments)

#### æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `uploadAttachment()` | ä¸Šå‚³æ†‘è­‰ | `{ claimId, itemIndex, file }` | `{ attachment_id, url }` | Owner |
| `deleteAttachment()` | åˆªé™¤æ†‘è­‰ | `attachment_id` | - | Owner (draft) |
| `getAttachmentUrl()` | å–å¾—æ†‘è­‰ URL | `attachment_id` | `signedUrl` | Authorized |

#### æª”æ¡ˆé™åˆ¶

```typescript
const ATTACHMENT_RULES = {
  allowedTypes: ['application/pdf', 'image/jpeg', 'image/png'],
  maxSize: 10 * 1024 * 1024,  // 10MB
  path: '/claims/{claim_id}/attachments/{attachment_id}.{ext}'
};
```

---

### 7.9 è²»ç”¨é¡åˆ¥æ¨¡çµ„ (Categories)

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º | æ¬Šé™ |
|------|------|------|------|------|
| `getCategories()` | å–å¾—è²»ç”¨é¡åˆ¥ | - | `Category[]` | All |
| `createCategory()` | æ–°å¢é¡åˆ¥ | `{ name }` | `Category` | Admin |
| `updateCategory()` | æ›´æ–°é¡åˆ¥ | `{ id, name, is_active }` | `Category` | Admin |

---

### 7.10 ç™¼ç¥¨é‡è¤‡æª¢æŸ¥

#### æ“ä½œ

| æ“ä½œ | èªªæ˜ | è¼¸å…¥ | è¼¸å‡º |
|------|------|------|------|
| `checkDuplicateInvoice()` | æª¢æŸ¥ç™¼ç¥¨æ˜¯å¦é‡è¤‡ | `{ invoice_number, vendor_id? }` | `DuplicateInfo \| null` |

#### å›å‚³çµæ§‹

```typescript
interface DuplicateInfo {
  claim_id: string;
  claim_number: string;
  payee_name: string;
  amount: number;
  description: string;
}
```

---

## 8. é€šç”¨è³‡æ–™çµæ§‹ (TypeScript)

### User
```typescript
interface User {
  id: string;
  email: string;
  name: string;
  role: 'applicant' | 'manager' | 'finance' | 'admin';
  approver_id: string | null;
  approver_name: string | null;
  bank_code: string | null;
  bank_name: string | null;
  bank_branch: string | null;
  bank_account: string | null;
  created_at: string;
  updated_at: string;
}
```

### Claim
```typescript
interface Claim {
  id: string;
  claim_number: string;
  claim_type: 'employee' | 'vendor' | 'personal_service';
  status: ClaimStatus;
  applicant_id: string;
  applicant_name: string;
  vendor_id: string | null;
  vendor_name: string | null;
  total_amount: number;
  description: string;
  has_evidence: boolean;
  created_at: string;
  updated_at: string;
  submitted_at: string | null;
  completed_at: string | null;
}

type ClaimStatus = 
  | 'draft'
  | 'pending_manager'
  | 'pending_finance'
  | 'pending_payment'
  | 'paid'
  | 'paid_pending_doc'
  | 'pending_doc_review'
  | 'returned'
  | 'cancelled';
```

### Vendor
```typescript
interface Vendor {
  id: string;
  name: string;
  service_description: string | null;
  bank_code: string;
  bank_name: string | null;
  bank_account: string;
  is_floating_account: boolean;
  status: 'pending' | 'approved' | 'disabled';
  created_at: string;
  updated_at: string;
}
```

### Payment
```typescript
interface Payment {
  id: string;
  payment_number: string;
  payee_type: 'employee' | 'vendor' | 'personal';
  payee_id: string;
  payee_name: string;
  total_amount: number;
  bank_code: string;
  bank_account: string;
  status: 'completed' | 'cancelled';
  paid_by: string;
  paid_at: string;
  cancelled_at: string | null;
  claims: Claim[];  // åŒ…å«çš„è«‹æ¬¾å–®
}
```

---

## 9. éŠ€è¡Œä»£ç¢¼å°ç…§è¡¨

> ç”¨é€”ï¼šå‰ç«¯ä¸‹æ‹‰é¸å–®  
> æ ¼å¼ï¼šä»£ç¢¼ + å››å­—ç°¡ç¨±

### å…¬è‚¡éŠ€è¡Œ

| ä»£ç¢¼ | ç°¡ç¨± |
|-----|------|
| 004 | è‡ºç£éŠ€è¡Œ |
| 005 | åœŸåœ°éŠ€è¡Œ |
| 006 | åˆä½œé‡‘åº« |
| 007 | ç¬¬ä¸€éŠ€è¡Œ |
| 008 | è¯å—éŠ€è¡Œ |
| 009 | å½°åŒ–éŠ€è¡Œ |
| 011 | ä¸Šæµ·å•†éŠ€ |
| 012 | å°åŒ—å¯Œé‚¦ |
| 013 | åœ‹æ³°ä¸–è¯ |
| 016 | é«˜é›„éŠ€è¡Œ |
| 017 | å…†è±å•†éŠ€ |

### æ°‘ç‡ŸéŠ€è¡Œ

| ä»£ç¢¼ | ç°¡ç¨± |
|-----|------|
| 050 | è‡ºç£ä¼éŠ€ |
| 052 | æ¸£æ‰“å•†éŠ€ |
| 053 | å°ä¸­éŠ€è¡Œ |
| 054 | äº¬åŸéŠ€è¡Œ |
| 081 | åŒ¯è±éŠ€è¡Œ |
| 102 | è¯æ³°éŠ€è¡Œ |
| 103 | æ–°å…‰éŠ€è¡Œ |
| 108 | é™½ä¿¡éŠ€è¡Œ |
| 118 | æ¿ä¿¡éŠ€è¡Œ |
| 147 | ä¸‰ä¿¡éŠ€è¡Œ |

### å•†æ¥­éŠ€è¡Œ

| ä»£ç¢¼ | ç°¡ç¨± |
|-----|------|
| 803 | è¯é‚¦éŠ€è¡Œ |
| 805 | é æ±éŠ€è¡Œ |
| 806 | å…ƒå¤§éŠ€è¡Œ |
| 807 | æ°¸è±éŠ€è¡Œ |
| 808 | ç‰å±±éŠ€è¡Œ |
| 809 | å‡±åŸºéŠ€è¡Œ |
| 810 | æ˜Ÿå±•éŠ€è¡Œ |
| 812 | å°æ–°éŠ€è¡Œ |
| 814 | å¤§çœ¾éŠ€è¡Œ |
| 815 | æ—¥ç››éŠ€è¡Œ |
| 816 | å®‰æ³°éŠ€è¡Œ |
| 822 | ä¸­åœ‹ä¿¡è¨— |
| 823 | å°‡ä¾†éŠ€è¡Œ |
| 824 | é€£ç·šéŠ€è¡Œ |
| 826 | æ¨‚å¤©éŠ€è¡Œ |

### éƒµå±€èˆ‡è¾²æ¼æœƒ

| ä»£ç¢¼ | ç°¡ç¨± |
|-----|------|
| 700 | ä¸­è¯éƒµæ”¿ |
| 951 | è¾²é‡‘è³‡è¨Š |

---

### å‰ç«¯ä½¿ç”¨ç¯„ä¾‹ (TypeScript)

```typescript
export const BANK_LIST = [
  { code: '004', name: 'è‡ºç£éŠ€è¡Œ' },
  { code: '005', name: 'åœŸåœ°éŠ€è¡Œ' },
  { code: '006', name: 'åˆä½œé‡‘åº«' },
  { code: '007', name: 'ç¬¬ä¸€éŠ€è¡Œ' },
  { code: '008', name: 'è¯å—éŠ€è¡Œ' },
  { code: '009', name: 'å½°åŒ–éŠ€è¡Œ' },
  { code: '011', name: 'ä¸Šæµ·å•†éŠ€' },
  { code: '012', name: 'å°åŒ—å¯Œé‚¦' },
  { code: '013', name: 'åœ‹æ³°ä¸–è¯' },
  { code: '016', name: 'é«˜é›„éŠ€è¡Œ' },
  { code: '017', name: 'å…†è±å•†éŠ€' },
  { code: '050', name: 'è‡ºç£ä¼éŠ€' },
  { code: '052', name: 'æ¸£æ‰“å•†éŠ€' },
  { code: '053', name: 'å°ä¸­éŠ€è¡Œ' },
  { code: '054', name: 'äº¬åŸéŠ€è¡Œ' },
  { code: '081', name: 'åŒ¯è±éŠ€è¡Œ' },
  { code: '102', name: 'è¯æ³°éŠ€è¡Œ' },
  { code: '103', name: 'æ–°å…‰éŠ€è¡Œ' },
  { code: '108', name: 'é™½ä¿¡éŠ€è¡Œ' },
  { code: '118', name: 'æ¿ä¿¡éŠ€è¡Œ' },
  { code: '147', name: 'ä¸‰ä¿¡éŠ€è¡Œ' },
  { code: '700', name: 'ä¸­è¯éƒµæ”¿' },
  { code: '803', name: 'è¯é‚¦éŠ€è¡Œ' },
  { code: '805', name: 'é æ±éŠ€è¡Œ' },
  { code: '806', name: 'å…ƒå¤§éŠ€è¡Œ' },
  { code: '807', name: 'æ°¸è±éŠ€è¡Œ' },
  { code: '808', name: 'ç‰å±±éŠ€è¡Œ' },
  { code: '809', name: 'å‡±åŸºéŠ€è¡Œ' },
  { code: '810', name: 'æ˜Ÿå±•éŠ€è¡Œ' },
  { code: '812', name: 'å°æ–°éŠ€è¡Œ' },
  { code: '815', name: 'æ—¥ç››éŠ€è¡Œ' },
  { code: '816', name: 'å®‰æ³°éŠ€è¡Œ' },
  { code: '822', name: 'ä¸­åœ‹ä¿¡è¨—' },
  { code: '823', name: 'å°‡ä¾†éŠ€è¡Œ' },
  { code: '824', name: 'é€£ç·šéŠ€è¡Œ' },
  { code: '826', name: 'æ¨‚å¤©éŠ€è¡Œ' },
] as const;

// å–å¾—éŠ€è¡Œåç¨±
export const getBankName = (code: string) => 
  BANK_LIST.find(b => b.code === code)?.name ?? code;
```

---

## é™„éŒ„ Aï¼šå¯¦ä½œå°ç…§ (2026-02-12)

> æœ¬é™„éŒ„ç”¨æ–¼å°‡ã€Œæ–‡ä»¶è¦æ ¼åç¨±ã€èˆ‡ã€Œç›®å‰å¯¦éš›è·¯ç”± Action / RPCã€å°é½Šã€‚è‹¥èˆ‡ä¸Šæ–¹æŠ½è±¡ API å‘½åä¸åŒï¼Œä»¥æ­¤é™„éŒ„èˆ‡å¯¦éš›ç¨‹å¼ç¢¼ç‚ºæº–ã€‚

### A.1 Route Actions å°ç…§

| æ¨¡çµ„ | è·¯ç”± | Action | èªªæ˜ |
|------|------|--------|------|
| Claims | `/claims/new` | `create` | å»ºç«‹è‰ç¨¿ï¼ˆemployee/vendor/personal_serviceï¼‰ |
| Claims | `/claims/[id]` | `update` / `submit` / `withdraw` / `approve` / `reject` / `cancel` / `delete` / `togglePayFirst` | è«‹æ¬¾ç”Ÿå‘½é€±æœŸä¸»è¦å‹•ä½œ |
| Claims | `/claims/[id]` | `upload` / `delete_attachment` | æ˜ç´°é™„ä»¶ä¸Šå‚³èˆ‡åˆªé™¤ |
| Approval | `/approval` | `batchPay` | æ‰¹æ¬¡ä»˜æ¬¾ï¼ˆåƒ… finance/adminï¼‰ |
| Payments | `/payments/[id]` | `cancelPayment` | ä»˜æ¬¾æ²–å¸³ï¼ˆåƒ… finance/adminï¼‰ |
| Payees | `/payees/new` | `createPayeeRequest` | æäº¤æ–°å¢å—æ¬¾äººç”³è«‹ |
| Payees | `/payees/[id]/edit` | `updatePayeeRequest` | æäº¤æ›´æ–°å—æ¬¾äººç”³è«‹ |
| Payees | `/payees` | `submitDisableRequest` / `approvePayeeRequest` / `rejectPayeeRequest` / `withdrawRequest` | å—æ¬¾äººç•°å‹•æµç¨‹ |
| Admin | `/admin/users` | `updateUserPermissions` / `assignApprover` | ç®¡ç†å“¡è§’è‰²èˆ‡æ ¸å‡†äººç¶­è­· |
| Account | `/account` | `updateProfile` / `revealAccount` | å€‹è³‡æ›´æ–°èˆ‡åŠ å¯†å¸³è™Ÿæ­éœ² |

### A.2 æœ€æ–° migration åŒæ­¥

å·²æ–°å¢ä¸¦å¥—ç”¨ï¼š

- `20260211140049_allow_approver_read_subordinate_profiles.sql`
- `20260211151000_allow_finance_read_profiles.sql`

ç›®çš„ï¼š

- è£œé½Šä¸»ç®¡åœ¨å¯©æ ¸æµç¨‹å°ä¸‹å±¬ profile çš„è®€å–æ¬Šé™ã€‚
- è£œé½Šè²¡å‹™è§’è‰²å° profile çš„è®€å–æ¬Šé™ï¼Œé¿å…å¯©æ ¸/ä»˜æ¬¾æµç¨‹å—é™ã€‚

### A.3 ç‹€æ…‹æ©Ÿèˆ‡æ¬Šé™å¯¦ä½œå‚™è¨»

- `approve/reject` åœ¨ `/claims/[id]` æœƒä¾ç•¶å‰ç‹€æ…‹èˆ‡è§’è‰²æ±ºå®šä¸‹ä¸€æ­¥ï¼š
  - `pending_manager`ï¼šä¸»ç®¡å¯æ ¸å‡†/é§å›
  - `pending_finance`ï¼šè²¡å‹™å¯æ ¸å‡†/é§å›
  - `pending_doc_review`ï¼šè²¡å‹™å¯æ ¸å‡†/é§å›
- `batchPay` / `cancelPayment` å·²åœ¨ server action å±¤åŠ ä¸Šè§’è‰²ä¿è­·ï¼ˆfinance/adminï¼‰ã€‚
- å–æ¶ˆä»˜æ¬¾ç‚ºã€Œä»˜æ¬¾å–®å±¤ç´šã€æ“ä½œï¼Œæœƒå›æ»¾åŒä»˜æ¬¾å–®ä¸‹è«‹æ¬¾ç‹€æ…‹ï¼ˆç¬¦åˆä¸»è¦æ ¼ï¼‰ã€‚

### A.4 æ¸¬è©¦è¦†è“‹ç¾æ³ï¼ˆè³‡æ–™å±¤é—œè¯ï¼‰

- ç«¯å°ç«¯æ¸¬è©¦å·²æ¶µè“‹ claims/approval/payments/payees/RLS ä¸»æµç¨‹ã€‚
- æœ€æ–°åŸ·è¡Œçµæœï¼š`npm run test:e2e` â†’ `40 passed`ã€‚

---

> ğŸ’¡ **ä½¿ç”¨æ–¹å¼**ï¼šé–‹ç™¼æ–°åŠŸèƒ½æ™‚ï¼Œä¾ç…§æœ¬æ–‡ä»¶çš„æ¬„ä½å®šç¾©èˆ‡ API è¦æ ¼é€²è¡Œå¯¦ä½œï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ã€‚
